{"id":"agent-ops-0fl","title":"Phase 1: Data Layer","description":"Implement the foundational data layer including Zod models, Drizzle ORM schema, and repository pattern for data access.","status":"closed","priority":0,"issue_type":"epic","created_at":"2025-12-20T22:43:44.995199-06:00","updated_at":"2025-12-21T13:06:25.056901-06:00","closed_at":"2025-12-21T13:06:25.056901-06:00","close_reason":"Closed","labels":["backend","foundation"]}
{"id":"agent-ops-0fl.1","title":"Implement WorkItem Zod model","description":"Create src/models/work-item.ts with WorkItemType, WorkItemStatus, Transition, SuccessCriterion, and WorkItem Zod schemas as specified in design doc.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T22:44:31.844652-06:00","updated_at":"2025-12-21T13:06:04.38415-06:00","closed_at":"2025-12-21T13:06:04.38415-06:00","close_reason":"Closed","labels":["backend","models"],"dependencies":[{"issue_id":"agent-ops-0fl.1","depends_on_id":"agent-ops-0fl","type":"parent-child","created_at":"2025-12-20T22:44:31.847385-06:00","created_by":"daemon"}]}
{"id":"agent-ops-0fl.2","title":"Implement AgentTemplate Zod model","description":"Create src/models/template.ts with AgentRole, PermissionMode, MCPServerConfig, and AgentTemplate Zod schemas as specified in design doc.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T22:44:32.939365-06:00","updated_at":"2025-12-21T13:06:04.650032-06:00","closed_at":"2025-12-21T13:06:04.650032-06:00","close_reason":"Closed","labels":["backend","models"],"dependencies":[{"issue_id":"agent-ops-0fl.2","depends_on_id":"agent-ops-0fl","type":"parent-child","created_at":"2025-12-20T22:44:32.943105-06:00","created_by":"daemon"}]}
{"id":"agent-ops-0fl.3","title":"Implement AgentWorker Zod model","description":"Create src/models/worker.ts with WorkerStatus, AgentWorker schemas and WorkerPool interface as specified in design doc.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T22:44:34.577329-06:00","updated_at":"2025-12-21T13:06:04.902113-06:00","closed_at":"2025-12-21T13:06:04.902113-06:00","close_reason":"Closed","labels":["backend","models"],"dependencies":[{"issue_id":"agent-ops-0fl.3","depends_on_id":"agent-ops-0fl","type":"parent-child","created_at":"2025-12-20T22:44:34.58005-06:00","created_by":"daemon"}]}
{"id":"agent-ops-0fl.4","title":"Implement Trace model","description":"Create src/models/trace.ts with schema for observability events including tool calls, state changes, and metrics.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T22:44:36.612065-06:00","updated_at":"2025-12-21T13:06:15.24823-06:00","closed_at":"2025-12-21T13:06:15.24823-06:00","close_reason":"Closed","labels":["backend","models"],"dependencies":[{"issue_id":"agent-ops-0fl.4","depends_on_id":"agent-ops-0fl","type":"parent-child","created_at":"2025-12-20T22:44:36.614698-06:00","created_by":"daemon"}]}
{"id":"agent-ops-0fl.5","title":"Setup Drizzle ORM schema","description":"Create src/db/schema.ts with Drizzle table definitions for work_items, templates, workers, and traces. Configure SQLite with better-sqlite3.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-20T22:44:37.591417-06:00","updated_at":"2025-12-20T22:58:56.366139-06:00","closed_at":"2025-12-20T22:58:56.366139-06:00","close_reason":"Closed","labels":["backend","database"],"dependencies":[{"issue_id":"agent-ops-0fl.5","depends_on_id":"agent-ops-0fl","type":"parent-child","created_at":"2025-12-20T22:44:37.593846-06:00","created_by":"daemon"}]}
{"id":"agent-ops-0fl.6","title":"Create database migrations","description":"Setup Drizzle migrations in src/db/migrations/ with initial schema migration.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T22:44:38.812214-06:00","updated_at":"2025-12-21T13:06:15.491097-06:00","closed_at":"2025-12-21T13:06:15.491097-06:00","close_reason":"Closed","labels":["backend","database"],"dependencies":[{"issue_id":"agent-ops-0fl.6","depends_on_id":"agent-ops-0fl","type":"parent-child","created_at":"2025-12-20T22:44:38.815641-06:00","created_by":"daemon"}]}
{"id":"agent-ops-0fl.7","title":"Implement WorkItem repository","description":"Create src/repositories/work-item.repository.ts with CRUD operations and query methods for work items.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T22:44:40.054139-06:00","updated_at":"2025-12-21T13:06:15.71092-06:00","closed_at":"2025-12-21T13:06:15.71092-06:00","close_reason":"Closed","labels":["backend","repository"],"dependencies":[{"issue_id":"agent-ops-0fl.7","depends_on_id":"agent-ops-0fl","type":"parent-child","created_at":"2025-12-20T22:44:40.056984-06:00","created_by":"daemon"}]}
{"id":"agent-ops-0fl.8","title":"Implement Template repository","description":"Create src/repositories/template.repository.ts with CRUD operations for agent templates.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T22:44:41.374567-06:00","updated_at":"2025-12-21T13:06:24.605731-06:00","closed_at":"2025-12-21T13:06:24.605731-06:00","close_reason":"Closed","labels":["backend","repository"],"dependencies":[{"issue_id":"agent-ops-0fl.8","depends_on_id":"agent-ops-0fl","type":"parent-child","created_at":"2025-12-20T22:44:41.378819-06:00","created_by":"daemon"}]}
{"id":"agent-ops-0fl.9","title":"Implement Worker repository","description":"Create src/repositories/worker.repository.ts with CRUD operations for agent workers.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T22:44:42.468284-06:00","updated_at":"2025-12-21T13:06:24.833897-06:00","closed_at":"2025-12-21T13:06:24.833897-06:00","close_reason":"Closed","labels":["backend","repository"],"dependencies":[{"issue_id":"agent-ops-0fl.9","depends_on_id":"agent-ops-0fl","type":"parent-child","created_at":"2025-12-20T22:44:42.472686-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4ka","title":"Local Agent Dashboard MVP","description":"Build a local web dashboard to orchestrate Claude agents in Docker containers on Mac.\n\n**MVP Scope:**\n- Run Claude agents in Docker containers (ARM64)\n- Web dashboard showing active agents\n- Real-time log streaming (SSE)\n- Terminal view per agent (xterm.js)\n- Start/stop agent controls\n- Works with existing bd workflow\n\n**Out of Scope (for now):**\n- Cloud deployment\n- Multi-tenant/auth\n- gVisor/Firecracker (Docker is fine locally)\n- Multiple repos (start with current repo)\n\n**Target:** Mac M3 Pro, macOS, Docker Desktop","design":"# Implementation Plan: Local Agent Dashboard MVP with Docker Container Orchestration\n\n## Overview\n\nBuild a local web dashboard to orchestrate Claude agents running in Docker containers on Mac M3 Pro (ARM64). This plan implements real-time visibility into agent execution via SSE log streaming, WebSocket terminal access, and container lifecycle management, integrating seamlessly with the existing agent-ops codebase.\n\n## FACTS Validation Summary\n\n- **Feasibility**: All tasks use proven technologies (Dockerode, better-sse, xterm.js) with Node.js 20+ support. Mac ARM64 compatibility confirmed. Docker Desktop socket access is standard.\n- **Atomicity**: Each task represents a single testable unit of work (one test file, one method, one component). Tasks are ordered to allow immediate verification.\n- **Clarity**: Tasks include specific file paths, method signatures, and test case descriptions. Developers can proceed without ambiguity.\n- **Testability**: TDD approach with Red-Green-Refactor cycle. Every implementation task is preceded by a test task. Integration and E2E tests included.\n- **Scope**: Four phases with clear milestones. Each phase represents a committable state with working functionality.\n\n## Prerequisites\n\n### Dependencies to Install\n\n**Backend** (run in `/Users/probinson/Repos/on-par/saas/agent-ops/backend`):\n```bash\nnpm install dockerode better-sse ws\nnpm install -D @types/dockerode @types/ws\n```\n\n**Frontend** (run in `/Users/probinson/Repos/on-par/saas/agent-ops/frontend`):\n```bash\nnpm install @xterm/xterm @xterm/addon-attach @xterm/addon-fit\n```\n\nNote: TanStack Query (`@tanstack/react-query@5.90.12`) is already installed in the frontend.\n\n### Environment Setup\n\n1. Docker Desktop must be installed and running on macOS\n2. Verify Docker socket is accessible: `ls -la /var/run/docker.sock`\n3. Ensure sufficient disk space for container images (~2GB recommended)\n\n### Blocking Issues\n\nNone identified. All dependencies are publicly available and compatible with the existing stack.\n\n---\n\n## Phase 1: Database \u0026 Core Services (Foundation)\n\n**Goal**: Establish the data layer and container management service with full test coverage.\n\n**Committable State**: Database schema extended with containers table, ContainerRepository functional, ContainerManagerService passing all unit tests with mocked Dockerode.\n\n### Tasks\n\n- [ ] **1.1** Add container status enum and containers table to `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/shared/db/schema.ts`\n  - Add `containerStatuses` const array: `['creating', 'running', 'stopped', 'error', 'removing']`\n  - Add `ContainerStatus` type\n  - Add `containers` sqliteTable with fields: `id`, `containerId`, `workspaceId`, `workerId`, `executionId`, `image`, `status`, `name`, `createdAt`, `startedAt`, `stoppedAt`\n  - Add type exports: `Container`, `NewContainer`\n\n- [ ] **1.2** Run database migration to create containers table\n  - Execute `npm run db:generate` followed by `npm run db:push`\n  - Verify table creation with `npm run db:studio`\n\n- [ ] [P] **1.3** Create container repository directory structure\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/containers/` directory\n  - Create subdirectories: `repositories/`, `services/`, `handler/`, `tests/`\n\n- [ ] **1.4** Write test: ContainerRepository CRUD operations (expect fail)\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/containers/tests/container.repository.test.ts`\n  - Test cases:\n    - `create()` inserts container record and returns it\n    - `findById()` returns container or null\n    - `findByWorkspaceId()` returns array of containers\n    - `findByStatus()` filters by status correctly\n    - `updateStatus()` updates status and sets appropriate timestamps\n    - `delete()` removes container record\n\n- [ ] **1.5** Implement ContainerRepository (expect pass)\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/containers/repositories/container.repository.ts`\n  - Follow pattern from `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/agent-runtime/repositories/agent-execution.repository.ts`\n  - Methods: `create()`, `findById()`, `findByWorkspaceId()`, `findByWorkerId()`, `findByStatus()`, `updateStatus()`, `update()`, `delete()`\n\n- [ ] **1.6** Write test: ContainerManagerService container lifecycle (expect fail)\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/containers/tests/container-manager.service.test.ts`\n  - Mock Dockerode with vitest\n  - Test cases:\n    - `createContainer()` creates Docker container with correct config (image, mounts, env, resource limits)\n    - `createContainer()` saves container record to database\n    - `startContainer()` starts Docker container and updates status to 'running'\n    - `stopContainer()` stops Docker container gracefully and updates status\n    - `removeContainer()` removes Docker container and deletes database record\n    - `getContainerLogs()` returns readable stream from container\n    - `execInContainer()` executes command and returns stream for PTY\n    - Error handling: `createContainer()` with invalid image throws descriptive error\n    - Error handling: `startContainer()` with non-existent container throws error\n\n- [ ] **1.7** Implement ContainerManagerService (expect pass)\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/containers/services/container-manager.service.ts`\n  - Constructor accepts: `db: DrizzleDatabase`, `dockerClient?: Docker` (for injection/mocking)\n  - Methods:\n    - `createContainer(config: ContainerConfig): Promise\u003cContainer\u003e`\n    - `startContainer(containerId: string): Promise\u003cvoid\u003e`\n    - `stopContainer(containerId: string, timeout?: number): Promise\u003cvoid\u003e`\n    - `removeContainer(containerId: string): Promise\u003cvoid\u003e`\n    - `getContainerLogs(containerId: string, options?: LogOptions): Promise\u003cNodeJS.ReadableStream\u003e`\n    - `execInContainer(containerId: string, cmd: string[]): Promise\u003cExecStream\u003e`\n    - `getContainerStatus(containerId: string): Promise\u003cContainerStatus\u003e`\n  - Default Docker client connects to `/var/run/docker.sock`\n\n- [ ] **1.8** Write test: ContainerManagerService resource limits (expect fail)\n  - Add test cases to existing test file:\n    - `createContainer()` applies memory limit correctly\n    - `createContainer()` applies CPU limit correctly\n    - `createContainer()` mounts workspace volume at correct path\n\n- [ ] **1.9** Implement resource limit configuration (expect pass)\n  - Extend `ContainerConfig` interface with:\n    - `memoryLimit: number` (bytes, default 512MB)\n    - `cpuLimit: number` (NanoCPUs, default 1 core)\n    - `workspacePath: string`\n    - `workspaceMount: string` (default `/workspace`)\n  - Update `createContainer()` to set `HostConfig.Memory`, `HostConfig.NanoCpus`, `HostConfig.Binds`\n\n- [ ] **1.10** Refactor: Extract Docker configuration to config file\n  - Add to `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/shared/config.ts`:\n    - `dockerSocketPath: string` (default `/var/run/docker.sock`)\n    - `dockerAgentImage: string` (default `agent-ops/agent:latest`)\n    - `containerMemoryLimit: number` (default 512MB)\n    - `containerCpuLimit: number` (default 1 CPU)\n  - Update ContainerManagerService to use config\n\n---\n\n## Phase 2: API Layer (Backend Integration)\n\n**Goal**: Expose container management via REST API with SSE log streaming and WebSocket terminal access.\n\n**Committable State**: Full REST API for container CRUD, SSE endpoint streaming container logs, WebSocket endpoint providing terminal access. All endpoints tested with integration tests.\n\n### Tasks\n\n- [ ] **2.1** Write test: Container handler REST endpoints (expect fail)\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/containers/tests/container.handler.test.ts`\n  - Use Fastify inject for HTTP testing\n  - Test cases:\n    - `POST /api/containers` creates container with valid config, returns 201\n    - `POST /api/containers` with invalid config returns 400 with Zod errors\n    - `GET /api/containers` returns array of containers\n    - `GET /api/containers?status=running` filters by status\n    - `GET /api/containers/:id` returns container or 404\n    - `POST /api/containers/:id/start` starts container, returns 200\n    - `POST /api/containers/:id/start` on running container returns 409\n    - `POST /api/containers/:id/stop` stops container, returns 200\n    - `DELETE /api/containers/:id` removes container, returns 200\n    - `DELETE /api/containers/:id` on non-existent returns 404\n\n- [ ] **2.2** Implement Container handler REST endpoints (expect pass)\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/containers/handler/container.handler.ts`\n  - Follow pattern from `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/agent-runtime/handler/agent-runtime.handler.ts`\n  - Create Zod schemas for request validation:\n    - `CreateContainerSchema`: name, image, workspaceId, memoryLimit?, cpuLimit?\n  - Implement routes:\n    - `POST /` - Create container\n    - `GET /` - List containers (optional status filter)\n    - `GET /:id` - Get container details\n    - `POST /:id/start` - Start container\n    - `POST /:id/stop` - Stop container\n    - `DELETE /:id` - Remove container\n\n- [ ] **2.3** Register container routes in app\n  - Update `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/app.ts`\n  - Import `containerHandler` from containers feature\n  - Register with prefix `/api/containers`\n\n- [ ] **2.4** Write test: SSE log streaming endpoint (expect fail)\n  - Add test cases to container.handler.test.ts:\n    - `GET /api/containers/:id/logs` returns SSE stream with correct headers\n    - `GET /api/containers/:id/logs` streams stdout and stderr events\n    - `GET /api/containers/:id/logs?follow=true` keeps connection open\n    - `GET /api/containers/:id/logs` on non-existent container returns 404\n\n- [ ] **2.5** Implement SSE log streaming endpoint (expect pass)\n  - Add to container.handler.ts:\n    - `GET /:id/logs` - SSE endpoint using better-sse\n  - Use `createSession()` from better-sse\n  - Get log stream from ContainerManagerService.getContainerLogs()\n  - Demux stdout/stderr using Dockerode modem.demuxStream\n  - Broadcast events with type 'stdout' or 'stderr'\n  - Handle client disconnect gracefully\n\n- [ ] **2.6** Write test: WebSocket terminal endpoint (expect fail)\n  - Add test file: `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/containers/tests/container-terminal.test.ts`\n  - Test cases:\n    - WebSocket connection to `/api/containers/:id/terminal` succeeds\n    - Terminal data from container is sent to client\n    - Client input is sent to container\n    - Connection closes when container stops\n    - Invalid container ID closes connection with error\n\n- [ ] **2.7** Implement WebSocket terminal endpoint (expect pass)\n  - Add WebSocket route to container.handler.ts:\n    - `GET /:id/terminal` - WebSocket endpoint\n  - Use @fastify/websocket (already installed)\n  - On connection:\n    - Create exec session with PTY (Tty: true, AttachStdin/Stdout/Stderr: true)\n    - Start exec with hijack mode\n    - Pipe WebSocket messages to exec stream\n    - Pipe exec stream output to WebSocket\n  - Handle disconnection cleanup\n\n- [ ] **2.8** Write test: Agent executor containerized execution (expect fail)\n  - Update `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/agent-runtime/tests/agent-executor.service.test.ts`\n  - Add test cases:\n    - `execute()` with `containerized: true` creates container with workspace\n    - `execute()` with `containerized: true` starts container and runs agent inside\n    - `execute()` with `containerized: true` collects output from container\n    - `execute()` with `containerized: true` cleans up container on success\n    - `execute()` with `containerized: true` cleans up container on error\n    - `execute()` without `containerized` flag uses existing in-process execution (backward compatible)\n\n- [ ] **2.9** Implement containerized execution in AgentExecutorService (expect pass)\n  - Update `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/agent-runtime/services/agent-executor.service.ts`\n  - Add optional `containerized?: boolean` to ExecutionContext\n  - Inject ContainerManagerService dependency\n  - When containerized=true:\n    1. Create container with workspace mounted\n    2. Start container\n    3. Execute agent via docker exec (run CLI inside container)\n    4. Stream output back\n    5. Stop and remove container on completion\n\n- [ ] **2.10** Write integration test: Full container lifecycle (expect fail)\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/containers/tests/container.integration.test.ts`\n  - Requires real Docker (skip if Docker not available)\n  - Test cases:\n    - Create → Start → Get logs → Stop → Remove workflow succeeds\n    - Container status updates reflect actual Docker state\n    - Workspace files are accessible from within container\n\n- [ ] **2.11** Implement integration test fixes (expect pass)\n  - Fix any issues discovered in integration testing\n  - Ensure proper cleanup on test failure\n\n---\n\n## Phase 3: Frontend Integration (UI Components)\n\n**Goal**: Build React components for container visualization with real-time updates.\n\n**Committable State**: Dashboard displays active containers in cards, logs stream in real-time via SSE, terminal provides interactive access. Components integrated with existing navigation.\n\n### Tasks\n\n- [ ] [P] **3.1** Create container API hooks with TanStack Query\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/hooks/use-containers.ts`\n  - Hooks:\n    - `useContainers(status?: ContainerStatus)` - List containers with optional filter, poll every 5s\n    - `useContainer(id: string)` - Single container details\n    - `useCreateContainer()` - Mutation hook\n    - `useStartContainer()` - Mutation hook\n    - `useStopContainer()` - Mutation hook\n    - `useRemoveContainer()` - Mutation hook\n  - Each mutation invalidates `['containers']` query on success\n\n- [ ] [P] **3.2** Create container types\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/types/container.ts`\n  - Define TypeScript interfaces matching backend schema:\n    - `Container`\n    - `ContainerStatus`\n    - `CreateContainerRequest`\n    - `ContainerLogEvent`\n\n- [ ] **3.3** Create ContainerCard component\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/containers/ContainerCard.tsx`\n  - Props: `container: Container`, `onStart`, `onStop`, `onRemove`, `onViewLogs`, `onOpenTerminal`\n  - Display: name, status badge (color-coded), image, created time, action buttons\n  - Use existing styling patterns from Dashboard.tsx (card-hover, badges, etc.)\n\n- [ ] **3.4** Create ContainerLogs component with SSE\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/containers/ContainerLogs.tsx`\n  - Props: `containerId: string`, `onClose: () =\u003e void`\n  - Use native EventSource API to connect to `/api/containers/:id/logs`\n  - Maintain log buffer (last 1000 lines) with auto-scroll\n  - Color-code stderr lines differently\n  - Include clear button and close button\n  - Handle reconnection on disconnect\n\n- [ ] **3.5** Install xterm.js CSS\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/styles/xterm.css`\n  - Import xterm base styles from `@xterm/xterm/css/xterm.css`\n  - Add custom styling for container terminal (background, font, etc.)\n\n- [ ] **3.6** Create ContainerTerminal component with xterm.js\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/containers/ContainerTerminal.tsx`\n  - Props: `containerId: string`, `onClose: () =\u003e void`\n  - Initialize xterm Terminal with:\n    - cursorBlink: true\n    - fontSize: 14\n    - fontFamily: 'Menlo, Monaco, \"Courier New\", monospace'\n    - theme matching dashboard dark theme\n  - Load FitAddon for responsive sizing\n  - Connect via WebSocket to `/api/containers/:id/terminal`\n  - Use AttachAddon to pipe WebSocket to terminal\n  - Handle resize events with fitAddon.fit()\n  - Cleanup on unmount\n\n- [ ] **3.7** Create ContainerList component\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/containers/ContainerList.tsx`\n  - Props: `containers: Container[]`, callbacks for actions\n  - Grid layout matching ActiveAgentsGrid pattern\n  - Empty state when no containers\n  - Loading skeleton while fetching\n\n- [ ] **3.8** Create Containers page\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/pages/Containers.tsx`\n  - Layout:\n    - Header with title \"Agent Containers\" and \"New Container\" button\n    - Status filter tabs: All, Running, Stopped, Error\n    - ContainerList component\n    - Modal/slide-over for logs view\n    - Modal/slide-over for terminal view\n  - Use useContainers hook for data\n  - Handle create, start, stop, remove actions\n\n- [ ] **3.9** Add Containers route to App\n  - Update `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/App.tsx`\n  - Add route: `\u003cRoute path=\"/containers\" element={\u003cContainers /\u003e} /\u003e`\n\n- [ ] **3.10** Add Containers link to navigation\n  - Update `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/Layout.tsx`\n  - Add navigation item for Containers page with appropriate icon (e.g., Box from lucide-react)\n\n- [ ] **3.11** Write frontend tests: Container components\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/containers/__tests__/ContainerCard.test.tsx`\n  - Test cases:\n    - Renders container name and status\n    - Calls onStart when start button clicked\n    - Calls onStop when stop button clicked\n    - Disables start button when container is running\n\n- [ ] **3.12** Write frontend tests: SSE log streaming\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/containers/__tests__/ContainerLogs.test.tsx`\n  - Mock EventSource\n  - Test cases:\n    - Connects to correct SSE endpoint\n    - Appends stdout messages to log buffer\n    - Appends stderr messages with error styling\n    - Closes EventSource on unmount\n\n---\n\n## Phase 4: Docker \u0026 Deployment (Containerization)\n\n**Goal**: Create production-ready Docker images for all components and orchestration via docker-compose.\n\n**Committable State**: Running `docker-compose up` starts the complete system - backend, frontend, and can spawn agent containers. Documentation complete for local deployment.\n\n### Tasks\n\n- [ ] **4.1** Create agent runtime Dockerfile\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/backend/Dockerfile.agent`\n  - Base: `node:20-slim`\n  - Install: git, curl (for health checks)\n  - Copy backend source and build\n  - Set working directory to /workspace\n  - Entry point: node dist/cli.js\n  - Health check: node -e \"process.exit(0)\"\n  - Labels for identification\n\n- [ ] **4.2** Create backend server Dockerfile\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/backend/Dockerfile`\n  - Multi-stage build:\n    - Stage 1: Build TypeScript\n    - Stage 2: Production runtime with only dist/ and node_modules\n  - Base: `node:20-slim`\n  - Expose port 3001\n  - Health check endpoint: /health\n  - Non-root user for security\n\n- [ ] **4.3** Create frontend Dockerfile\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/Dockerfile`\n  - Multi-stage build:\n    - Stage 1: Build Vite production bundle\n    - Stage 2: nginx:alpine serving static files\n  - Configure nginx for SPA routing (fallback to index.html)\n  - Expose port 80\n\n- [ ] **4.4** Create nginx configuration for frontend\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/nginx.conf`\n  - SPA fallback configuration\n  - Proxy /api requests to backend (optional, if same-origin needed)\n  - Gzip compression\n  - Cache headers for static assets\n\n- [ ] **4.5** Create docker-compose.yml\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/docker-compose.yml`\n  - Services:\n    - `backend`: Build from backend/Dockerfile, mount docker.sock, volume for database\n    - `frontend`: Build from frontend/Dockerfile, depends_on backend\n  - Networks: custom bridge network\n  - Volumes: sqlite data persistence\n  - Environment variables from .env file\n  - Port mappings: frontend:3000, backend:3001\n\n- [ ] **4.6** Create .env.example for Docker deployment\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/.env.example`\n  - Document all environment variables:\n    - PORT, HOST\n    - DATABASE_URL\n    - LLM_PROVIDER, LLM_MODEL, LLM_BASE_URL\n    - DOCKER_AGENT_IMAGE, DOCKER_SOCKET\n    - ANTHROPIC_API_KEY (optional)\n\n- [ ] **4.7** Create docker-compose.dev.yml for development\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/docker-compose.dev.yml`\n  - Extends base docker-compose.yml\n  - Add volume mounts for source code (hot reload)\n  - Add development-specific environment variables\n  - Include commented-out service for local Ollama\n\n- [ ] **4.8** Write E2E test: Full container workflow\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/e2e/container-workflow.test.ts`\n  - Requires Docker (skip if not available)\n  - Test scenario:\n    1. Start backend and frontend via docker-compose\n    2. Create container via API\n    3. Start container\n    4. Connect to SSE logs, verify streaming works\n    5. Connect to WebSocket terminal, send command, verify output\n    6. Stop container\n    7. Remove container\n    8. Verify cleanup\n\n- [ ] **4.9** Build and verify agent image\n  - Run: `docker build -f backend/Dockerfile.agent -t agent-ops/agent:latest .`\n  - Test: `docker run --rm agent-ops/agent:latest node dist/cli.js --help`\n  - Verify ARM64 compatibility on Mac M3\n\n- [ ] **4.10** Create deployment documentation\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/docs/local-deployment.md`\n  - Sections:\n    - Prerequisites (Docker Desktop, Node.js)\n    - Quick start (docker-compose up)\n    - Configuration options\n    - Troubleshooting common issues\n    - Architecture diagram\n    - Security considerations\n\n- [ ] **4.11** Update project README with container features\n  - Update `/Users/probinson/Repos/on-par/saas/agent-ops/README.md`\n  - Add section on Docker container orchestration\n  - Link to detailed deployment docs\n  - Update feature list\n\n---\n\n## Validation Checklist\n\nAfter completing all phases, verify:\n\n- [ ] All unit tests passing: `cd backend \u0026\u0026 npm test`\n- [ ] All frontend tests passing: `cd frontend \u0026\u0026 npm test`\n- [ ] Integration tests passing with real Docker\n- [ ] E2E test passing with docker-compose\n- [ ] `docker-compose up` starts the complete system without errors\n- [ ] Dashboard displays running containers\n- [ ] Log streaming works in browser (SSE connection established, logs appear)\n- [ ] Terminal works in browser (WebSocket connected, can type commands)\n- [ ] Container start/stop/remove operations work from UI\n- [ ] bd workflow still works (existing functionality not broken)\n- [ ] CLI runner still works (existing functionality not broken)\n- [ ] Documentation complete and accurate\n\n---\n\n## Appendix: Code Examples\n\n### A. Container Repository Pattern\n\nReference: `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/agent-runtime/repositories/agent-execution.repository.ts`\n\n```typescript\n// Pattern for container.repository.ts\nimport { eq } from \"drizzle-orm\";\nimport type { DrizzleDatabase } from \"../../../shared/db/index.js\";\nimport {\n  containers,\n  type Container,\n  type NewContainer,\n  type ContainerStatus,\n} from \"../../../shared/db/schema.js\";\n\nexport class ContainerRepository {\n  constructor(private db: DrizzleDatabase) {}\n\n  async create(container: NewContainer): Promise\u003cContainer\u003e {\n    const [created] = await this.db\n      .insert(containers)\n      .values(container)\n      .returning();\n    if (!created) throw new Error(\"Failed to create container\");\n    return created;\n  }\n\n  async findById(id: string): Promise\u003cContainer | null\u003e {\n    const [container] = await this.db\n      .select()\n      .from(containers)\n      .where(eq(containers.id, id))\n      .limit(1);\n    return container || null;\n  }\n\n  async updateStatus(id: string, status: ContainerStatus): Promise\u003cContainer\u003e {\n    const updates: Partial\u003cContainer\u003e = { status };\n    if (status === \"running\") updates.startedAt = new Date();\n    if (status === \"stopped\") updates.stoppedAt = new Date();\n    \n    const [updated] = await this.db\n      .update(containers)\n      .set(updates)\n      .where(eq(containers.id, id))\n      .returning();\n    if (!updated) throw new Error(`Container ${id} not found`);\n    return updated;\n  }\n}\n```\n\n### B. Dockerode Usage Pattern\n\n```typescript\n// Pattern for container-manager.service.ts\nimport Docker from \"dockerode\";\n\nexport class ContainerManagerService {\n  private docker: Docker;\n  private repository: ContainerRepository;\n\n  constructor(db: DrizzleDatabase, dockerClient?: Docker) {\n    this.repository = new ContainerRepository(db);\n    this.docker = dockerClient ?? new Docker({ socketPath: \"/var/run/docker.sock\" });\n  }\n\n  async createContainer(config: ContainerConfig): Promise\u003cContainer\u003e {\n    const dockerContainer = await this.docker.createContainer({\n      Image: config.image,\n      name: config.name,\n      Env: config.env,\n      HostConfig: {\n        Memory: config.memoryLimit ?? 512 * 1024 * 1024,\n        NanoCpus: config.cpuLimit ?? 1_000_000_000,\n        Binds: [`${config.workspacePath}:${config.workspaceMount}:rw`],\n      },\n    });\n\n    return await this.repository.create({\n      id: uuidv4(),\n      containerId: dockerContainer.id,\n      workspaceId: config.workspaceId,\n      image: config.image,\n      name: config.name,\n      status: \"creating\",\n      createdAt: new Date(),\n    });\n  }\n\n  async getContainerLogs(containerId: string): Promise\u003cNodeJS.ReadableStream\u003e {\n    const record = await this.repository.findById(containerId);\n    if (!record) throw new Error(`Container ${containerId} not found`);\n    \n    const container = this.docker.getContainer(record.containerId);\n    return await container.logs({\n      follow: true,\n      stdout: true,\n      stderr: true,\n      timestamps: true,\n    });\n  }\n}\n```\n\n### C. SSE Endpoint Pattern\n\nReference: better-sse documentation\n\n```typescript\n// Pattern for container log SSE endpoint\nimport { createSession } from \"better-sse\";\n\napp.get(\"/:id/logs\", async (request, reply) =\u003e {\n  const { id } = request.params as { id: string };\n  \n  const container = await containerManager.getContainerById(id);\n  if (!container) {\n    reply.status(404).send({ error: \"Container not found\" });\n    return;\n  }\n\n  // Create SSE session\n  const session = await createSession(request.raw, reply.raw);\n  \n  // Get log stream\n  const logStream = await containerManager.getContainerLogs(id);\n  \n  // Demux and broadcast\n  const docker = new Docker();\n  docker.modem.demuxStream(\n    logStream,\n    {\n      write: (chunk: Buffer) =\u003e {\n        session.push(chunk.toString().trim(), \"stdout\");\n      },\n    },\n    {\n      write: (chunk: Buffer) =\u003e {\n        session.push(chunk.toString().trim(), \"stderr\");\n      },\n    }\n  );\n\n  // Cleanup on disconnect\n  request.raw.on(\"close\", () =\u003e {\n    logStream.destroy();\n  });\n});\n```\n\n### D. TanStack Query Hook Pattern\n\nReference: Existing usage in codebase\n\n```typescript\n// Pattern for use-containers.ts\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { API_BASE } from \"../lib/api\";\nimport type { Container, ContainerStatus } from \"../types/container\";\n\nexport function useContainers(status?: ContainerStatus) {\n  return useQuery({\n    queryKey: [\"containers\", status],\n    queryFn: async () =\u003e {\n      const url = status\n        ? `${API_BASE}/api/containers?status=${status}`\n        : `${API_BASE}/api/containers`;\n      const response = await fetch(url);\n      if (!response.ok) throw new Error(\"Failed to fetch containers\");\n      return response.json() as Promise\u003cContainer[]\u003e;\n    },\n    refetchInterval: 5000,\n  });\n}\n\nexport function useStartContainer() {\n  const queryClient = useQueryClient();\n  \n  return useMutation({\n    mutationFn: async (containerId: string) =\u003e {\n      const response = await fetch(\n        `${API_BASE}/api/containers/${containerId}/start`,\n        { method: \"POST\" }\n      );\n      if (!response.ok) throw new Error(\"Failed to start container\");\n      return response.json();\n    },\n    onSuccess: () =\u003e {\n      queryClient.invalidateQueries({ queryKey: [\"containers\"] });\n    },\n  });\n}\n```\n\n### E. xterm.js Integration Pattern\n\nReference: xterm.js documentation\n\n```typescript\n// Pattern for ContainerTerminal.tsx\nimport { useEffect, useRef } from \"react\";\nimport { Terminal } from \"@xterm/xterm\";\nimport { AttachAddon } from \"@xterm/addon-attach\";\nimport { FitAddon } from \"@xterm/addon-fit\";\nimport \"@xterm/xterm/css/xterm.css\";\n\ninterface ContainerTerminalProps {\n  containerId: string;\n  onClose: () =\u003e void;\n}\n\nexport function ContainerTerminal({ containerId, onClose }: ContainerTerminalProps) {\n  const terminalRef = useRef\u003cHTMLDivElement\u003e(null);\n  const termRef = useRef\u003cTerminal | null\u003e(null);\n  const wsRef = useRef\u003cWebSocket | null\u003e(null);\n\n  useEffect(() =\u003e {\n    if (!terminalRef.current) return;\n\n    // Create terminal\n    const terminal = new Terminal({\n      cursorBlink: true,\n      fontSize: 14,\n      fontFamily: 'Menlo, Monaco, \"Courier New\", monospace',\n      theme: {\n        background: \"#0a0a0f\",\n        foreground: \"#e4e4e7\",\n        cursor: \"#22d3ee\",\n      },\n    });\n\n    const fitAddon = new FitAddon();\n    terminal.loadAddon(fitAddon);\n    terminal.open(terminalRef.current);\n    fitAddon.fit();\n\n    // Connect WebSocket\n    const wsUrl = `ws://localhost:3001/api/containers/${containerId}/terminal`;\n    const ws = new WebSocket(wsUrl);\n    const attachAddon = new AttachAddon(ws);\n    terminal.loadAddon(attachAddon);\n\n    termRef.current = terminal;\n    wsRef.current = ws;\n\n    // Handle resize\n    const handleResize = () =\u003e fitAddon.fit();\n    window.addEventListener(\"resize\", handleResize);\n\n    return () =\u003e {\n      window.removeEventListener(\"resize\", handleResize);\n      ws.close();\n      terminal.dispose();\n    };\n  }, [containerId]);\n\n  return (\n    \u003cdiv className=\"flex flex-col h-full\"\u003e\n      \u003cdiv className=\"flex justify-between items-center p-2 bg-[var(--bg-card)]\"\u003e\n        \u003cspan className=\"text-sm font-medium\"\u003eTerminal\u003c/span\u003e\n        \u003cbutton onClick={onClose} className=\"text-[var(--text-muted)] hover:text-white\"\u003e\n          Close\n        \u003c/button\u003e\n      \u003c/div\u003e\n      \u003cdiv ref={terminalRef} className=\"flex-1\" /\u003e\n    \u003c/div\u003e\n  );\n}\n```\n\n---\n\n## File Reference Summary\n\n### New Files to Create\n\n**Backend:**\n- `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/containers/repositories/container.repository.ts`\n- `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/containers/services/container-manager.service.ts`\n- `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/containers/handler/container.handler.ts`\n- `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/containers/tests/container.repository.test.ts`\n- `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/containers/tests/container-manager.service.test.ts`\n- `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/containers/tests/container.handler.test.ts`\n- `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/containers/tests/container-terminal.test.ts`\n- `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/containers/tests/container.integration.test.ts`\n- `/Users/probinson/Repos/on-par/saas/agent-ops/backend/Dockerfile`\n- `/Users/probinson/Repos/on-par/saas/agent-ops/backend/Dockerfile.agent`\n\n**Frontend:**\n- `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/hooks/use-containers.ts`\n- `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/types/container.ts`\n- `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/containers/ContainerCard.tsx`\n- `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/containers/ContainerLogs.tsx`\n- `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/containers/ContainerTerminal.tsx`\n- `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/containers/ContainerList.tsx`\n- `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/pages/Containers.tsx`\n- `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/styles/xterm.css`\n- `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/Dockerfile`\n- `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/nginx.conf`\n\n**Root:**\n- `/Users/probinson/Repos/on-par/saas/agent-ops/docker-compose.yml`\n- `/Users/probinson/Repos/on-par/saas/agent-ops/docker-compose.dev.yml`\n- `/Users/probinson/Repos/on-par/saas/agent-ops/.env.example`\n- `/Users/probinson/Repos/on-par/saas/agent-ops/docs/local-deployment.md`\n- `/Users/probinson/Repos/on-par/saas/agent-ops/e2e/container-workflow.test.ts`\n\n### Existing Files to Modify\n\n- `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/shared/db/schema.ts` (add containers table)\n- `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/shared/config.ts` (add Docker config)\n- `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/app.ts` (register container routes)\n- `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/agent-runtime/services/agent-executor.service.ts` (add containerized execution)\n- `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/agent-runtime/tests/agent-executor.service.test.ts` (add containerized tests)\n- `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/App.tsx` (add Containers route)\n- `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/Layout.tsx` (add navigation link)\n- `/Users/probinson/Repos/on-par/saas/agent-ops/README.md` (update with container features)","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-24T10:27:58.780235-06:00","updated_at":"2025-12-24T18:12:54.246021-06:00","comments":[{"id":1,"issue_id":"agent-ops-4ka","author":"probinson","text":"# Research: Local Agent Dashboard MVP\n\n**Issue**: agent-ops-4ka\n**Date**: 2025-12-24\n**Status**: Research Complete\n\n---\n\n## 1. Problem Overview\n\n### Problem Statement\nBuild a local web dashboard to orchestrate Claude agents running in Docker containers on Mac M3 Pro (ARM64). The dashboard should provide real-time visibility into agent execution, streaming logs, terminal access, and lifecycle management while integrating with the existing agent-ops codebase.\n\n### Key Objectives\n\n1. **Container Isolation**: Run agents in Docker containers for security, resource control, and reproducibility\n2. **Real-time Monitoring**: Stream logs and status updates from running agents to the dashboard\n3. **Interactive Control**: Start, stop, and interact with agents via web UI and REST API\n4. **Mac ARM64 Support**: Full compatibility with Docker Desktop on macOS with Apple Silicon\n5. **Integration**: Seamlessly integrate with existing agent-runtime, workspace management, and bd workflow\n\n### Success Criteria\n\n- ✅ Agents execute in isolated Docker containers with resource limits\n- ✅ Dashboard displays active agents with real-time status updates\n- ✅ Logs stream in real-time via Server-Sent Events (SSE)\n- ✅ Terminal view per agent using xterm.js for interactive access\n- ✅ Start/stop controls work reliably\n- ✅ Works with existing CLI runner and bd issue tracking\n- ✅ No degradation of existing in-process execution performance\n- ✅ Complete test coverage for container lifecycle management\n\n---\n\n## 2. Web Research Findings\n\n### Recommended Technology Stack\n\n#### Backend Technologies\n\n##### 1. Docker Management: Dockerode\n**Library**: `dockerode@4.0.2`\n**Purpose**: Node.js client for Docker Remote API\n\n**Why Chosen**:\n- Most mature Docker SDK for Node.js (12M+ weekly downloads)\n- Excellent stream handling with built-in demultiplexing support\n- Comprehensive API coverage matching Docker Remote API\n- Works seamlessly on Mac ARM64 with Docker Desktop\n- Both callback and promise interfaces available\n\n**Key Features**:\n```typescript\nimport Docker from 'dockerode';\n\nconst docker = new Docker({ socketPath: '/var/run/docker.sock' });\n\n// Create and start a container\nconst container = await docker.createContainer({\n  Image: 'claude-agent:latest',\n  Cmd: ['node', 'agent.js'],\n  name: 'agent-1',\n  Env: ['ANTHROPIC_API_KEY=sk-...'],\n  HostConfig: {\n    Memory: 512 * 1024 * 1024, // 512MB\n    NanoCpus: 1000000000, // 1 CPU core\n  }\n});\n\nawait container.start();\n\n// Stream logs with demultiplexing\nconst stream = await container.attach({\n  stream: true,\n  stdout: true,\n  stderr: true\n});\n\ncontainer.modem.demuxStream(stream, process.stdout, process.stderr);\n```\n\n**Documentation**:\n- [Dockerode GitHub](https://github.com/apocas/dockerode)\n- [Dockerode npm](https://www.npmjs.com/package/dockerode)\n\n##### 2. Log Streaming: better-sse\n**Library**: `better-sse@0.13.0`\n**Purpose**: Server-Sent Events (SSE) for real-time log streaming\n\n**Why Chosen**:\n- SSE experiencing resurgence in 2025 for AI streaming applications\n- Simpler than WebSockets for one-way server-to-client communication\n- Native browser support with EventSource API\n- Automatic reconnection built into browser\n- TypeScript-native with zero dependencies\n- HTTP-based, works through proxies and firewalls\n\n**Key Features**:\n```typescript\nimport express from 'express';\nimport { createSession, createChannel } from 'better-sse';\nimport Docker from 'dockerode';\n\nconst app = express();\nconst docker = new Docker({ socketPath: '/var/run/docker.sock' });\nconst logChannels = new Map\u003cstring, any\u003e();\n\n// SSE endpoint for container logs\napp.get('/api/containers/:id/logs', async (req, res) =\u003e {\n  const session = await createSession(req, res);\n  const containerId = req.params.id;\n\n  let channel = logChannels.get(containerId);\n  if (!channel) {\n    channel = createChannel();\n    logChannels.set(containerId, channel);\n\n    const container = docker.getContainer(containerId);\n    const logStream = await container.logs({\n      follow: true,\n      stdout: true,\n      stderr: true,\n      timestamps: true\n    });\n\n    container.modem.demuxStream(\n      logStream,\n      { write: (chunk: Buffer) =\u003e channel.broadcast(chunk.toString(), 'stdout') },\n      { write: (chunk: Buffer) =\u003e channel.broadcast(chunk.toString(), 'stderr') }\n    );\n  }\n\n  channel.register(session);\n\n  session.state.on('disconnected', () =\u003e {\n    channel.deregister(session);\n  });\n});\n```\n\n**Frontend Integration**:\n```typescript\nimport { useEffect, useState } from 'react';\n\nfunction ContainerLogs({ containerId }: { containerId: string }) {\n  const [logs, setLogs] = useState\u003cstring[]\u003e([]);\n\n  useEffect(() =\u003e {\n    const eventSource = new EventSource(`/api/containers/${containerId}/logs`);\n\n    eventSource.addEventListener('stdout', (event) =\u003e {\n      setLogs(prev =\u003e [...prev, event.data]);\n    });\n\n    eventSource.addEventListener('stderr', (event) =\u003e {\n      setLogs(prev =\u003e [...prev, `[ERROR] ${event.data}`]);\n    });\n\n    return () =\u003e eventSource.close();\n  }, [containerId]);\n\n  return (\n    \u003cdiv className=\"logs\"\u003e\n      {logs.map((log, i) =\u003e \u003cdiv key={i}\u003e{log}\u003c/div\u003e)}\n    \u003c/div\u003e\n  );\n}\n```\n\n**Documentation**:\n- [better-sse GitHub](https://github.com/MatthewWid/better-sse)\n- [Real-time Log Streaming with SSE](https://dev.to/manojspace/real-time-log-streaming-with-nodejs-and-react-using-server-sent-events-sse-48pk)\n\n##### 3. Terminal Access: WebSocket + xterm.js\n**Library**: `ws@8.18.0` (WebSocket) + `@xterm/xterm@5.5.0` (Terminal)\n**Purpose**: Interactive browser-based terminal for containers\n\n**Why Chosen**:\n- Industry standard (used by Portainer, Selenoid UI)\n- Full terminal emulation with VT100/xterm compatibility\n- Interactive command execution in containers\n- No SSH server needed in containers\n- Rich add-on ecosystem (fit, search, weblinks, etc.)\n\n**Backend Implementation**:\n```typescript\nimport { WebSocketServer } from 'ws';\nimport Docker from 'dockerode';\n\nconst docker = new Docker({ socketPath: '/var/run/docker.sock' });\nconst wss = new WebSocketServer({ server });\n\nwss.on('connection', (ws, req) =\u003e {\n  const containerId = new URL(req.url!, 'ws://localhost').searchParams.get('container');\n\n  if (!containerId) {\n    ws.close();\n    return;\n  }\n\n  const container = docker.getContainer(containerId);\n\n  container.exec({\n    Cmd: ['bash'],\n    AttachStdin: true,\n    AttachStdout: true,\n    AttachStderr: true,\n    Tty: true\n  }).then(exec =\u003e {\n    return exec.start({\n      hijack: true,\n      stdin: true,\n      Tty: true\n    });\n  }).then(stream =\u003e {\n    ws.on('message', (msg) =\u003e stream.write(msg));\n    stream.on('data', (chunk: Buffer) =\u003e ws.send(chunk));\n    ws.on('close', () =\u003e stream.end());\n  });\n});\n```\n\n**Frontend Implementation**:\n```typescript\nimport { useEffect, useRef } from 'react';\nimport { Terminal } from '@xterm/xterm';\nimport { AttachAddon } from '@xterm/addon-attach';\nimport { FitAddon } from '@xterm/addon-fit';\nimport '@xterm/xterm/css/xterm.css';\n\nfunction ContainerTerminal({ containerId }: { containerId: string }) {\n  const terminalRef = useRef\u003cHTMLDivElement\u003e(null);\n\n  useEffect(() =\u003e {\n    if (!terminalRef.current) return;\n\n    const terminal = new Terminal({\n      cursorBlink: true,\n      fontSize: 14,\n      fontFamily: 'Menlo, Monaco, \"Courier New\", monospace'\n    });\n\n    const fitAddon = new FitAddon();\n    terminal.loadAddon(fitAddon);\n    terminal.open(terminalRef.current);\n    fitAddon.fit();\n\n    const ws = new WebSocket(`ws://localhost:3000?container=${containerId}`);\n    const attachAddon = new AttachAddon(ws);\n    terminal.loadAddon(attachAddon);\n\n    return () =\u003e {\n      ws.close();\n      terminal.dispose();\n    };\n  }, [containerId]);\n\n  return \u003cdiv ref={terminalRef} className=\"terminal-container\" /\u003e;\n}\n```\n\n**Documentation**:\n- [xterm.js Official Site](https://xtermjs.org/)\n- [Building Browser Terminal with Docker and XtermJS](https://www.presidio.com/technical-blog/building-a-browser-based-terminal-using-docker-and-xtermjs/)\n\n##### 4. API Validation: Zod\n**Library**: `zod@3.24.1`\n**Purpose**: Type-safe runtime validation with compile-time type inference\n\n**Why Chosen**:\n- Type safety from API to database with single schema definition\n- Runtime validation catches invalid data\n- Excellent TypeScript integration with type inference\n- Clear, structured error responses\n\n**Implementation**:\n```typescript\nimport { z } from 'zod';\n\nconst CreateAgentSchema = z.object({\n  name: z.string().min(1).max(50),\n  image: z.string().default('claude-agent:latest'),\n  memory: z.number().min(128).max(2048).default(512),\n  cpus: z.number().min(0.5).max(4).default(1),\n});\n\ntype CreateAgentInput = z.infer\u003ctypeof CreateAgentSchema\u003e;\n\nfunction validate\u003cT extends z.ZodType\u003e(schema: T) {\n  return (req: express.Request, res: express.Response, next: express.NextFunction) =\u003e {\n    const result = schema.safeParse(req.body);\n\n    if (!result.success) {\n      return res.status(400).json({\n        error: 'Validation failed',\n        details: result.error.issues.map(issue =\u003e ({\n          path: issue.path.join('.'),\n          message: issue.message,\n        })),\n      });\n    }\n\n    req.body = result.data;\n    next();\n  };\n}\n\napp.post('/api/agents', validate(CreateAgentSchema), async (req, res) =\u003e {\n  const input: CreateAgentInput = req.body;\n  // ... create agent\n});\n```\n\n**Documentation**:\n- [Building bulletproof ExpressJS APIs with Zod](https://blog.oscars.dev/posts/building-bulletproof-expressjs-apis-with-zod/)\n\n##### 5. Logging: Pino\n**Library**: `pino@9.7.0`\n**Purpose**: High-performance JSON logger for Node.js\n\n**Why Chosen**:\n- 5-10x faster than Winston\n- JSON-first structured logging\n- Asynchronous, non-blocking\n- Excellent for Docker environments\n- Already in use in the codebase\n\n**Implementation**:\n```typescript\nimport pino from 'pino';\n\nconst logger = pino({\n  level: process.env.NODE_ENV === 'production' ? 'info' : 'debug',\n  transport: process.env.NODE_ENV === 'development'\n    ? { target: 'pino-pretty' }\n    : undefined,\n});\n\nlogger.info({ containerId: 'abc123', event: 'started' }, 'Agent container started');\n```\n\n**Documentation**:\n- [Pino Logger: Complete Node.js Guide [2025]](https://signoz.io/guides/pino-logger/)\n\n#### Frontend Technologies\n\n##### 1. Build Tool: Vite\n**Version**: `7.2.0` (already in use)\n**Purpose**: Fast development experience with HMR\n\n**Why Chosen**:\n- Already in the codebase\n- Instant HMR and fast builds\n- Excellent TypeScript support\n- Native ESM support\n\n##### 2. UI Framework: React 18 + TypeScript\n**Version**: `19.2.0` (already in use)\n**Purpose**: Component-based UI development\n\n**Why Chosen**:\n- Already in the codebase\n- Mature ecosystem\n- Excellent TypeScript integration\n- Large community and resources\n\n##### 3. Component Library: shadcn/ui\n**Purpose**: Beautiful, accessible UI components\n\n**Why Chosen**:\n- Modern, customizable components\n- Tailwind CSS integration (already in use)\n- Accessibility built-in\n- Copy-paste components (no bloat)\n- 2025 best practice for admin dashboards\n\n**Usage**:\n```bash\nnpx shadcn-ui@latest add card button badge\n```\n\n**Documentation**:\n- [shadcn/ui](https://ui.shadcn.com/)\n- [shadcn-admin GitHub](https://github.com/rohitsoni007/shadcn-admin)\n\n##### 4. State Management: TanStack Query\n**Library**: `@tanstack/react-query@5.62.21`\n**Purpose**: Server state management with caching and auto-refetching\n\n**Why Chosen**:\n- Perfect for server state and caching\n- Automatic cache invalidation and refetching\n- Optimistic updates\n- Background refetching\n- Industry standard for 2025\n\n**Implementation**:\n```typescript\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\n\nexport function useAgents() {\n  const queryClient = useQueryClient();\n\n  const { data: agents, isLoading } = useQuery({\n    queryKey: ['agents'],\n    queryFn: async () =\u003e {\n      const { data } = await axios.get\u003cAgent[]\u003e('/api/agents');\n      return data;\n    },\n    refetchInterval: 5000, // Poll every 5 seconds\n  });\n\n  const startAgent = useMutation({\n    mutationFn: async (agentId: string) =\u003e {\n      const { data } = await axios.post(`/api/agents/${agentId}/start`);\n      return data;\n    },\n    onSuccess: () =\u003e {\n      queryClient.invalidateQueries({ queryKey: ['agents'] });\n    },\n  });\n\n  return { agents, isLoading, startAgent: startAgent.mutate };\n}\n```\n\n**Documentation**:\n- [TanStack Query Docs](https://tanstack.com/query/latest)\n\n### Best Practices and Patterns\n\n#### Docker Security for Local Deployment\n\n**Localhost Binding**:\n```typescript\n// Configure Docker Desktop to bind ports to 127.0.0.1 only\nconst containerConfig = {\n  HostConfig: {\n    PortBindings: {\n      '3000/tcp': [{ HostIp: '127.0.0.1', HostPort: '3000' }]\n    }\n  }\n};\n```\n\n**Resource Limits**:\n```typescript\nconst containerConfig = {\n  HostConfig: {\n    Memory: 512 * 1024 * 1024, // 512MB hard limit\n    MemoryReservation: 256 * 1024 * 1024, // 256MB soft limit\n    NanoCpus: 1000000000, // 1 CPU core\n    CpusetCpus: '0', // Pin to specific CPU core if needed\n  }\n};\n```\n\n**Secrets Management**:\n- Use Docker secrets or file-based mounts instead of environment variables\n- Never commit secrets to version control\n\n**Network Isolation**:\n- Use custom bridge networks to segment containers\n- Limit external network access\n\n**Documentation**:\n- [Docker Security 2025](https://www.onlinehashcrack.com/guides/best-practices/docker-security-2025-hardening-containers.php)\n- [Docker Secrets in Compose](https://docs.docker.com/compose/how-tos/use-secrets/)\n\n#### Health Checks and Monitoring\n\n**Dockerfile Health Check**:\n```dockerfile\nHEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \\\n  CMD node -e \"require('http').get('http://localhost:3000/health', (r) =\u003e process.exit(r.statusCode === 200 ? 0 : 1))\"\n```\n\n**Monitor Health via Dockerode**:\n```typescript\nconst container = docker.getContainer(containerId);\nconst info = await container.inspect();\n\nif (info.State.Health) {\n  console.log('Health status:', info.State.Health.Status);\n  console.log('Failed checks:', info.State.Health.FailingStreak);\n}\n```\n\n**Documentation**:\n- [Effective Docker Healthchecks for Node.js](https://patrickleet.medium.com/effective-docker-healthchecks-for-node-js-b11577c3e595)\n\n#### Agent Orchestration Patterns\n\n**Lifecycle Management**:\n1. Create workspace (temp directory)\n2. Clone repository into workspace\n3. Create Docker container with workspace mounted\n4. Start container\n5. Execute agent engine inside container (via Docker exec)\n6. Monitor health and collect results\n7. Stop and remove container\n8. Cleanup workspace\n\n**State Management**:\n```typescript\ninterface AgentState {\n  id: string;\n  status: 'idle' | 'running' | 'waiting' | 'error';\n  currentTask?: string;\n  memory: Record\u003cstring, any\u003e;\n  metadata: {\n    containerId: string;\n    startedAt: Date;\n    lastActive: Date;\n  };\n}\n```\n\n**Documentation**:\n- [Building Intelligent Multi-Agent System with Node.js](https://medium.com/@MNIVKA/building-an-intelligent-multi-agent-system-with-node-js-ai-orchestration-a1cc2835230a)\n\n### Recommended Architecture\n\n```\n┌─────────────────────────────────────────┐\n│         React Dashboard (Vite)          │\n│  - shadcn/ui components                 │\n│  - TanStack Query for API state         │\n│  - xterm.js for terminals               │\n│  - EventSource for log streaming        │\n└──────────────┬──────────────────────────┘\n               │ HTTP/WS/SSE\n┌──────────────▼──────────────────────────┐\n│      Fastify API Server (TypeScript)    │\n│  - Zod validation middleware            │\n│  - SSE endpoints for logs               │\n│  - WebSocket for terminals              │\n│  - REST API for CRUD operations         │\n└──────────────┬──────────────────────────┘\n               │ Dockerode\n┌──────────────▼──────────────────────────┐\n│       Docker Desktop (Mac ARM64)        │\n│  - Claude agent containers              │\n│  - Resource limits enforced             │\n│  - Health checks configured             │\n└─────────────────────────────────────────┘\n```\n\n---\n\n## 3. Codebase Analysis\n\n### Current Architecture\n\n**Agent Ops** is an autonomous work queue platform where AI agents execute work items from a Kanban board. The system is built with:\n\n**Tech Stack**:\n- Backend: Node.js 20+ with TypeScript, Fastify, SQLite (Drizzle ORM), WebSocket\n- Frontend: React 19.2 with TypeScript, Vite 7.2, Tailwind CSS 4.1, React Router 7.11, Zustand\n- Agent Runtime: Custom agent engine with LLM providers (Anthropic, OpenAI, Ollama, OpenRouter)\n- Package Manager: npm\n\n### Project Structure\n\n```\n/Users/probinson/Repos/on-par/saas/agent-ops/\n├── backend/\n│   ├── src/\n│   │   ├── index.ts                    # Server entry point\n│   │   ├── app.ts                      # Fastify app builder\n│   │   ├── cli.ts                      # CLI runner (agent-ops-4ka.13)\n│   │   ├── shared/\n│   │   │   ├── config.ts               # Environment configuration\n│   │   │   ├── db/\n│   │   │   │   ├── index.ts            # Database connection\n│   │   │   │   └── schema.ts           # Drizzle schema\n│   │   │   ├── git/\n│   │   │   │   └── git-operations.service.ts\n│   │   │   ├── websocket/\n│   │   │   │   └── websocket-hub.service.ts\n│   │   │   └── telemetry.ts\n│   │   └── features/\n│   │       ├── agent-runtime/\n│   │       │   ├── services/\n│   │       │   │   ├── agent-engine.service.ts    # Core agent execution\n│   │       │   │   ├── agent-tools.ts             # Tool definitions \u0026 executor\n│   │       │   │   ├── agent-executor.service.ts\n│   │       │   │   └── agent-lifecycle.service.ts\n│   │       │   ├── handler/\n│   │       │   │   └── agent-runtime.handler.ts   # REST API routes\n│   │       │   └── repositories/\n│   │       ├── llm-providers/\n│   │       │   ├── interfaces/\n│   │       │   │   └── llm-provider.interface.ts  # Provider abstraction\n│   │       │   ├── factory/\n│   │       │   │   └── provider.factory.ts        # Provider factory\n│   │       │   └── providers/\n│   │       ├── workers/\n│   │       │   ├── services/\n│   │       │   │   └── worker-pool.service.ts     # Worker lifecycle\n│   │       │   └── repositories/\n│   │       ├── workspaces/\n│   │       │   ├── services/\n│   │       │   │   └── workspace-manager.service.ts # Temp workspace creation\n│   │       │   └── repositories/\n│   │       └── [other features...]\n└── frontend/\n    ├── src/\n    │   ├── main.tsx\n    │   ├── App.tsx\n    │   ├── lib/\n    │   │   └── api.ts                  # API base URL config\n    │   ├── components/\n    │   │   └── Layout.tsx\n    │   └── pages/\n    │       ├── Dashboard.tsx            # Mission Control UI\n    │       ├── Kanban.tsx\n    │       ├── Agents.tsx\n    │       └── Settings.tsx\n```\n\n### Key Components\n\n#### 1. Agent Execution Engine\n**File**: `backend/src/features/agent-runtime/services/agent-engine.service.ts:1`\n\n**Purpose**: Core agent logic that runs tool-calling loops (Read → Think → Act → Observe)\n\n**Key Features**:\n- Loads tasks from bd (beads issue tracker)\n- Executes LLM with tool calls\n- Implements iteration limits\n- Tool executor for file operations, shell commands, glob search, grep\n- Supports commit on success\n\n**Interface**:\n```typescript\ninterface AgentEngineService {\n  execute(taskId: string, options: {\n    workspacePath: string;\n    maxIterations: number;\n    provider: LLMProvider;\n  }): Promise\u003cExecutionResult\u003e;\n}\n```\n\n#### 2. CLI Runner\n**File**: `backend/src/cli.ts:1`\n\n**Purpose**: Command-line interface for running agents without dashboard (completed issue agent-ops-4ka.13)\n\n**Key Features**:\n- Parses command-line arguments (provider, model, repo, workspace)\n- Sets up workspace (clone repo OR use existing directory)\n- Creates LLM provider instance\n- Instantiates AgentEngineService\n- Executes task and reports results\n\n**Usage**:\n```bash\nnpx agent-ops run \u003ctask-id\u003e --provider ollama --model qwen2.5-coder:7b\n```\n\n#### 3. LLM Provider Abstraction\n**File**: `backend/src/features/llm-providers/interfaces/llm-provider.interface.ts:1`\n\n**Interface**:\n```typescript\ninterface LLMProvider {\n  chat(messages: Message[], options?: ChatOptions): AsyncIterable\u003cChatChunk\u003e;\n  supportsToolCalling(): boolean;\n  callWithTools(messages: Message[], tools: Tool[]): Promise\u003cToolCallResult\u003e;\n}\n```\n\n**Supported Providers**:\n- Ollama (http://localhost:11434)\n- OpenAI (api.openai.com)\n- Anthropic (api.anthropic.com)\n- OpenRouter (openrouter.ai)\n\n#### 4. Git Operations Service\n**File**: `backend/src/shared/git/git-operations.service.ts:1`\n\n**Capabilities**:\n- Clone repository with authentication\n- Create and checkout branches\n- Stage changes, commit, push\n- Get diff and status\n- Create pull requests via GitHub API (Octokit)\n\n#### 5. Worker Pool Service\n**File**: `backend/src/features/workers/services/worker-pool.service.ts:1`\n\n**Purpose**: Manages agent worker lifecycle\n\n**Key Methods**:\n- `spawn(templateId, sessionId)`: Create worker\n- `terminate(workerId)`: Stop worker\n- `pause(workerId)`, `resume(workerId)`: Control execution\n- `assignWork(workerId, workItemId, role)`: Assign work\n- `updateMetrics(workerId, metrics)`: Track tokens, cost\n\n**Concurrency Control**: Configurable maxWorkers limit\n\n#### 6. Workspace Manager Service\n**File**: `backend/src/features/workspaces/services/workspace-manager.service.ts:1`\n\n**Purpose**: Manages temporary workspace directories for agent execution\n\n**Key Methods**:\n- `createWorkspace(workerId?, workItemId?, repositoryId?)`: Creates temp directory\n- `getWorkspacePath(id)`: Returns filesystem path\n- `cleanupWorkspace(id)`: Removes directory\n- `cleanupStaleWorkspaces(maxAgeMs)`: Cleanup old workspaces\n\n**Configuration**: Base directory (`/tmp/agent-workspaces`), cleanup delay (1 hour)\n\n#### 7. Configuration\n**File**: `backend/src/shared/config.ts:1`\n\n**Relevant Settings**:\n```typescript\ninterface Config {\n  port: number;                    // Default: 3001\n  host: string;                    // Default: 0.0.0.0\n  databaseUrl: string;             // Default: sqlite://./agent-ops.db\n  workspaceBaseDir: string;        // Default: /tmp/agent-workspaces\n  maxConcurrentAgents: number;     // Default: 5\n  agentTimeoutMs: number;          // Default: 600000 (10 min)\n  llmProvider: string;             // ollama, openai, anthropic, openrouter\n  llmModel: string;                // Default: qwen2.5-coder:7b\n}\n```\n\n#### 8. Database Schema\n**File**: `backend/src/shared/db/schema.ts:1`\n\n**Relevant Tables**:\n- `workspaces`: Tracks agent execution environments (path, status, branch, worker, work item)\n- `agentExecutions`: Execution records (status, duration, tokens, cost, output)\n- `workers`: Worker instances (template, status, current work, metrics)\n- `workItems`: Tasks on Kanban board\n\n**Status Enums**:\n- Workspace: `active | completed | error | cleaning`\n- Agent Execution: `pending | running | success | error | cancelled`\n- Worker: `idle | working | paused | error | terminated`\n\n#### 9. Fastify Application\n**File**: `backend/src/app.ts:1`\n\n**Current Setup**:\n- CORS enabled (dev: all origins, prod: restricted)\n- WebSocket support via @fastify/websocket\n- Pino logger (pino-pretty in dev)\n- Routes registered:\n  - `/api/work-items` - Work item management\n  - `/api/agent-runtime` - Agent execution APIs\n  - `/api/workers` - Worker management\n  - `/api/repositories`, `/api/pull-requests`\n\n### Existing Patterns to Follow\n\n#### Vertical Slice Architecture\nCode organized by feature, not layer:\n- `features/agent-runtime/` contains handlers, services, repositories, tests\n- `features/llm-providers/` contains provider interface, factory, implementations\n- Each feature is self-contained\n\n#### Service Layer Pattern\nServices contain business logic:\n```typescript\nexport class WorkerPoolService {\n  constructor(\n    private readonly workerRepository: WorkerRepository,\n    config?: WorkerPoolConfig\n  ) { ... }\n\n  async spawn(templateId: string, sessionId: string): Promise\u003cWorker\u003e { ... }\n}\n```\n\n#### Repository Pattern\nRepositories handle data access:\n- `WorkerRepository`, `WorkspaceRepository`, `AgentExecutionRepository`\n- Drizzle ORM for database operations\n- Separation of concerns: services call repositories\n\n#### Fastify Handler Plugin Pattern\n```typescript\nexport async function handlerName(\n  app: FastifyInstance,\n  options: HandlerOptions\n): Promise\u003cvoid\u003e {\n  const { db, config } = options;\n\n  app.post(\"/endpoint\", async (request, reply) =\u003e {\n    const data = schema.parse(request.body); // Zod validation\n    const result = await service.doSomething(data);\n    return result;\n  });\n}\n```\n\n#### Testing Patterns\n- Vitest for testing framework\n- AAA pattern (Arrange-Act-Assert)\n- Mock implementations for external dependencies\n- Test location: `features/*/tests/*.test.ts`\n\n---\n\n## 4. Proposed Solution Approach\n\n### High-Level Strategy\n\n**Hybrid Approach**: Add optional containerized execution while preserving existing in-process execution for development speed.\n\n**Key Design Decisions**:\n\n1. **Container Management**: Create new `ContainerManagerService` using Dockerode\n2. **Integration Point**: Extend `AgentExecutorService` to orchestrate container lifecycle\n3. **Database**: Add `containers` table to track container state\n4. **API**: Add `/api/containers` endpoints for lifecycle management\n5. **Logging**: Use SSE for real-time log streaming (better-sse)\n6. **Terminal**: Use WebSocket + xterm.js for interactive access\n7. **Frontend**: Extend existing Dashboard with container views (TanStack Query)\n\n### Container Lifecycle Flow\n\n```\n1. User triggers agent execution via API/CLI\n   ↓\n2. WorkspaceManagerService.createWorkspace()\n   → Creates temp directory: /tmp/agent-workspaces/{id}\n   ↓\n3. GitOperationsService.cloneRepository()\n   → Clones repo into workspace\n   ↓\n4. ContainerManagerService.createContainer()\n   → Creates Docker container with workspace mounted as volume\n   → Sets resource limits (CPU, memory)\n   → Configures environment variables (API keys, config)\n   ↓\n5. ContainerManagerService.startContainer()\n   → Starts container\n   → Begins health check monitoring\n   ↓\n6. AgentEngineService.execute() (inside container)\n   → Runs via Docker exec\n   → Streams output back to server\n   ↓\n7. ContainerManagerService.stopContainer()\n   → Gracefully stops container\n   ↓\n8. ContainerManagerService.removeContainer()\n   → Removes container and cleans up Docker resources\n   ↓\n9. WorkspaceManagerService.cleanupWorkspace()\n   → Removes temp directory\n```\n\n### Technology Choices with Justification\n\n| Component | Technology | Justification |\n|-----------|-----------|---------------|\n| Container Management | Dockerode | Most mature Docker SDK for Node.js, excellent stream handling, 12M+ weekly downloads |\n| Log Streaming | better-sse | Simpler than WebSocket for one-way streams, native browser support, TypeScript-first |\n| Terminal | WebSocket + xterm.js | Industry standard (Portainer, Selenoid), full terminal emulation |\n| API Validation | Zod | Type safety, runtime validation, already in codebase patterns |\n| State Management | TanStack Query | Best practice for server state in 2025, automatic cache invalidation |\n| UI Components | shadcn/ui | Modern, accessible, Tailwind integration (already in use) |\n| Logging | Pino | Already in use, 5-10x faster than Winston |\n| Framework | Fastify | Already in use, excellent TypeScript support, fast |\n\n### Key Implementation Steps\n\n#### Phase 1: Database \u0026 Core Services (P1)\n1. Add `containers` table to schema\n2. Create `ContainerRepository`\n3. Create `ContainerManagerService` with Dockerode\n4. Add unit tests for container lifecycle\n\n#### Phase 2: API Layer (P2)\n5. Create `ContainerHandler` with REST endpoints\n6. Extend `AgentExecutorService` to support containerized execution\n7. Add SSE endpoint for log streaming\n8. Add WebSocket endpoint for terminal access\n9. Add integration tests\n\n#### Phase 3: Frontend Integration (P3)\n10. Add TanStack Query hooks for container API\n11. Create `ContainerCard` component\n12. Create `ContainerLogs` component with SSE\n13. Create `ContainerTerminal` component with xterm.js\n14. Extend Dashboard to show containers\n15. Add E2E tests\n\n#### Phase 4: Docker \u0026 Deployment (P2)\n16. Create `Dockerfile.agent` for agent runtime\n17. Create `Dockerfile` for backend\n18. Create `Dockerfile` for frontend\n19. Create `docker-compose.yml` for orchestration\n20. Add documentation\n\n### Dependencies and Prerequisites\n\n**New Dependencies (Backend)**:\n```json\n{\n  \"dependencies\": {\n    \"dockerode\": \"^4.0.2\",\n    \"better-sse\": \"^0.13.0\",\n    \"ws\": \"^8.18.0\"\n  },\n  \"devDependencies\": {\n    \"@types/dockerode\": \"^3.3.31\",\n    \"@types/ws\": \"^8.5.13\"\n  }\n}\n```\n\n**New Dependencies (Frontend)**:\n```json\n{\n  \"dependencies\": {\n    \"@tanstack/react-query\": \"^5.62.21\",\n    \"@xterm/xterm\": \"^5.5.0\",\n    \"@xterm/addon-attach\": \"^0.11.0\",\n    \"@xterm/addon-fit\": \"^0.10.0\"\n  }\n}\n```\n\n**Prerequisites**:\n- Docker Desktop installed and running on Mac\n- `/var/run/docker.sock` accessible\n- Node.js 20+ with npm\n- Sufficient disk space for container images and workspaces\n\n---\n\n## 5. Next Steps\n\n### Recommended Implementation Order\n\n#### Step 1: Database Schema (Foundation)\n**File**: `backend/src/shared/db/schema.ts`\n\n**Action**: Add containers table\n```typescript\nexport const containers = sqliteTable(\"containers\", {\n  id: text(\"id\").primaryKey(),\n  containerId: text(\"container_id\").notNull().unique(),\n  workspaceId: text(\"workspace_id\").references(() =\u003e workspaces.id),\n  workerId: text(\"worker_id\").references(() =\u003e workers.id),\n  image: text(\"image\").notNull(),\n  status: text(\"status\").$type\u003cContainerStatus\u003e(),\n  createdAt: integer(\"created_at\", { mode: \"timestamp_ms\" }).notNull(),\n  stoppedAt: integer(\"stopped_at\", { mode: \"timestamp_ms\" }),\n});\n\nexport type ContainerStatus = 'creating' | 'running' | 'stopped' | 'error';\n```\n\n**Dependencies**: None (foundation for all other work)\n\n#### Step 2: Container Repository\n**File**: `backend/src/features/containers/repositories/container.repository.ts`\n\n**Action**: Create data access layer following existing repository patterns\n\n**Dependencies**: Schema changes must be complete\n\n#### Step 3: Container Manager Service (TDD)\n**Files**:\n- `backend/src/features/containers/services/container-manager.service.ts`\n- `backend/src/features/containers/tests/container-manager.service.test.ts`\n\n**Action**:\n1. Write tests first (TDD):\n   - Test container creation with workspace mount\n   - Test start/stop lifecycle\n   - Test exec in container\n   - Test log streaming\n   - Test error handling\n2. Implement service to pass tests\n\n**Dependencies**: Dockerode dependency added, repository created\n\n#### Step 4: Container Handler (API)\n**Files**:\n- `backend/src/features/containers/handler/container.handler.ts`\n- `backend/src/features/containers/tests/container.handler.test.ts`\n\n**Action**: Create REST API endpoints following Fastify handler pattern\n\n**Endpoints**:\n- `POST /api/containers` - Create container\n- `GET /api/containers` - List containers\n- `GET /api/containers/:id` - Get details\n- `POST /api/containers/:id/start` - Start\n- `POST /api/containers/:id/stop` - Stop\n- `DELETE /api/containers/:id` - Remove\n- `GET /api/containers/:id/logs` - Stream logs (SSE)\n\n**Dependencies**: Container manager service must exist\n\n#### Step 5: Agent Executor Integration\n**File**: `backend/src/features/agent-runtime/services/agent-executor.service.ts`\n\n**Action**: Extend to support containerized execution\n```typescript\nasync execute(taskId: string, options: {\n  containerized?: boolean; // NEW\n  // ... existing options\n}): Promise\u003cExecutionResult\u003e {\n  if (options.containerized) {\n    // Container-based execution flow\n  } else {\n    // Existing in-process execution\n  }\n}\n```\n\n**Dependencies**: Container manager service must be complete\n\n#### Step 6: Frontend Container Components\n**Files**:\n- `frontend/src/hooks/use-containers.ts` (TanStack Query)\n- `frontend/src/components/ContainerCard.tsx`\n- `frontend/src/components/ContainerLogs.tsx` (SSE)\n- `frontend/src/components/ContainerTerminal.tsx` (xterm.js)\n\n**Action**: Create React components for container visualization\n\n**Dependencies**: Backend API must be available\n\n#### Step 7: Docker Images\n**Files**:\n- `backend/Dockerfile.agent` (agent runtime image)\n- `backend/Dockerfile` (backend server image)\n- `frontend/Dockerfile` (frontend build + nginx)\n- `docker-compose.yml` (orchestration)\n\n**Action**: Create production-ready container images\n\n**Dependencies**: All services must be functional\n\n#### Step 8: E2E Testing\n**File**: Create E2E test for complete flow\n\n**Test Scenario**:\n1. Start agent via API\n2. Verify container created\n3. Stream logs via SSE\n4. Open terminal session\n5. Execute command in terminal\n6. Stop agent\n7. Verify cleanup\n\n**Dependencies**: All components must be integrated\n\n### Testing Considerations\n\n#### Unit Tests\n- **Container Manager Service**: Mock Dockerode, test lifecycle methods\n- **Container Repository**: Use in-memory SQLite, test CRUD operations\n- **Container Handler**: Use Fastify inject, test API endpoints\n\n#### Integration Tests\n- **Agent Executor + Containers**: Test full execution flow with real Docker\n- **SSE Log Streaming**: Test EventSource connection and data flow\n- **WebSocket Terminal**: Test terminal attach and command execution\n\n#### E2E Tests\n- **Complete User Flow**: Start agent → view logs → interact with terminal → stop agent\n- **Error Scenarios**: Container creation fails, agent crashes, network issues\n\n#### Test Coverage Goals\n- Unit tests: ≥80% coverage\n- Integration tests: All critical paths\n- E2E tests: Core user journeys\n\n### Configuration Management\n\n**Environment Variables** (`.env.example`):\n```bash\n# Server\nPORT=3001\nHOST=0.0.0.0\n\n# Database\nDATABASE_URL=sqlite://./agent-ops.db\n\n# LLM Provider\nLLM_PROVIDER=ollama\nLLM_MODEL=qwen2.5-coder:7b\nLLM_BASE_URL=http://host.docker.internal:11434\n\n# Docker\nDOCKER_AGENT_IMAGE=agent-ops/agent:latest\nDOCKER_SOCKET=/var/run/docker.sock\n\n# Agent Runtime\nWORKSPACE_BASE_DIR=/tmp/agent-workspaces\nMAX_CONCURRENT_AGENTS=5\nAGENT_TIMEOUT_MS=600000\n```\n\n### Security Considerations\n\n1. **Docker Socket Access**: Mounting `/var/run/docker.sock` gives full Docker access\n   - **Mitigation**: Run backend with minimal privileges, validate all container configs\n\n2. **Container Isolation**: Agents run user-provided code\n   - **Mitigation**: Resource limits, read-only root filesystem, non-root user\n\n3. **Secrets Management**: API keys passed to containers\n   - **Mitigation**: Use Docker secrets or file-based mounts, never log secrets\n\n4. **Network Security**: Containers should not access internal networks\n   - **Mitigation**: Use custom Docker network with limited access\n\n### Performance Optimization\n\n1. **Container Startup**: ~2-5 seconds overhead\n   - **Optimization**: Pre-build and cache agent image\n\n2. **Workspace Cleanup**: Disk space management\n   - **Optimization**: Background job to cleanup old workspaces\n\n3. **Log Storage**: Container logs can be large\n   - **Optimization**: Implement log rotation, max size limits\n\n4. **Resource Limits**: Prevent resource exhaustion\n   - **Optimization**: Enforce CPU/memory limits per container\n\n### Rollout Plan\n\n#### Development Phase\n1. Implement with in-process execution as fallback\n2. Make containerization opt-in via config flag\n3. Test thoroughly with local Ollama provider\n\n#### Testing Phase\n1. Deploy to staging environment\n2. Run E2E tests with real workloads\n3. Monitor resource usage and performance\n4. Gather feedback\n\n#### Production Phase\n1. Make containerization default for production\n2. Keep in-process execution for CLI/development\n3. Monitor metrics and logs\n4. Iterate based on usage patterns\n\n---\n\n## References\n\n### Web Research Sources\n\n**Docker Container Management**:\n- [Dockerode GitHub](https://github.com/apocas/dockerode)\n- [Dockerode npm](https://www.npmjs.com/package/dockerode)\n- [Dockerode: Streamlining Docker Management](https://abylin.medium.com/dockerode-streamlining-docker-management-using-node-js-9d2f72180fc0)\n\n**Real-time Log Streaming**:\n- [better-sse GitHub](https://github.com/MatthewWid/better-sse)\n- [SSE's Glorious Comeback (2025)](https://portalzine.de/sses-glorious-comeback-why-2025-is-the-year-of-server-sent-events/)\n- [Real-time Log Streaming with Node.js and React](https://dev.to/manojspace/real-time-log-streaming-with-nodejs-and-react-using-server-sent-events-sse-48pk)\n\n**Terminal Emulation**:\n- [xterm.js Official Site](https://xtermjs.org/)\n- [Building Browser Terminal with Docker and XtermJS](https://www.presidio.com/technical-blog/building-a-browser-based-terminal-using-docker-and-xtermjs/)\n\n**Dashboard Architecture**:\n- [shadcn-admin GitHub](https://github.com/rohitsoni007/shadcn-admin)\n- [TanStack Query Documentation](https://tanstack.com/query/latest)\n\n**TypeScript \u0026 Validation**:\n- [Building bulletproof ExpressJS APIs with Zod](https://blog.oscars.dev/posts/building-bulletproof-expressjs-apis-with-zod/)\n\n**Docker Security**:\n- [Docker Security 2025](https://www.onlinehashcrack.com/guides/best-practices/docker-security-2025-hardening-containers.php)\n- [Docker Secrets in Compose](https://docs.docker.com/compose/how-tos/use-secrets/)\n\n**Logging**:\n- [Pino Logger Complete Guide [2025]](https://signoz.io/guides/pino-logger/)\n- [Pino vs. Winston](https://dev.to/wallacefreitas/pino-vs-winston-choosing-the-right-logger-for-your-nodejs-application-369n)\n\n### Codebase Files Analyzed\n\n**Core Services**:\n- `backend/src/features/agent-runtime/services/agent-engine.service.ts:1`\n- `backend/src/features/agent-runtime/services/agent-executor.service.ts:1`\n- `backend/src/features/llm-providers/interfaces/llm-provider.interface.ts:1`\n- `backend/src/features/workers/services/worker-pool.service.ts:1`\n- `backend/src/features/workspaces/services/workspace-manager.service.ts:1`\n- `backend/src/shared/git/git-operations.service.ts:1`\n\n**Configuration \u0026 Infrastructure**:\n- `backend/src/shared/config.ts:1`\n- `backend/src/shared/db/schema.ts:1`\n- `backend/src/app.ts:1`\n- `backend/src/cli.ts:1`\n\n---\n\n## Conclusion\n\nThis research provides a comprehensive foundation for implementing the Local Agent Dashboard MVP with Docker container orchestration. The solution integrates modern best practices (SSE, xterm.js, TanStack Query, shadcn/ui) with the existing agent-ops codebase architecture, following established patterns while adding production-grade container isolation and monitoring capabilities.\n\n**Key Takeaways**:\n1. Use Dockerode for robust container management on Mac ARM64\n2. Implement SSE for efficient one-way log streaming\n3. Use WebSocket + xterm.js for interactive terminal access\n4. Follow existing vertical slice architecture and service patterns\n5. Add optional containerization without breaking existing workflows\n6. Prioritize security with resource limits and network isolation\n7. Use TDD throughout implementation\n\n**Next Action**: Review this research document, then proceed to planning phase to create detailed implementation tasks.\n","created_at":"2025-12-24T20:56:45Z"}]}
{"id":"agent-ops-4ka.1","title":"Agent Docker image (ARM64)","description":"Create Dockerfile for agent container:\n- Base: node:20-slim (ARM64 compatible)\n- Install: bd, git, aider (optional for Ollama mode)\n- NO Claude CLI required - uses provider abstraction\n- Entrypoint: node script that receives task config\n- Connects to host LLM via OLLAMA_HOST or LLM_BASE_URL\n- Volume mount for workspace\n\nEnvironment vars:\n- TASK_ID: bead issue to work on\n- LLM_PROVIDER: ollama|openai|anthropic|openrouter\n- LLM_MODEL: model name\n- LLM_BASE_URL: provider endpoint\n- LLM_API_KEY: for cloud providers","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-24T10:28:17.459493-06:00","updated_at":"2025-12-24T14:45:23.462169-06:00","dependencies":[{"issue_id":"agent-ops-4ka.1","depends_on_id":"agent-ops-4ka","type":"parent-child","created_at":"2025-12-24T10:28:17.470669-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4ka.10","title":"Agent execution engine","description":"Core agent logic that runs inside container:\n\n**Responsibilities:**\n- Load task from bd (bd show TASK_ID)\n- Plan approach using LLM\n- Execute steps: read files, edit, run commands\n- Tool calling loop (read → think → act → observe)\n- Commit changes on success\n- Report status back to orchestrator\n\n**Tool definitions (provider-agnostic):**\n- read_file(path) - Read file contents\n- write_file(path, content) - Write/create file\n- edit_file(path, old, new) - Search/replace edit\n- run_command(cmd) - Execute shell command\n- search_files(pattern) - Glob search\n- grep(pattern, path) - Content search\n\n**Uses LLM provider abstraction - works with any backend.**","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T10:43:29.955632-06:00","updated_at":"2025-12-24T12:22:53.942584-06:00","closed_at":"2025-12-24T12:22:53.942584-06:00","close_reason":"Closed","dependencies":[{"issue_id":"agent-ops-4ka.10","depends_on_id":"agent-ops-4ka","type":"parent-child","created_at":"2025-12-24T10:43:29.965497-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4ka.11","title":"Dashboard: Provider settings","description":"UI to configure LLM provider:\n\n**Settings panel:**\n- Provider dropdown: Ollama, OpenAI, Anthropic, OpenRouter\n- Model selector (fetches available models from provider)\n- Base URL override (for self-hosted)\n- API key input (for cloud providers)\n- Test connection button\n\n**Persist to:**\n- Local storage (browser)\n- Or backend config endpoint\n\n**Show status:**\n- Provider connected/disconnected\n- Current model\n- Estimated cost per task (for paid providers)","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-24T10:43:40.094151-06:00","updated_at":"2025-12-24T11:02:05.349386-06:00","dependencies":[{"issue_id":"agent-ops-4ka.11","depends_on_id":"agent-ops-4ka","type":"parent-child","created_at":"2025-12-24T10:43:40.102087-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4ka.12","title":"Git operations service","description":"Git operations for agent workflow:\n\n**Operations:**\n- cloneRepo(url, workspace) - Clone to temp dir\n- createBranch(name) - Create and checkout branch\n- commitChanges(message) - Stage all and commit\n- pushBranch() - Push to origin\n- createPR(title, body) - Create PR via GitHub API\n\n**Uses existing GitHub service for API calls.**\n**Workspace cleanup on agent completion.**","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T11:02:14.784364-06:00","updated_at":"2025-12-24T12:30:37.026119-06:00","closed_at":"2025-12-24T12:30:37.026119-06:00","close_reason":"Closed","dependencies":[{"issue_id":"agent-ops-4ka.12","depends_on_id":"agent-ops-4ka","type":"parent-child","created_at":"2025-12-24T11:02:14.791974-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4ka.13","title":"CLI runner for testing","description":"Simple CLI to run agent without dashboard:\n\n```bash\nnpx agent-ops run \u003ctask-id\u003e \\\n  --provider ollama \\\n  --model qwen2.5-coder:7b \\\n  --repo https://github.com/org/repo\n```\n\n**For fast iteration before dashboard is ready.**\n**Outputs agent actions to stdout.**","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T11:02:24.39814-06:00","updated_at":"2025-12-24T12:36:49.334677-06:00","closed_at":"2025-12-24T12:36:49.334677-06:00","close_reason":"Closed","dependencies":[{"issue_id":"agent-ops-4ka.13","depends_on_id":"agent-ops-4ka","type":"parent-child","created_at":"2025-12-24T11:02:24.407511-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4ka.2","title":"Container lifecycle service","description":"Backend service to manage Docker containers:\n- Start container for a task (docker run)\n- Stop/kill container\n- List running containers\n- Capture container logs\n- Cleanup finished containers\n- Use dockerode npm package","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-24T10:28:19.744162-06:00","updated_at":"2025-12-24T14:45:24.800842-06:00","dependencies":[{"issue_id":"agent-ops-4ka.2","depends_on_id":"agent-ops-4ka","type":"parent-child","created_at":"2025-12-24T10:28:19.750405-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4ka.3","title":"SSE log streaming endpoint","description":"Add SSE endpoint to stream container logs:\n- GET /api/agents/:containerId/logs (SSE)\n- Stream docker logs in real-time\n- Handle container exit gracefully\n- Include timestamps and log levels","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-24T10:28:21.395737-06:00","updated_at":"2025-12-24T11:02:04.372275-06:00","dependencies":[{"issue_id":"agent-ops-4ka.3","depends_on_id":"agent-ops-4ka","type":"parent-child","created_at":"2025-12-24T10:28:21.403487-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4ka.4","title":"Agent REST API","description":"REST endpoints for agent management:\n- POST /api/agents/start { taskId, pattern? }\n- DELETE /api/agents/:id (stop)\n- GET /api/agents (list running)\n- GET /api/agents/:id (status + details)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-24T10:28:23.052508-06:00","updated_at":"2025-12-24T11:02:04.560956-06:00","dependencies":[{"issue_id":"agent-ops-4ka.4","depends_on_id":"agent-ops-4ka","type":"parent-child","created_at":"2025-12-24T10:28:23.061014-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4ka.5","title":"Dashboard: Agent list component","description":"React component showing running agents:\n- Card per agent: task ID, status, duration\n- Start/stop buttons\n- Click to view logs\n- Auto-refresh via WebSocket or polling\n- Empty state: 'No agents running'","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-24T10:28:24.947885-06:00","updated_at":"2025-12-24T11:02:04.757919-06:00","dependencies":[{"issue_id":"agent-ops-4ka.5","depends_on_id":"agent-ops-4ka","type":"parent-child","created_at":"2025-12-24T10:28:24.959922-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4ka.6","title":"Dashboard: Terminal component","description":"Terminal viewer using xterm.js:\n- npm install xterm xterm-addon-fit\n- Connect to SSE log stream\n- ANSI color support\n- Auto-scroll with pause option\n- Resize handling","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-24T10:28:26.473326-06:00","updated_at":"2025-12-24T11:02:04.946513-06:00","dependencies":[{"issue_id":"agent-ops-4ka.6","depends_on_id":"agent-ops-4ka","type":"parent-child","created_at":"2025-12-24T10:28:26.479161-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4ka.7","title":"Dashboard: Start agent flow","description":"UI to start new agents:\n- Button to open start dialog\n- Select from ready tasks (bd ready)\n- Or enter pattern filter\n- Set max concurrent limit\n- Show confirmation before starting","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-24T10:28:38.114341-06:00","updated_at":"2025-12-24T11:02:05.14773-06:00","dependencies":[{"issue_id":"agent-ops-4ka.7","depends_on_id":"agent-ops-4ka","type":"parent-child","created_at":"2025-12-24T10:28:38.122071-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4ka.8","title":"E2E: Start agent, view logs, stop","description":"Integration test for full flow:\n- Start agent from dashboard\n- See it appear in agent list\n- View live logs in terminal\n- Stop agent\n- Verify container cleaned up","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-24T10:28:39.979068-06:00","updated_at":"2025-12-24T11:02:05.557601-06:00","dependencies":[{"issue_id":"agent-ops-4ka.8","depends_on_id":"agent-ops-4ka","type":"parent-child","created_at":"2025-12-24T10:28:39.99027-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4ka.9","title":"LLM Provider abstraction layer","description":"Create provider-agnostic LLM interface:\n\n**Interface:**\n```typescript\ninterface LLMProvider {\n  chat(messages: Message[], options?: ChatOptions): AsyncIterable\u003cChatChunk\u003e;\n  supportsToolCalling(): boolean;\n  callWithTools(messages: Message[], tools: Tool[]): Promise\u003cToolCallResult\u003e;\n}\n```\n\n**Providers to implement:**\n- OllamaProvider (http://localhost:11434/v1)\n- OpenAIProvider (api.openai.com)\n- AnthropicProvider (api.anthropic.com)\n- OpenRouterProvider (openrouter.ai/api)\n\n**Config:**\n```yaml\nllm:\n  provider: ollama  # or openai, anthropic, openrouter\n  model: qwen2.5-coder:7b\n  baseUrl: http://localhost:11434  # optional override\n  apiKey: ${LLM_API_KEY}  # for cloud providers\n```\n\nAll providers use OpenAI-compatible API where possible.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T10:43:04.350298-06:00","updated_at":"2025-12-24T12:20:11.258106-06:00","closed_at":"2025-12-24T12:20:11.258106-06:00","close_reason":"Closed","dependencies":[{"issue_id":"agent-ops-4ka.9","depends_on_id":"agent-ops-4ka","type":"parent-child","created_at":"2025-12-24T10:43:04.351463-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4rv","title":"Create E2E test script with Playwright for Aspire integration","description":"Create an automated E2E test script that:\n1. Starts Aspire (dotnet run --project AppHost)\n2. Waits for services to be ready\n3. Uses Playwright (headless) to verify:\n   - Backend API responds\n   - Frontend loads\n   - Aspire Dashboard shows services\n   - Telemetry traces appear\n4. Cleans up processes on exit\n\nScript: e2e-test.sh or similar","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-23T14:20:00.732633-06:00","updated_at":"2025-12-23T14:38:11.214158-06:00","closed_at":"2025-12-23T14:38:11.214158-06:00","close_reason":"Closed","labels":["testing aspire"]}
{"id":"agent-ops-4yu","title":"Phase 5: Frontend Integration","description":"Connect frontend to backend with Zustand stores, API client, React Query, WebSocket real-time updates, and drag-and-drop functionality.","status":"open","priority":3,"issue_type":"epic","created_at":"2025-12-20T22:44:01.369637-06:00","updated_at":"2025-12-23T20:18:45.852494-06:00","labels":["frontend","integration"],"dependencies":[{"issue_id":"agent-ops-4yu","depends_on_id":"agent-ops-ll0","type":"blocks","created_at":"2025-12-20T22:47:28.781511-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4yu.1","title":"Implement API client","description":"Create src/api/client.ts with fetch wrapper and typed methods for all backend endpoints (work-items, templates, workers, metrics, config).","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:46:40.67856-06:00","updated_at":"2025-12-23T20:18:46.099883-06:00","labels":["api","frontend"],"dependencies":[{"issue_id":"agent-ops-4yu.1","depends_on_id":"agent-ops-4yu","type":"parent-child","created_at":"2025-12-20T22:46:40.68128-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4yu.10","title":"Connect Agents page to real data","description":"Replace hardcoded mock data in Agents.tsx with React Query hooks and implement worker control actions.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:46:52.331297-06:00","updated_at":"2025-12-23T20:18:48.494035-06:00","labels":["frontend","integration"],"dependencies":[{"issue_id":"agent-ops-4yu.10","depends_on_id":"agent-ops-4yu","type":"parent-child","created_at":"2025-12-20T22:46:52.334053-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4yu.2","title":"Implement WorkItems Zustand store","description":"Create src/stores/work-items.store.ts with state and actions for work item CRUD, status transitions, and optimistic updates.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:46:41.679572-06:00","updated_at":"2025-12-23T20:18:46.344213-06:00","labels":["frontend","state"],"dependencies":[{"issue_id":"agent-ops-4yu.2","depends_on_id":"agent-ops-4yu","type":"parent-child","created_at":"2025-12-20T22:46:41.683109-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4yu.3","title":"Implement Workers Zustand store","description":"Create src/stores/workers.store.ts with state and actions for agent workers, status updates, and metrics.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:46:43.103687-06:00","updated_at":"2025-12-23T20:18:46.582186-06:00","labels":["frontend","state"],"dependencies":[{"issue_id":"agent-ops-4yu.3","depends_on_id":"agent-ops-4yu","type":"parent-child","created_at":"2025-12-20T22:46:43.106622-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4yu.4","title":"Implement Templates Zustand store","description":"Create src/stores/templates.store.ts with state and actions for agent template management.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:46:44.139927-06:00","updated_at":"2025-12-23T20:18:46.82238-06:00","labels":["frontend","state"],"dependencies":[{"issue_id":"agent-ops-4yu.4","depends_on_id":"agent-ops-4yu","type":"parent-child","created_at":"2025-12-20T22:46:44.142658-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4yu.5","title":"Setup React Query integration","description":"Configure React Query provider, create query hooks for data fetching with caching, and integrate with Zustand stores.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:46:46.344097-06:00","updated_at":"2025-12-23T20:18:47.059184-06:00","labels":["data","frontend"],"dependencies":[{"issue_id":"agent-ops-4yu.5","depends_on_id":"agent-ops-4yu","type":"parent-child","created_at":"2025-12-20T22:46:46.346757-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4yu.6","title":"Implement WebSocket client","description":"Create src/hooks/useWebSocket.ts using react-use-websocket for real-time updates, reconnection handling, and event dispatching to stores.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:46:47.467021-06:00","updated_at":"2025-12-23T20:18:47.295653-06:00","labels":["frontend","websocket"],"dependencies":[{"issue_id":"agent-ops-4yu.6","depends_on_id":"agent-ops-4yu","type":"parent-child","created_at":"2025-12-20T22:46:47.469636-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4yu.7","title":"Implement Kanban drag-and-drop","description":"Integrate @dnd-kit for Kanban board task reordering and column transitions with backend sync.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:46:48.468861-06:00","updated_at":"2025-12-23T20:18:47.538235-06:00","labels":["frontend","ui"],"dependencies":[{"issue_id":"agent-ops-4yu.7","depends_on_id":"agent-ops-4yu","type":"parent-child","created_at":"2025-12-20T22:46:48.471813-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4yu.8","title":"Connect Dashboard to real data","description":"Replace hardcoded mock data in Dashboard.tsx with React Query hooks fetching from backend APIs.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:46:49.758444-06:00","updated_at":"2025-12-23T20:18:47.878167-06:00","labels":["frontend","integration"],"dependencies":[{"issue_id":"agent-ops-4yu.8","depends_on_id":"agent-ops-4yu","type":"parent-child","created_at":"2025-12-20T22:46:49.761044-06:00","created_by":"daemon"}]}
{"id":"agent-ops-4yu.9","title":"Connect Kanban to real data","description":"Replace hardcoded mock data in Kanban.tsx with React Query hooks and implement status transition calls.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:46:51.051945-06:00","updated_at":"2025-12-23T20:18:48.196416-06:00","labels":["frontend","integration"],"dependencies":[{"issue_id":"agent-ops-4yu.9","depends_on_id":"agent-ops-4yu","type":"parent-child","created_at":"2025-12-20T22:46:51.054475-06:00","created_by":"daemon"}]}
{"id":"agent-ops-7vk","title":"Phase 2: Business Logic","description":"Implement core services layer including work item management, template registry, worker pool, and workflow engine with state machine transitions and approval gates.","status":"closed","priority":0,"issue_type":"epic","created_at":"2025-12-20T22:43:57.535971-06:00","updated_at":"2025-12-22T08:44:08.195136-06:00","closed_at":"2025-12-22T08:44:08.195136-06:00","close_reason":"Closed","labels":["backend","services"],"dependencies":[{"issue_id":"agent-ops-7vk","depends_on_id":"agent-ops-0fl","type":"blocks","created_at":"2025-12-20T22:47:28.120681-06:00","created_by":"daemon"}]}
{"id":"agent-ops-7vk.1","title":"Implement WorkItem service","description":"Create src/services/work-item.service.ts with business logic for work item lifecycle, status transitions, and success criteria management.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-20T22:45:03.757551-06:00","updated_at":"2025-12-21T13:22:04.890858-06:00","closed_at":"2025-12-21T13:22:04.890858-06:00","close_reason":"Closed","labels":["backend","services"],"dependencies":[{"issue_id":"agent-ops-7vk.1","depends_on_id":"agent-ops-7vk","type":"parent-child","created_at":"2025-12-20T22:45:03.760792-06:00","created_by":"daemon"}]}
{"id":"agent-ops-7vk.2","title":"Implement Template registry service","description":"Create src/services/template-registry.service.ts for managing agent templates including built-in templates and user-defined templates.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T22:45:04.712367-06:00","updated_at":"2025-12-22T08:43:52.017783-06:00","closed_at":"2025-12-22T08:43:52.017783-06:00","close_reason":"Closed","labels":["backend","services"],"dependencies":[{"issue_id":"agent-ops-7vk.2","depends_on_id":"agent-ops-7vk","type":"parent-child","created_at":"2025-12-20T22:45:04.71523-06:00","created_by":"daemon"}]}
{"id":"agent-ops-7vk.3","title":"Implement Worker pool service","description":"Create src/services/worker-pool.service.ts for managing agent worker lifecycle, concurrency limits (max_workers), and work queue.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-20T22:45:05.940132-06:00","updated_at":"2025-12-21T13:22:05.098858-06:00","closed_at":"2025-12-21T13:22:05.098858-06:00","close_reason":"Closed","labels":["backend","services"],"dependencies":[{"issue_id":"agent-ops-7vk.3","depends_on_id":"agent-ops-7vk","type":"parent-child","created_at":"2025-12-20T22:45:05.943504-06:00","created_by":"daemon"}]}
{"id":"agent-ops-7vk.4","title":"Implement Workflow engine service","description":"Create src/services/workflow-engine.service.ts with state machine for Kanban transitions, configurable approval gates, and work assignment logic.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-20T22:45:07.018829-06:00","updated_at":"2025-12-21T13:22:05.309043-06:00","closed_at":"2025-12-21T13:22:05.309043-06:00","close_reason":"Closed","labels":["backend","services"],"dependencies":[{"issue_id":"agent-ops-7vk.4","depends_on_id":"agent-ops-7vk","type":"parent-child","created_at":"2025-12-20T22:45:07.02171-06:00","created_by":"daemon"}]}
{"id":"agent-ops-7vk.5","title":"Implement Observability service","description":"Create src/services/observability.service.ts for collecting agent metrics, token usage, cost tracking, and trace events.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T22:45:08.33106-06:00","updated_at":"2025-12-22T08:43:52.267105-06:00","closed_at":"2025-12-22T08:43:52.267105-06:00","close_reason":"Closed","labels":["backend","services"],"dependencies":[{"issue_id":"agent-ops-7vk.5","depends_on_id":"agent-ops-7vk","type":"parent-child","created_at":"2025-12-20T22:45:08.333737-06:00","created_by":"daemon"}]}
{"id":"agent-ops-7vk.6","title":"Implement WebSocket hub service","description":"Create src/services/websocket-hub.service.ts for real-time event broadcasting to connected clients including agent state, work item updates, and metrics.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T22:45:09.695881-06:00","updated_at":"2025-12-22T08:43:52.521286-06:00","closed_at":"2025-12-22T08:43:52.521286-06:00","close_reason":"Closed","labels":["backend","services"],"dependencies":[{"issue_id":"agent-ops-7vk.6","depends_on_id":"agent-ops-7vk","type":"parent-child","created_at":"2025-12-20T22:45:09.703399-06:00","created_by":"daemon"}]}
{"id":"agent-ops-93m","title":"Phase 0: Aspire Infrastructure Migration","description":"Convert the existing codebase to use .NET Aspire for service orchestration, telemetry, and local development experience. This enables polyglot service management, OpenTelemetry-based observability, and the Aspire Dashboard for debugging agent behavior.\n\n## Why Aspire?\n- Multi-agent orchestration with service discovery\n- OpenTelemetry integration (industry standard, portable to production APM)\n- Aspire Dashboard for real-time traces, logs, metrics visualization\n- Future-proof for adding Redis, Postgres, message queues\n- Better developer experience than Makefile-based orchestration\n\n## Scope\n- Add C# AppHost project (~30 lines) for orchestration\n- Add OpenTelemetry SDK to Node.js backend\n- Refactor ObservabilityService to emit OTEL spans\n- Remove Makefile orchestration (replaced by Aspire)\n- Requires .NET 10 SDK for Aspire 13 polyglot features\n\n## What's Preserved\n- All Drizzle schema and migrations\n- All Zod models\n- All repositories\n- All business logic services\n- Frontend components unchanged","status":"closed","priority":0,"issue_type":"epic","created_at":"2025-12-22T14:09:46.480209-06:00","updated_at":"2025-12-23T14:38:27.834905-06:00","closed_at":"2025-12-23T14:38:27.834905-06:00","close_reason":"Closed","labels":["aspire","infrastructure"]}
{"id":"agent-ops-93m.1","title":"Add AppHost C# project for Aspire orchestration","description":"Create the C# AppHost project that orchestrates the Node.js backend and React frontend using Aspire 13.\n\n## Files to Create\n```\nAppHost/\n├── AppHost.csproj\n└── Program.cs\n```\n\n## AppHost.csproj\n```xml\n\u003cProject Sdk=\"Microsoft.NET.Sdk\"\u003e\n  \u003cPropertyGroup\u003e\n    \u003cOutputType\u003eExe\u003c/OutputType\u003e\n    \u003cTargetFramework\u003enet10.0\u003c/TargetFramework\u003e\n    \u003cIsAspireHost\u003etrue\u003c/IsAspireHost\u003e\n  \u003c/PropertyGroup\u003e\n  \u003cItemGroup\u003e\n    \u003cPackageReference Include=\"Aspire.Hosting\" Version=\"13.*\" /\u003e\n    \u003cPackageReference Include=\"Aspire.Hosting.NodeJs\" Version=\"13.*\" /\u003e\n  \u003c/ItemGroup\u003e\n\u003c/Project\u003e\n```\n\n## Program.cs\n```csharp\nvar builder = DistributedApplication.CreateBuilder(args);\n\nvar backend = builder.AddNodeApp(\"backend\", \"../backend\", \"dist/index.js\")\n    .WithHttpEndpoint(port: 3001, name: \"api\");\n\nvar frontend = builder.AddViteApp(\"frontend\", \"../frontend\")\n    .WithReference(backend);\n\nbuilder.Build().Run();\n```\n\n## Prerequisites\n- Install .NET 10 SDK\n- Run `dotnet workload install aspire`\n\n## Acceptance Criteria\n- [ ] AppHost project builds successfully\n- [ ] `dotnet run --project AppHost` starts both backend and frontend\n- [ ] Aspire Dashboard accessible at http://localhost:15888","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-22T14:10:01.53767-06:00","updated_at":"2025-12-23T12:45:38.746975-06:00","closed_at":"2025-12-23T12:45:38.746975-06:00","close_reason":"Closed","labels":["aspire","dotnet","infrastructure"],"dependencies":[{"issue_id":"agent-ops-93m.1","depends_on_id":"agent-ops-93m","type":"parent-child","created_at":"2025-12-22T14:10:01.540984-06:00","created_by":"daemon"}]}
{"id":"agent-ops-93m.2","title":"Add OpenTelemetry SDK packages to backend","description":"Install the OpenTelemetry Node.js SDK packages required for emitting traces, metrics, and logs to the Aspire Dashboard.\n\n## Packages to Install\n```bash\nnpm install @opentelemetry/sdk-node \\\n  @opentelemetry/api \\\n  @opentelemetry/auto-instrumentations-node \\\n  @opentelemetry/exporter-trace-otlp-grpc \\\n  @opentelemetry/exporter-metrics-otlp-grpc \\\n  @opentelemetry/resources \\\n  @opentelemetry/semantic-conventions\n```\n\n## Why These Packages\n- `@opentelemetry/sdk-node`: Core SDK for Node.js\n- `@opentelemetry/api`: API for creating custom spans\n- `@opentelemetry/auto-instrumentations-node`: Auto-instrument HTTP, Fastify, etc.\n- `@opentelemetry/exporter-*-otlp-grpc`: Export to Aspire Dashboard via OTLP/gRPC\n\n## Acceptance Criteria\n- [ ] All packages installed without conflicts\n- [ ] TypeScript types available for all packages\n- [ ] No breaking changes to existing dependencies","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-22T14:10:15.596645-06:00","updated_at":"2025-12-23T12:45:38.980894-06:00","closed_at":"2025-12-23T12:45:38.980894-06:00","close_reason":"Closed","labels":["aspire","backend","opentelemetry"],"dependencies":[{"issue_id":"agent-ops-93m.2","depends_on_id":"agent-ops-93m","type":"parent-child","created_at":"2025-12-22T14:10:15.5999-06:00","created_by":"daemon"}]}
{"id":"agent-ops-93m.3","title":"Initialize OpenTelemetry in backend startup","description":"Configure and initialize OpenTelemetry SDK at backend startup, before Fastify server starts.\n\n## Create src/telemetry.ts\n```typescript\nimport { NodeSDK } from '@opentelemetry/sdk-node';\nimport { getNodeAutoInstrumentations } from '@opentelemetry/auto-instrumentations-node';\nimport { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-grpc';\nimport { OTLPMetricExporter } from '@opentelemetry/exporter-metrics-otlp-grpc';\nimport { Resource } from '@opentelemetry/resources';\nimport { ATTR_SERVICE_NAME } from '@opentelemetry/semantic-conventions';\n\nconst sdk = new NodeSDK({\n  resource: new Resource({\n    [ATTR_SERVICE_NAME]: process.env.OTEL_SERVICE_NAME || 'agent-ops-backend',\n  }),\n  traceExporter: new OTLPTraceExporter({\n    url: process.env.OTEL_EXPORTER_OTLP_ENDPOINT || 'http://localhost:4317',\n  }),\n  metricReader: new OTLPMetricExporter({\n    url: process.env.OTEL_EXPORTER_OTLP_ENDPOINT || 'http://localhost:4317',\n  }),\n  instrumentations: [getNodeAutoInstrumentations()],\n});\n\nexport function initTelemetry() {\n  sdk.start();\n  process.on('SIGTERM', () =\u003e sdk.shutdown());\n}\n```\n\n## Update src/index.ts\nImport and call `initTelemetry()` BEFORE creating Fastify instance.\n\n## Environment Variables (auto-injected by Aspire)\n- OTEL_SERVICE_NAME\n- OTEL_EXPORTER_OTLP_ENDPOINT\n\n## Acceptance Criteria\n- [ ] Telemetry initializes without errors\n- [ ] HTTP requests appear as traces in Aspire Dashboard\n- [ ] Graceful shutdown on SIGTERM","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-22T14:10:30.057378-06:00","updated_at":"2025-12-23T12:45:39.193703-06:00","closed_at":"2025-12-23T12:45:39.193703-06:00","close_reason":"Closed","labels":["aspire","backend","opentelemetry"],"dependencies":[{"issue_id":"agent-ops-93m.3","depends_on_id":"agent-ops-93m","type":"parent-child","created_at":"2025-12-22T14:10:30.060164-06:00","created_by":"daemon"},{"issue_id":"agent-ops-93m.3","depends_on_id":"agent-ops-93m.2","type":"blocks","created_at":"2025-12-22T14:10:30.061485-06:00","created_by":"daemon"}]}
{"id":"agent-ops-93m.4","title":"Refactor ObservabilityService for OpenTelemetry spans","description":"Refactor ObservabilityService to emit OpenTelemetry spans in addition to SQLite traces. Keep SQLite for domain-specific aggregation queries.\n\n## Approach: Dual Output\n1. **OpenTelemetry spans** → Aspire Dashboard visualization\n2. **SQLite traces** → Domain queries (cost summaries, tool stats)\n\n## Changes to ObservabilityService\n\n### Add tracer instance\n```typescript\nimport { trace, SpanKind, SpanStatusCode } from '@opentelemetry/api';\n\nconst tracer = trace.getTracer('agent-ops');\n```\n\n### Modify recordTrace() to emit OTEL span\n```typescript\nasync recordTrace(trace: Omit\u003cNewTrace, 'id' | 'timestamp'\u003e): Promise\u003cTrace\u003e {\n  // Emit OTEL span\n  const span = tracer.startSpan(trace.eventType, {\n    kind: SpanKind.INTERNAL,\n    attributes: {\n      'agent.worker_id': trace.workerId ?? undefined,\n      'agent.work_item_id': trace.workItemId ?? undefined,\n      ...flattenData(trace.data),\n    },\n  });\n  span.end();\n\n  // Also write to SQLite for queries\n  // ... existing SQLite insert logic ...\n}\n```\n\n### Add helper for custom spans\n```typescript\nstartAgentSpan(name: string, workerId: string): Span {\n  return tracer.startSpan(name, {\n    attributes: { 'agent.worker_id': workerId },\n  });\n}\n```\n\n## What to Keep in SQLite\n- getCostSummary() - domain-specific aggregation\n- getToolCallStats() - per-tool breakdown\n- getSystemMetrics() - worker aggregations\n- getTraceStatsByEventType() - event distribution\n\n## Acceptance Criteria\n- [ ] All trace events appear in Aspire Dashboard\n- [ ] SQLite queries still work for aggregations\n- [ ] Tool calls show as child spans of agent operations\n- [ ] Errors have proper OTEL status codes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T14:10:48.758777-06:00","updated_at":"2025-12-23T12:55:49.210671-06:00","closed_at":"2025-12-23T12:55:49.210671-06:00","close_reason":"Refactored ObservabilityService to emit OpenTelemetry spans. Added tracer instance, modified recordTrace() to emit OTEL spans in addition to SQLite, added flattenData() helper, and added startAgentSpan() method. All SQLite query methods remain unchanged. All 53 tests passing, build successful.","labels":["aspire","backend","opentelemetry","refactor"],"dependencies":[{"issue_id":"agent-ops-93m.4","depends_on_id":"agent-ops-93m","type":"parent-child","created_at":"2025-12-22T14:10:48.761593-06:00","created_by":"daemon"},{"issue_id":"agent-ops-93m.4","depends_on_id":"agent-ops-93m.3","type":"blocks","created_at":"2025-12-22T14:10:48.762972-06:00","created_by":"daemon"}]}
{"id":"agent-ops-93m.5","title":"Update environment configuration for Aspire","description":"Update environment configuration to use Aspire-injected values instead of hardcoded defaults.\n\n## Aspire Auto-Injected Variables\nAspire automatically injects these environment variables:\n- `OTEL_SERVICE_NAME` - Service name for telemetry\n- `OTEL_EXPORTER_OTLP_ENDPOINT` - OTLP collector endpoint\n- `services__backend__api__0` - Backend URL for frontend\n\n## Backend Changes (src/config.ts or equivalent)\n```typescript\nexport const config = {\n  port: parseInt(process.env.PORT || '3001'),\n  host: process.env.HOST || '0.0.0.0',\n  // Remove hardcoded OTEL config - use Aspire-injected values\n  // OTEL SDK reads from env automatically\n};\n```\n\n## Frontend Changes\nUpdate API client to use injected backend URL:\n```typescript\nconst API_BASE = import.meta.env.VITE_API_URL \n  || process.env.services__backend__api__0 \n  || 'http://localhost:3001';\n```\n\n## Update AppHost to pass frontend env\n```csharp\nvar frontend = builder.AddViteApp(\"frontend\", \"../frontend\")\n    .WithReference(backend)\n    .WithEnvironment(\"VITE_API_URL\", backend.GetEndpoint(\"api\"));\n```\n\n## Acceptance Criteria\n- [ ] Backend reads OTEL config from environment\n- [ ] Frontend connects to backend via Aspire service discovery\n- [ ] No hardcoded localhost URLs remain\n- [ ] Works in both Aspire-managed and standalone modes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T14:11:03.511642-06:00","updated_at":"2025-12-23T12:53:16.487997-06:00","closed_at":"2025-12-23T12:53:16.487997-06:00","close_reason":"Closed","labels":["aspire","backend","config","frontend"],"dependencies":[{"issue_id":"agent-ops-93m.5","depends_on_id":"agent-ops-93m","type":"parent-child","created_at":"2025-12-22T14:11:03.51486-06:00","created_by":"daemon"},{"issue_id":"agent-ops-93m.5","depends_on_id":"agent-ops-93m.1","type":"blocks","created_at":"2025-12-22T14:11:03.516283-06:00","created_by":"daemon"}]}
{"id":"agent-ops-93m.6","title":"Remove Makefile orchestration","description":"Remove the Makefile-based orchestration now that Aspire handles service startup.\n\n## Files to Remove/Modify\n\n### Delete\n- `Makefile` (orchestration replaced by Aspire)\n\n### Keep useful npm scripts in package.json\nBackend package.json:\n```json\n{\n  \"scripts\": {\n    \"dev\": \"tsx watch src/index.ts\",\n    \"build\": \"tsc\",\n    \"start\": \"node dist/index.js\",\n    \"test\": \"vitest\",\n    \"db:push\": \"drizzle-kit push\",\n    \"db:studio\": \"drizzle-kit studio\"\n  }\n}\n```\n\nFrontend package.json:\n```json\n{\n  \"scripts\": {\n    \"dev\": \"vite\",\n    \"build\": \"vite build\",\n    \"preview\": \"vite preview\"\n  }\n}\n```\n\n## New Workflow\n```bash\n# Start everything with Aspire\ndotnet run --project AppHost\n\n# Individual service dev (if needed)\ncd backend \u0026\u0026 npm run dev\ncd frontend \u0026\u0026 npm run dev\n\n# Database operations\ncd backend \u0026\u0026 npm run db:push\n```\n\n## Acceptance Criteria\n- [ ] Makefile deleted\n- [ ] npm scripts work independently\n- [ ] README updated with new workflow\n- [ ] No orphaned PID files in /tmp","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-22T14:11:17.235982-06:00","updated_at":"2025-12-23T12:57:31.848159-06:00","closed_at":"2025-12-23T12:57:31.848159-06:00","close_reason":"Closed","labels":["cleanup","infrastructure"],"dependencies":[{"issue_id":"agent-ops-93m.6","depends_on_id":"agent-ops-93m","type":"parent-child","created_at":"2025-12-22T14:11:17.239551-06:00","created_by":"daemon"},{"issue_id":"agent-ops-93m.6","depends_on_id":"agent-ops-93m.1","type":"blocks","created_at":"2025-12-22T14:11:17.240836-06:00","created_by":"daemon"},{"issue_id":"agent-ops-93m.6","depends_on_id":"agent-ops-93m.5","type":"blocks","created_at":"2025-12-22T14:11:17.241388-06:00","created_by":"daemon"}]}
{"id":"agent-ops-93m.7","title":"Test Aspire integration end-to-end","description":"Verify the complete Aspire integration works end-to-end.\n\n## Test Scenarios\n\n### 1. Service Startup\n```bash\ndotnet run --project AppHost\n```\n- [ ] Backend starts on port 3001\n- [ ] Frontend starts on Vite dev server\n- [ ] Aspire Dashboard accessible at http://localhost:15888\n\n### 2. Aspire Dashboard Verification\n- [ ] Both services appear in Resources view\n- [ ] Service endpoints listed correctly\n- [ ] Environment variables visible\n\n### 3. Telemetry Flow\n- [ ] Make HTTP request to backend\n- [ ] Verify trace appears in Dashboard Traces view\n- [ ] Check span attributes include service name\n\n### 4. Custom Spans (Agent Operations)\n- [ ] Trigger agent state change\n- [ ] Verify custom span in Dashboard\n- [ ] Check worker_id attribute present\n\n### 5. Error Handling\n- [ ] Trigger an error condition\n- [ ] Verify error span has ERROR status\n- [ ] Check error details in span attributes\n\n### 6. Metrics\n- [ ] Verify runtime metrics in Dashboard\n- [ ] Check HTTP request metrics\n\n### 7. Graceful Shutdown\n- [ ] Stop Aspire (Ctrl+C)\n- [ ] Verify clean shutdown (no orphan processes)\n- [ ] Check final telemetry flushed\n\n## Acceptance Criteria\n- [ ] All test scenarios pass\n- [ ] No console errors during operation\n- [ ] Telemetry latency acceptable (\u003c100ms)\n- [ ] Memory usage stable over time","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T14:11:32.24349-06:00","updated_at":"2025-12-23T14:38:12.680203-06:00","closed_at":"2025-12-23T14:38:12.680203-06:00","close_reason":"Closed","labels":["aspire","integration","testing"],"dependencies":[{"issue_id":"agent-ops-93m.7","depends_on_id":"agent-ops-93m","type":"parent-child","created_at":"2025-12-22T14:11:32.247476-06:00","created_by":"daemon"},{"issue_id":"agent-ops-93m.7","depends_on_id":"agent-ops-93m.4","type":"blocks","created_at":"2025-12-22T14:11:32.248899-06:00","created_by":"daemon"},{"issue_id":"agent-ops-93m.7","depends_on_id":"agent-ops-93m.5","type":"blocks","created_at":"2025-12-22T14:11:32.249591-06:00","created_by":"daemon"}]}
{"id":"agent-ops-avw","title":"Phase 4: Agent Integration","description":"Integrate Claude Agent SDK with agent manager service, trace/pause hooks, and built-in YAML templates for refiner, implementer, tester, and reviewer agents.","status":"closed","priority":3,"issue_type":"epic","created_at":"2025-12-20T22:44:00.166505-06:00","updated_at":"2025-12-24T11:01:51.424076-06:00","closed_at":"2025-12-24T11:01:51.424076-06:00","close_reason":"Superseded by agent-ops-4ka (provider-agnostic approach)","labels":["backend","claude-sdk"],"dependencies":[{"issue_id":"agent-ops-avw","depends_on_id":"agent-ops-7vk","type":"blocks","created_at":"2025-12-20T22:47:28.564613-06:00","created_by":"daemon"}]}
{"id":"agent-ops-avw.1","title":"Implement Agent manager service","description":"Create src/services/agent-manager.service.ts to spawn, manage, and terminate Claude Agent SDK instances with proper configuration from templates.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:46:03.948583-06:00","updated_at":"2025-12-23T20:18:50.46798-06:00","labels":["backend","claude-sdk","services"],"dependencies":[{"issue_id":"agent-ops-avw.1","depends_on_id":"agent-ops-avw","type":"parent-child","created_at":"2025-12-20T22:46:03.951174-06:00","created_by":"daemon"}]}
{"id":"agent-ops-avw.2","title":"Implement trace hook","description":"Create src/hooks/trace.hook.ts for Claude Agent SDK to capture tool calls, token usage, and state changes for observability.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:46:05.345262-06:00","updated_at":"2025-12-23T20:18:50.699891-06:00","labels":["backend","claude-sdk","hooks"],"dependencies":[{"issue_id":"agent-ops-avw.2","depends_on_id":"agent-ops-avw","type":"parent-child","created_at":"2025-12-20T22:46:05.348616-06:00","created_by":"daemon"}]}
{"id":"agent-ops-avw.3","title":"Implement pause hook","description":"Create src/hooks/pause.hook.ts for Claude Agent SDK to support pausing/resuming agent execution on demand.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:46:06.498876-06:00","updated_at":"2025-12-23T20:18:50.945405-06:00","labels":["backend","claude-sdk","hooks"],"dependencies":[{"issue_id":"agent-ops-avw.3","depends_on_id":"agent-ops-avw","type":"parent-child","created_at":"2025-12-20T22:46:06.501947-06:00","created_by":"daemon"}]}
{"id":"agent-ops-avw.4","title":"Create Refiner template YAML","description":"Create src/templates/refiner.yaml with system prompt, permission mode, and tools for spec refinement agent.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:46:07.817133-06:00","updated_at":"2025-12-23T20:18:51.186519-06:00","labels":["backend","templates"],"dependencies":[{"issue_id":"agent-ops-avw.4","depends_on_id":"agent-ops-avw","type":"parent-child","created_at":"2025-12-20T22:46:07.819773-06:00","created_by":"daemon"}]}
{"id":"agent-ops-avw.5","title":"Create Implementer template YAML","description":"Create src/templates/implementer.yaml with system prompt, permission mode (acceptEdits), and tools for code implementation agent.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:46:09.024097-06:00","updated_at":"2025-12-23T20:18:51.424916-06:00","labels":["backend","templates"],"dependencies":[{"issue_id":"agent-ops-avw.5","depends_on_id":"agent-ops-avw","type":"parent-child","created_at":"2025-12-20T22:46:09.027293-06:00","created_by":"daemon"}]}
{"id":"agent-ops-avw.6","title":"Create Tester template YAML","description":"Create src/templates/tester.yaml with system prompt, permission mode, and tools for QA testing agent.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:46:11.462785-06:00","updated_at":"2025-12-23T20:18:51.671139-06:00","labels":["backend","templates"],"dependencies":[{"issue_id":"agent-ops-avw.6","depends_on_id":"agent-ops-avw","type":"parent-child","created_at":"2025-12-20T22:46:11.465369-06:00","created_by":"daemon"}]}
{"id":"agent-ops-avw.7","title":"Create Reviewer template YAML","description":"Create src/templates/reviewer.yaml with system prompt, permission mode (askUser), and tools for code review agent.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:46:12.707073-06:00","updated_at":"2025-12-23T20:18:51.900021-06:00","labels":["backend","templates"],"dependencies":[{"issue_id":"agent-ops-avw.7","depends_on_id":"agent-ops-avw","type":"parent-child","created_at":"2025-12-20T22:46:12.709704-06:00","created_by":"daemon"}]}
{"id":"agent-ops-c8a","title":"Phase 2: Agent Runtime","description":"Execute Claude agents against codebases. Handle git operations, agent lifecycle, and work product collection. This is the core execution engine.","status":"closed","priority":0,"issue_type":"epic","created_at":"2025-12-23T20:16:49.720807-06:00","updated_at":"2025-12-23T23:23:48.545493-06:00","closed_at":"2025-12-23T23:23:48.545493-06:00","close_reason":"Closed","labels":["agent","claude-sdk","runtime"]}
{"id":"agent-ops-c8a.1","title":"Git operations service","description":"Service for git operations: clone repo, create branch, stage changes, commit, push. Use simple-git or similar. Handle credentials securely.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-23T20:17:06.053527-06:00","updated_at":"2025-12-23T23:23:47.378336-06:00","closed_at":"2025-12-23T23:23:47.378336-06:00","close_reason":"Closed","labels":["agent","git"],"dependencies":[{"issue_id":"agent-ops-c8a.1","depends_on_id":"agent-ops-c8a","type":"parent-child","created_at":"2025-12-23T20:17:06.056471-06:00","created_by":"daemon"}]}
{"id":"agent-ops-c8a.2","title":"Claude SDK agent executor","description":"Integrate Claude Agent SDK to run agents against cloned repos. Configure agent with work item context, repo path, and tools. Capture agent output/traces.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-23T20:17:08.102399-06:00","updated_at":"2025-12-23T23:23:47.601911-06:00","closed_at":"2025-12-23T23:23:47.601911-06:00","close_reason":"Closed","labels":["agent","claude-sdk"],"dependencies":[{"issue_id":"agent-ops-c8a.2","depends_on_id":"agent-ops-c8a","type":"parent-child","created_at":"2025-12-23T20:17:08.104363-06:00","created_by":"daemon"}]}
{"id":"agent-ops-c8a.3","title":"Workspace manager","description":"Manage isolated workspaces for agent execution. Create temp directories, clone repos, cleanup after completion. Track workspace state and artifacts.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-23T20:17:10.148426-06:00","updated_at":"2025-12-23T23:23:47.864627-06:00","closed_at":"2025-12-23T23:23:47.864627-06:00","close_reason":"Closed","labels":["agent","workspace"],"dependencies":[{"issue_id":"agent-ops-c8a.3","depends_on_id":"agent-ops-c8a","type":"parent-child","created_at":"2025-12-23T20:17:10.149581-06:00","created_by":"daemon"}]}
{"id":"agent-ops-c8a.4","title":"Agent output collector","description":"Collect agent work products: file changes (diff), commit messages, PR description, execution logs. Store for review and PR creation.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-23T20:17:12.20479-06:00","updated_at":"2025-12-23T23:23:48.094517-06:00","closed_at":"2025-12-23T23:23:48.094517-06:00","close_reason":"Closed","labels":["agent","output"],"dependencies":[{"issue_id":"agent-ops-c8a.4","depends_on_id":"agent-ops-c8a","type":"parent-child","created_at":"2025-12-23T20:17:12.206396-06:00","created_by":"daemon"}]}
{"id":"agent-ops-c8a.5","title":"Agent lifecycle hooks","description":"Implement hooks for agent lifecycle: onStart, onToolUse, onPause, onComplete, onError. Enable monitoring and intervention points.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T20:17:14.164303-06:00","updated_at":"2025-12-23T23:23:48.320558-06:00","closed_at":"2025-12-23T23:23:48.320558-06:00","close_reason":"Closed","labels":["agent","hooks"],"dependencies":[{"issue_id":"agent-ops-c8a.5","depends_on_id":"agent-ops-c8a","type":"parent-child","created_at":"2025-12-23T20:17:14.166952-06:00","created_by":"daemon"}]}
{"id":"agent-ops-em3","title":"Phase 3: Orchestration","description":"Coordinate agent assignment, queue management, progress tracking, and error handling. Build on existing workflow engine and worker pool services.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-23T20:17:25.357741-06:00","updated_at":"2025-12-24T07:05:40.940432-06:00","closed_at":"2025-12-24T07:05:40.940432-06:00","close_reason":"Closed","labels":["orchestration","workflow"]}
{"id":"agent-ops-em3.1","title":"Work item queue manager","description":"Manage queue of work items ready for agent processing. Prioritization, deduplication, dependency ordering. Integrate with existing WorkItem service.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T20:17:41.392116-06:00","updated_at":"2025-12-24T00:53:40.807538-06:00","closed_at":"2025-12-24T00:53:40.807538-06:00","close_reason":"Closed","labels":["orchestration","queue"],"dependencies":[{"issue_id":"agent-ops-em3.1","depends_on_id":"agent-ops-em3","type":"parent-child","created_at":"2025-12-23T20:17:41.393348-06:00","created_by":"daemon"}]}
{"id":"agent-ops-em3.2","title":"Agent assignment logic","description":"Match work items to available agents based on: agent capabilities, workload, repo familiarity. Extend existing worker pool service.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T20:17:43.364299-06:00","updated_at":"2025-12-24T01:20:53.457269-06:00","closed_at":"2025-12-24T01:20:53.457269-06:00","close_reason":"Closed","labels":["assignment","orchestration"],"dependencies":[{"issue_id":"agent-ops-em3.2","depends_on_id":"agent-ops-em3","type":"parent-child","created_at":"2025-12-23T20:17:43.365453-06:00","created_by":"daemon"}]}
{"id":"agent-ops-em3.3","title":"Progress tracking","description":"Track agent progress on work items: started, in-progress milestones, blocked, completed, failed. Update WorkItem status, emit events for UI.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T20:17:46.829916-06:00","updated_at":"2025-12-24T01:49:58.303551-06:00","closed_at":"2025-12-24T01:49:58.303551-06:00","close_reason":"Closed","labels":["progress","status"],"dependencies":[{"issue_id":"agent-ops-em3.3","depends_on_id":"agent-ops-em3","type":"parent-child","created_at":"2025-12-23T20:17:46.83154-06:00","created_by":"daemon"}]}
{"id":"agent-ops-em3.4","title":"Error handling and retries","description":"Handle agent failures gracefully: categorize errors, implement retry logic with backoff, escalate persistent failures. Log for debugging.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T20:17:49.013126-06:00","updated_at":"2025-12-24T02:05:59.181636-06:00","closed_at":"2025-12-24T02:05:59.181636-06:00","close_reason":"Closed","labels":["errors","retry"],"dependencies":[{"issue_id":"agent-ops-em3.4","depends_on_id":"agent-ops-em3","type":"parent-child","created_at":"2025-12-23T20:17:49.014529-06:00","created_by":"daemon"}]}
{"id":"agent-ops-em3.5","title":"Concurrent agent limits","description":"Manage concurrent agent execution limits: per-repo, per-user, global. Prevent resource exhaustion and API rate limiting issues.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T20:17:51.129639-06:00","updated_at":"2025-12-24T02:27:52.021537-06:00","closed_at":"2025-12-24T02:27:52.021537-06:00","close_reason":"Closed","labels":["concurrency","limits"],"dependencies":[{"issue_id":"agent-ops-em3.5","depends_on_id":"agent-ops-em3","type":"parent-child","created_at":"2025-12-23T20:17:51.131206-06:00","created_by":"daemon"}]}
{"id":"agent-ops-kpr","title":"Phase 4: Visibility","description":"Minimal UI for monitoring agent work: status dashboard, execution logs, PR links. Keep it simple - focus on observability over interaction.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-23T20:18:01.517908-06:00","updated_at":"2025-12-24T11:01:51.228954-06:00","closed_at":"2025-12-24T11:01:51.228954-06:00","close_reason":"Superseded by agent-ops-4ka (Local Agent Dashboard MVP)","labels":["monitoring","ui","visibility"]}
{"id":"agent-ops-kpr.1","title":"Status dashboard","description":"Simple dashboard showing: connected repos, active agents, work items by status, recent completions. Real-time updates via existing WebSocket.","design":"# Implementation Plan: Status Dashboard (agent-ops-kpr.1)\n\n## Overview\n\nImplement a real-time status dashboard that displays connected repositories, active agents, work items by status, and recent completions. The solution uses a hybrid REST + WebSocket approach leveraging existing infrastructure with no new dependencies required.\n\n## FACTS Validation Summary\n\n- **Feasibility**: HIGH - All libraries already installed (React Query, react-use-websocket, Fastify WebSocket). Existing patterns in codebase to follow. Database schema already has required fields.\n- **Atomicity**: HIGH - Each task is independently completable and verifiable. Tasks are sized for 15-45 minute completion.\n- **Clarity**: HIGH - Tasks include specific file paths, line references, and code patterns to follow. Pattern files explicitly referenced.\n- **Testability**: HIGH - Each task has clear acceptance criteria. Tests written before implementation (TDD). AAA pattern enforced.\n- **Scope**: HIGH - Five logical phases with clear boundaries. Each phase produces a committable, testable increment.\n\n## Prerequisites\n\n### Environment Checks (All Should Already Pass)\n\n- [ ] Backend runs: `cd /Users/probinson/Repos/on-par/saas/agent-ops/backend \u0026\u0026 npm run dev`\n- [ ] Frontend runs: `cd /Users/probinson/Repos/on-par/saas/agent-ops/frontend \u0026\u0026 npm run dev`\n- [ ] Tests pass: `cd /Users/probinson/Repos/on-par/saas/agent-ops/backend \u0026\u0026 npm test`\n- [ ] Database has required tables (workItems, repositories, workers, agentExecutions)\n\n### Required Dependencies (Already Installed - Verification Only)\n\n**Backend** (from `/Users/probinson/Repos/on-par/saas/agent-ops/backend/package.json`):\n- `@fastify/websocket` - WebSocket support\n- `drizzle-orm` - ORM\n- `better-sqlite3` - Database\n- `vitest` - Testing\n\n**Frontend** (from `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/package.json`):\n- `@tanstack/react-query` v5.62.8 - Server state\n- `react-use-websocket` v4.11.0 - WebSocket client\n- `tailwindcss` v3.4.17 - Styling\n\n---\n\n## Phase 1: Backend Service Layer\n\n**Goal**: Create the DashboardService that aggregates data from all relevant repositories\n\n**Committable State**: Service tested and ready for handler integration; no external API changes yet\n\n### Tasks\n\n- [ ] **1.1** Create test file for DashboardService - RED\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/dashboard/services/dashboard.service.test.ts`\n  - Pattern: Follow `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/containers/tests/container-manager.service.test.ts`\n  - Write test: `should aggregate repository counts by sync status`\n  - Write test: `should aggregate worker counts by status`\n  - Write test: `should return work items grouped by status`\n  - Write test: `should return recent completions from last 24 hours`\n  - Write test: `should return recent agent executions (limit 20)`\n  - Write test: `should cache stats for 5 seconds`\n  - All tests should fail initially (no implementation)\n\n- [ ] **1.2** Create DashboardService class - GREEN\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/dashboard/services/dashboard.service.ts`\n  - Pattern: Follow `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/containers/services/container-manager.service.ts`\n  - Constructor accepts: `db: DrizzleDatabase`\n  - Method: `async getStats(): Promise\u003cDashboardStats\u003e`\n  - Implement 5-second TTL caching\n  - Use existing repository classes for data access\n  - Run tests - all should pass\n\n- [ ] **1.3** [P] Create DashboardStats type definition\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/dashboard/types/dashboard.types.ts`\n  - Define interface matching research doc (lines 313-334):\n    ```typescript\n    export interface DashboardStats {\n      repositories: { total: number; syncing: number; synced: number; error: number; items: Repository[] };\n      agents: { total: number; active: number; idle: number; working: number; error: number; items: Worker[] };\n      workItems: { byStatus: Record\u003cWorkItemStatus, number\u003e; recentCompletions: WorkItem[] };\n      recentActivity: AgentExecution[];\n    }\n    ```\n\n- [ ] **1.4** Add `findRecent()` method to AgentExecutionRepository\n  - Modify `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/agent-runtime/repositories/agent-execution.repository.ts`\n  - First, add test to `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/agent-runtime/tests/agent-execution.repository.test.ts`:\n    ```typescript\n    it('should return recent executions ordered by completedAt desc', async () =\u003e { ... });\n    ```\n  - Implement method: `async findRecent(limit: number = 20): Promise\u003cAgentExecution[]\u003e`\n  - Order by `completedAt` descending, filter for completed status\n\n- [ ] **1.5** Add `findAll()` and `countByStatus()` methods to WorkerRepository\n  - Modify `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/workers/repositories/worker.repository.ts`\n  - Pattern: Follow WorkItemRepository.countByStatus() at lines 263-285\n  - First write test, then implement:\n    ```typescript\n    async findAll(): Promise\u003cWorker[]\u003e\n    async countByStatus(): Promise\u003cRecord\u003cWorkerStatus, number\u003e\u003e\n    ```\n\n- [ ] **1.6** REFACTOR - Review and clean up service implementation\n  - Ensure proper error handling with try/catch blocks\n  - Add JSDoc comments to all public methods\n  - Verify TypeScript types are strict (no `any`)\n  - Run full test suite: `npm test -- --filter dashboard`\n\n---\n\n## Phase 2: Backend REST Handler\n\n**Goal**: Create REST endpoint that serves dashboard statistics\n\n**Committable State**: `/api/dashboard/stats` endpoint working and tested\n\n### Tasks\n\n- [ ] **2.1** Create handler test file - RED\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/dashboard/handler/dashboard.handler.test.ts`\n  - Pattern: Follow `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/containers/tests/container.handler.test.ts`\n  - Write test: `GET /api/dashboard/stats should return 200 with stats object`\n  - Write test: `GET /api/dashboard/stats should include all required fields`\n  - Write test: `GET /api/dashboard/stats should handle database errors gracefully`\n  - Tests should fail (no implementation yet)\n\n- [ ] **2.2** Create dashboard handler - GREEN\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/dashboard/handler/dashboard.handler.ts`\n  - Pattern: Follow `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/containers/handler/container.handler.ts`\n  - Implement Fastify plugin with `GET /` route\n  - Inject DashboardService\n  - Return DashboardStats as JSON\n  - Handle errors with proper status codes\n  - Run tests - all should pass\n\n- [ ] **2.3** Register handler in app.ts\n  - Modify `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/app.ts`\n  - Add import: `import { dashboardHandler } from \"./features/dashboard/handler/dashboard.handler.js\";`\n  - Register after line 120 (after container routes):\n    ```typescript\n    await app.register(dashboardHandler, {\n      prefix: \"/api/dashboard\",\n      db,\n    });\n    ```\n\n- [ ] **2.4** Manual verification with curl/httpie\n  - Start backend: `cd /Users/probinson/Repos/on-par/saas/agent-ops/backend \u0026\u0026 npm run dev`\n  - Test endpoint: `curl http://localhost:3001/api/dashboard/stats | jq`\n  - Verify response structure matches DashboardStats interface\n  - Verify response time \u003c200ms\n\n---\n\n## Phase 3: Backend WebSocket Handler\n\n**Goal**: Create WebSocket endpoint for real-time dashboard updates\n\n**Committable State**: WebSocket endpoint accepts connections and receives events from existing WebSocketHubService\n\n### Tasks\n\n- [ ] **3.1** Create WebSocket handler test file - RED\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/dashboard/handler/websocket.handler.test.ts`\n  - Pattern: Review existing WebSocket tests or container.handler.test.ts for structure\n  - Write test: `should accept WebSocket connections`\n  - Write test: `should register client with WebSocketHubService`\n  - Write test: `should unregister client on disconnect`\n  - Write test: `should receive broadcast events`\n\n- [ ] **3.2** Create WebSocket handler - GREEN\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/dashboard/handler/websocket.handler.ts`\n  - Pattern: Follow `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/containers/handler/container.handler.ts` (lines 353-437)\n  - Implement Fastify WebSocket route at `/ws`\n  - Register client with \"all\" channel for broadcasts\n  - Handle connection close gracefully\n  - Run tests - all should pass\n\n- [ ] **3.3** Register WebSocket handler in app.ts\n  - Modify `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/app.ts`\n  - Add import for WebSocket handler\n  - Register with prefix: `/api/dashboard`\n  - Ensure WebSocketHubService is passed if available\n\n- [ ] **3.4** [P] Verify existing broadcast events work\n  - Check `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/shared/websocket/websocket-hub.service.ts` (if exists)\n  - Verify these events are broadcast:\n    - `agent:state_changed`\n    - `work_item:updated`\n    - `metrics:updated`\n  - If not found, create simple broadcast method\n\n- [ ] **3.5** Manual WebSocket verification\n  - Use wscat or browser DevTools to connect\n  - Verify connection establishes successfully\n  - Verify events received when agent state changes\n\n---\n\n## Phase 4: Frontend Data Layer\n\n**Goal**: Create React hooks for fetching dashboard data and handling WebSocket\n\n**Committable State**: Hooks tested and working; can be imported into components\n\n### Tasks\n\n- [ ] **4.1** Create dashboard types\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/types/dashboard.ts`\n  - Pattern: Follow `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/types/container.ts`\n  - Define types matching backend DashboardStats:\n    ```typescript\n    export interface DashboardStats { ... }\n    export interface RepositorySummary { ... }\n    export interface AgentSummary { ... }\n    export type WorkItemStatus = 'backlog' | 'ready' | 'in_progress' | 'review' | 'done';\n    ```\n\n- [ ] **4.2** Add WS_BASE to API config\n  - Modify `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/lib/api.ts`\n  - Add after line 6:\n    ```typescript\n    const WS_BASE = API_BASE.replace(/^http/, 'ws');\n    export { API_BASE, WS_BASE };\n    ```\n\n- [ ] **4.3** Create hook test file - RED\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/hooks/use-dashboard.test.ts`\n  - Pattern: Follow standard React Query hook testing patterns\n  - Write test: `useDashboardStats should fetch stats on mount`\n  - Write test: `useDashboardStats should handle errors`\n  - Write test: `useDashboardStats should refetch every 30 seconds`\n  - Write test: `useDashboardWebSocket should invalidate queries on message`\n  - Tests should fail (no implementation)\n\n- [ ] **4.4** Create useDashboardStats hook - GREEN\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/hooks/use-dashboard.ts`\n  - Pattern: Follow `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/hooks/use-containers.ts`\n  - Implement query key: `['dashboard', 'stats']`\n  - Implement fetch function with proper error handling\n  - Set refetchInterval: 30000 (fallback polling)\n  - Set staleTime: 10000\n  - Export hook and query keys\n\n- [ ] **4.5** Create useDashboardWebSocket hook - GREEN\n  - Add to `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/hooks/use-dashboard.ts`\n  - Use react-use-websocket with reconnection config\n  - Invalidate `['dashboard']` queries on message\n  - Implement exponential backoff reconnection\n  - Return readyState for connection status display\n\n- [ ] **4.6** REFACTOR and verify all tests pass\n  - Run: `cd /Users/probinson/Repos/on-par/saas/agent-ops/frontend \u0026\u0026 npm test`\n  - Add JSDoc comments to exported hooks\n  - Ensure proper TypeScript types throughout\n\n---\n\n## Phase 5: UI Integration and Polish\n\n**Goal**: Replace mock data with real data, add loading/error states, ensure production quality\n\n**Committable State**: Dashboard fully functional with real-time updates, accessible, and documented\n\n### Tasks\n\n- [ ] **5.1** Create Dashboard component test file\n  - Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/pages/Dashboard.test.tsx`\n  - Write test: `should show loading spinner initially`\n  - Write test: `should display stats when loaded`\n  - Write test: `should show error state on fetch failure`\n  - Write test: `should display connection status indicator`\n\n- [ ] **5.2** Remove mock data from Dashboard.tsx\n  - Modify `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/pages/Dashboard.tsx`\n  - Delete lines 21-206 (mock data constants)\n  - Keep lines 207-615 (component implementations)\n  - Import hooks: `import { useDashboardStats, useDashboardWebSocket } from '../hooks/use-dashboard';`\n\n- [ ] **5.3** Integrate hooks into Dashboard component\n  - Modify Dashboard function component (starts around line 538)\n  - Add hook calls at top of component:\n    ```typescript\n    const { data: stats, isLoading, error } = useDashboardStats();\n    const { readyState } = useDashboardWebSocket();\n    ```\n  - Add loading state UI (show spinner when isLoading)\n  - Add error state UI (show error message when error)\n  - Guard render with `if (!stats) return null;`\n\n- [ ] **5.4** Update StatCard to use real data\n  - Modify StatCard usage in Dashboard.tsx\n  - Map real stats to StatCard props:\n    - Active Agents: `stats.agents.active` / `stats.agents.total`\n    - Connected Repos: `stats.repositories.synced` / `stats.repositories.total`\n    - In Progress: `stats.workItems.byStatus.in_progress`\n    - Completed Today: `stats.workItems.recentCompletions.length`\n\n- [ ] **5.5** Update ActiveAgentsGrid to use real data\n  - Modify ActiveAgentsGrid component (lines 357-414)\n  - Change to accept `agents` prop: `({ agents }: { agents: Worker[] })`\n  - Map `stats.agents.items` to component\n  - Handle empty state (no agents)\n\n- [ ] **5.6** Update LiveActivityFeed to use real data\n  - Modify LiveActivityFeed component (lines 416-484)\n  - Change to accept `activities` prop: `({ activities }: { activities: AgentExecution[] })`\n  - Map `stats.recentActivity` to component\n  - Format timestamps with relative time\n\n- [ ] **5.7** Add connection status indicator to header\n  - Modify header section in Dashboard (around line 548)\n  - Add status indicator using `readyState`:\n    ```typescript\n    \u003cdiv className={`h-2 w-2 rounded-full ${\n      readyState === WebSocket.OPEN ? 'bg-green-500' : 'bg-gray-400'\n    }`} /\u003e\n    \u003cspan className=\"text-xs\"\u003e\n      {readyState === WebSocket.OPEN ? 'Live' : 'Connecting...'}\n    \u003c/span\u003e\n    ```\n\n- [ ] **5.8** [P] Add React.memo() to card components for performance\n  - Wrap StatCard with React.memo()\n  - Wrap ActiveAgentsGrid with React.memo()\n  - Wrap LiveActivityFeed with React.memo()\n  - Profile for re-render improvements\n\n- [ ] **5.9** [P] Accessibility audit\n  - Add aria-labels to status badges\n  - Ensure keyboard navigation works\n  - Verify color contrast meets WCAG 2.1 AA (4.5:1)\n  - Add sr-only text for icon-only elements\n\n- [ ] **5.10** Final verification and documentation\n  - Run full test suite: `npm test` in both frontend and backend\n  - Manual end-to-end testing:\n    - Load dashboard, verify data appears \u003c2s\n    - Trigger agent state change, verify update \u003c500ms\n    - Kill WebSocket, verify fallback polling works\n  - Add JSDoc comments to all new files\n  - Update any relevant README sections\n\n---\n\n## Validation Checklist\n\n### Functional Requirements\n\n- [ ] Dashboard displays connected repositories with sync status\n- [ ] Dashboard displays active agents with status\n- [ ] Dashboard displays work items grouped by status\n- [ ] Dashboard displays recent completions\n- [ ] Real-time updates work via WebSocket\n- [ ] Fallback to polling when WebSocket disconnects\n\n### Performance Requirements\n\n- [ ] Initial load time \u003c2 seconds\n- [ ] Real-time update latency \u003c500ms\n- [ ] No memory leaks (stable over 1 hour)\n- [ ] Smooth UI (no jank during updates)\n\n### Quality Requirements\n\n- [ ] Test coverage \u003e80% for new code\n- [ ] All tests passing (backend and frontend)\n- [ ] No TypeScript errors\n- [ ] Linter passing\n- [ ] WCAG 2.1 AA compliance\n\n### Production Readiness\n\n- [ ] Error boundaries in place\n- [ ] Loading states implemented\n- [ ] Error states implemented\n- [ ] Connection status visible\n- [ ] Responsive design verified\n\n---\n\n## Appendix: Code Examples\n\n### A1. Backend Service Pattern\n\n```typescript\n// /Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/dashboard/services/dashboard.service.ts\n\nimport type { DrizzleDatabase } from \"../../../shared/db/index.js\";\nimport type { DashboardStats } from \"../types/dashboard.types.js\";\nimport { WorkItemRepository } from \"../../work-items/repositories/work-item.repository.js\";\n// ... other imports\n\nexport class DashboardService {\n  private cache: { data: DashboardStats | null; timestamp: number } = {\n    data: null,\n    timestamp: 0,\n  };\n  private readonly CACHE_TTL_MS = 5000;\n  \n  private workItemRepo: WorkItemRepository;\n  // ... other repositories\n  \n  constructor(db: DrizzleDatabase) {\n    this.workItemRepo = new WorkItemRepository(db);\n    // ... initialize other repos\n  }\n\n  async getStats(): Promise\u003cDashboardStats\u003e {\n    const now = Date.now();\n    \n    // Return cached data if fresh\n    if (this.cache.data \u0026\u0026 now - this.cache.timestamp \u003c this.CACHE_TTL_MS) {\n      return this.cache.data;\n    }\n\n    // Fetch all data in parallel\n    const [workItemsByStatus, recentExecutions] = await Promise.all([\n      this.workItemRepo.countByStatus(),\n      // ... other fetches\n    ]);\n\n    const stats: DashboardStats = {\n      // ... aggregate data\n    };\n\n    // Update cache\n    this.cache = { data: stats, timestamp: now };\n    return stats;\n  }\n}\n```\n\n### A2. Frontend Hook Pattern\n\n```typescript\n// /Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/hooks/use-dashboard.ts\n\nimport { useQuery, useQueryClient } from '@tanstack/react-query';\nimport useWebSocket from 'react-use-websocket';\nimport { API_BASE, WS_BASE } from '../lib/api';\nimport type { DashboardStats } from '../types/dashboard';\n\n// Query keys for cache management\nexport const dashboardKeys = {\n  all: ['dashboard'] as const,\n  stats: () =\u003e [...dashboardKeys.all, 'stats'] as const,\n};\n\nasync function fetchDashboardStats(): Promise\u003cDashboardStats\u003e {\n  const response = await fetch(`${API_BASE}/api/dashboard/stats`);\n  if (!response.ok) {\n    throw new Error('Failed to fetch dashboard stats');\n  }\n  return response.json();\n}\n\nexport function useDashboardStats() {\n  return useQuery({\n    queryKey: dashboardKeys.stats(),\n    queryFn: fetchDashboardStats,\n    refetchInterval: 30000, // Fallback polling\n    staleTime: 10000,\n  });\n}\n\nexport function useDashboardWebSocket() {\n  const queryClient = useQueryClient();\n\n  const { readyState } = useWebSocket(`${WS_BASE}/api/dashboard/ws`, {\n    onMessage: () =\u003e {\n      queryClient.invalidateQueries({ queryKey: dashboardKeys.all });\n    },\n    shouldReconnect: () =\u003e true,\n    reconnectAttempts: 10,\n    reconnectInterval: (attempt) =\u003e Math.min(500 * 2 ** attempt, 30000),\n  });\n\n  return { readyState };\n}\n```\n\n### A3. Test Pattern (AAA)\n\n```typescript\n// Example test following AAA pattern\n\ndescribe('DashboardService', () =\u003e {\n  describe('getStats', () =\u003e {\n    it('should aggregate repository counts by sync status', async () =\u003e {\n      // ARRANGE\n      const db = setupTestDatabase();\n      await seedRepositories(db, [\n        { syncStatus: 'synced' },\n        { syncStatus: 'synced' },\n        { syncStatus: 'syncing' },\n        { syncStatus: 'error' },\n      ]);\n      const service = new DashboardService(db);\n\n      // ACT\n      const stats = await service.getStats();\n\n      // ASSERT\n      expect(stats.repositories.total).toBe(4);\n      expect(stats.repositories.synced).toBe(2);\n      expect(stats.repositories.syncing).toBe(1);\n      expect(stats.repositories.error).toBe(1);\n    });\n\n    it('should cache stats for 5 seconds', async () =\u003e {\n      // ARRANGE\n      const db = setupTestDatabase();\n      const service = new DashboardService(db);\n      const dbSpy = vi.spyOn(db, 'select');\n\n      // ACT\n      await service.getStats();\n      await service.getStats(); // Second call within cache TTL\n\n      // ASSERT\n      expect(dbSpy).toHaveBeenCalledTimes(1); // Only first call hits DB\n    });\n  });\n});\n```\n\n### A4. Handler Pattern\n\n```typescript\n// /Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/dashboard/handler/dashboard.handler.ts\n\nimport type { FastifyInstance, FastifyPluginOptions, FastifyReply } from \"fastify\";\nimport type { DrizzleDatabase } from \"../../../shared/db/index.js\";\nimport { DashboardService } from \"../services/dashboard.service.js\";\n\nexport interface DashboardHandlerOptions extends FastifyPluginOptions {\n  db: DrizzleDatabase;\n}\n\nexport async function dashboardHandler(\n  app: FastifyInstance,\n  options: DashboardHandlerOptions\n): Promise\u003cvoid\u003e {\n  const { db } = options;\n  const service = new DashboardService(db);\n\n  const handleError = (error: unknown, reply: FastifyReply): void =\u003e {\n    if (error instanceof Error) {\n      reply.status(500).send({\n        error: error.message,\n        statusCode: 500,\n      });\n      return;\n    }\n    throw error;\n  };\n\n  // GET /api/dashboard/stats\n  app.get(\"/stats\", async (request, reply) =\u003e {\n    try {\n      const stats = await service.getStats();\n      reply.send(stats);\n    } catch (error) {\n      handleError(error, reply);\n    }\n  });\n}\n```\n\n---\n\n## File Summary\n\n### Files to Create\n\n| File | Purpose |\n|------|---------|\n| `/backend/src/features/dashboard/services/dashboard.service.ts` | Business logic |\n| `/backend/src/features/dashboard/services/dashboard.service.test.ts` | Service tests |\n| `/backend/src/features/dashboard/handler/dashboard.handler.ts` | REST handler |\n| `/backend/src/features/dashboard/handler/dashboard.handler.test.ts` | Handler tests |\n| `/backend/src/features/dashboard/handler/websocket.handler.ts` | WebSocket handler |\n| `/backend/src/features/dashboard/handler/websocket.handler.test.ts` | WebSocket tests |\n| `/backend/src/features/dashboard/types/dashboard.types.ts` | Type definitions |\n| `/frontend/src/types/dashboard.ts` | Frontend types |\n| `/frontend/src/hooks/use-dashboard.ts` | React hooks |\n| `/frontend/src/hooks/use-dashboard.test.ts` | Hook tests |\n| `/frontend/src/pages/Dashboard.test.tsx` | Component tests |\n\n### Files to Modify\n\n| File | Changes |\n|------|---------|\n| `/backend/src/app.ts` | Register dashboard handlers |\n| `/backend/src/features/agent-runtime/repositories/agent-execution.repository.ts` | Add findRecent() |\n| `/backend/src/features/workers/repositories/worker.repository.ts` | Add findAll(), countByStatus() |\n| `/frontend/src/lib/api.ts` | Add WS_BASE export |\n| `/frontend/src/pages/Dashboard.tsx` | Remove mocks, integrate hooks |\n\n---\n\n**Estimated Total Effort**: 3-4 days\n\n**Phase Breakdown**:\n- Phase 1: Backend Service - 4-5 hours\n- Phase 2: Backend REST Handler - 2-3 hours\n- Phase 3: Backend WebSocket - 3-4 hours\n- Phase 4: Frontend Data Layer - 4-5 hours\n- Phase 5: UI Integration - 6-8 hours","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-23T20:18:15.370431-06:00","updated_at":"2025-12-24T18:13:05.42206-06:00","labels":["dashboard","ui"],"dependencies":[{"issue_id":"agent-ops-kpr.1","depends_on_id":"agent-ops-kpr","type":"parent-child","created_at":"2025-12-23T20:18:15.373286-06:00","created_by":"daemon"}],"comments":[{"id":2,"issue_id":"agent-ops-kpr.1","author":"probinson","text":"# Research Document: Status Dashboard (agent-ops-kpr.1)\n\n**Issue**: agent-ops-kpr.1\n**Type**: Feature - Dashboard UI\n**Priority**: P2\n**Research Date**: 2025-12-24\n\n---\n\n## 1. Problem Overview\n\n### Problem Statement\nImplement a real-time status dashboard that provides operational visibility into the agent-ops system. The dashboard must display key metrics and enable monitoring of system health through live updates.\n\n### Key Objectives\n1. **Display Connected Repositories**: Show all repositories currently connected to the system with sync status\n2. **Show Active Agents**: Display currently running agents with their status and metrics\n3. **Work Items by Status**: Present work items grouped by status (backlog, ready, in_progress, review, done)\n4. **Recent Completions**: Highlight recently completed work items and agent executions\n5. **Real-time Updates**: Leverage existing WebSocket infrastructure for live data updates without polling\n\n### Success Criteria\n- Dashboard loads within 2 seconds with initial data\n- Real-time updates reflect within 500ms of backend events\n- UI remains responsive with 100+ work items\n- No page refresh required to see latest data\n- Follows existing design system and architecture patterns\n- Test coverage \u003e80% for new components\n\n---\n\n## 2. Web Research Findings\n\n### Recommended Technical Stack\n\nBased on industry best practices and current (2025) library ecosystem:\n\n#### WebSocket Management: react-use-websocket + React Query\n**Rationale**: Best balance of features, simplicity, and production-readiness\n\n**Key Benefits**:\n- Minimal bandwidth usage through event-based invalidation (send events, not full payloads)\n- Automatic reconnection with exponential backoff\n- Clean integration with React Query for state management\n- Production-tested by major companies (Stripe, Vercel, etc.)\n\n**Implementation Pattern**:\n```typescript\nimport useWebSocket from 'react-use-websocket';\nimport { useQueryClient } from '@tanstack/react-query';\n\nconst useDashboardWebSocket = () =\u003e {\n  const queryClient = useQueryClient();\n\n  const { lastJsonMessage, readyState } = useWebSocket('ws://api/dashboard/ws', {\n    onOpen: () =\u003e console.log('Dashboard connected'),\n    shouldReconnect: () =\u003e true,\n    reconnectAttempts: 10,\n    reconnectInterval: (attemptNumber) =\u003e\n      Math.min(1000 * 2 ** attemptNumber, 30000), // Exponential backoff\n  });\n\n  useEffect(() =\u003e {\n    if (lastJsonMessage) {\n      // Invalidate queries based on event type\n      const { entity } = lastJsonMessage;\n      queryClient.invalidateQueries({ queryKey: [entity] });\n    }\n  }, [lastJsonMessage, queryClient]);\n\n  return { readyState };\n};\n```\n\n**Backend Event Format**:\n```typescript\n// Invalidate specific resource\n{ \"entity\": \"agents\", \"action\": \"updated\", \"id\": \"agent-123\" }\n\n// Invalidate collection\n{ \"entity\": \"workItems\", \"action\": \"created\" }\n\n// Broadcast metrics update\n{ \"entity\": \"dashboard\", \"action\": \"stats_changed\" }\n```\n\n#### Data Display: TanStack Table\n**Rationale**: Headless library providing powerful filtering and grouping for work items\n\n**Key Features**:\n- Built-in grouping by status (primary requirement)\n- Filtering, sorting, pagination out of the box\n- Excellent performance with large datasets (virtualization support)\n- Full TypeScript support\n- No styling opinions - works with existing design system\n\n**Grouping Implementation**:\n```typescript\nimport {\n  useReactTable,\n  getCoreRowModel,\n  getFilteredRowModel,\n  getGroupedRowModel,\n  getExpandedRowModel,\n} from '@tanstack/react-table';\n\nfunction WorkItemsTable({ data }) {\n  const [grouping, setGrouping] = useState(['status']); // Group by status\n\n  const columns = [\n    {\n      id: 'status',\n      accessorKey: 'status',\n      enableGrouping: true,\n      cell: ({ getValue, row }) =\u003e {\n        if (row.getIsGrouped()) {\n          return (\n            \u003cbutton onClick={row.getToggleExpandedHandler()}\u003e\n              {row.getIsExpanded() ? '▼' : '▶'} {getValue()} ({row.subRows.length})\n            \u003c/button\u003e\n          );\n        }\n        return \u003cStatusBadge status={getValue()} /\u003e;\n      },\n    },\n    // ... more columns\n  ];\n\n  const table = useReactTable({\n    data,\n    columns,\n    state: { grouping },\n    onGroupingChange: setGrouping,\n    getCoreRowModel: getCoreRowModel(),\n    getGroupedRowModel: getGroupedRowModel(),\n    getExpandedRowModel: getExpandedRowModel(),\n  });\n\n  return (/* table rendering */);\n}\n```\n\n#### UI Components: shadcn/ui + Tailwind CSS\n**Rationale**: Already in use in the codebase, provides accessible components\n\n**Status Design System** (Industry Standards - AstroUX/Carbon Design):\n- **Red** (`status-error`): Critical/Error/Failed\n- **Yellow** (`status-warning`): Warning/Attention Needed\n- **Green** (`status-active`): Success/Running/Healthy\n- **Blue** (`status-info`): Info/Idle\n- **Gray** (`status-off`): Inactive/Offline/Draft\n\n**Accessibility Requirements**:\n- Never rely on color alone (use icon + color + text)\n- Ensure 4.5:1 contrast ratio minimum\n- Support screen readers with aria-labels\n- Use consistent symbols across status types\n\n**Card Component Pattern**:\n```typescript\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\n\nfunction DashboardCard({ title, value, status, trend }) {\n  return (\n    \u003cCard className=\"card-hover\"\u003e\n      \u003cCardHeader\u003e\n        \u003cdiv className=\"flex items-center justify-between\"\u003e\n          \u003cCardTitle className=\"text-sm font-medium\"\u003e{title}\u003c/CardTitle\u003e\n          {status \u0026\u0026 \u003cBadge variant={status}\u003e{status}\u003c/Badge\u003e}\n        \u003c/div\u003e\n      \u003c/CardHeader\u003e\n      \u003cCardContent\u003e\n        \u003cdiv className=\"text-2xl font-bold font-mono\"\u003e{value}\u003c/div\u003e\n        {trend \u0026\u0026 \u003cp className=\"text-xs text-muted-foreground\"\u003e{trend}\u003c/p\u003e}\n      \u003c/CardContent\u003e\n    \u003c/Card\u003e\n  );\n}\n```\n\n### Best Practices for Real-time Dashboards\n\n#### Performance Optimization\n1. **React.memo()**: Wrap dashboard cards to prevent unnecessary re-renders\n2. **Selective Subscriptions**: Use specific query keys to limit invalidation scope\n3. **Virtualization**: Implement `react-window` for lists \u003e100 items\n4. **Debouncing**: Throttle rapid WebSocket updates with `requestAnimationFrame`\n5. **Stale-While-Revalidate**: Show cached data immediately while fetching fresh data\n\n#### Reconnection Strategy\n```typescript\n// Exponential backoff with jitter\nconst getReconnectInterval = (attemptNumber: number) =\u003e {\n  const baseDelay = 500;\n  const maxDelay = 30000;\n  const jitter = Math.random() * 1000;\n  return Math.min(baseDelay * 2 ** attemptNumber + jitter, maxDelay);\n};\n```\n\n**Key Principles**:\n- Start with 500ms delay\n- Double on each attempt with random jitter (prevents thundering herd)\n- Cap at 30 seconds maximum\n- Reset attempt counter on successful connection\n- Fetch snapshot of current state after reconnection to fill gaps\n\n#### State Synchronization\n1. **On Reconnect**: Fetch full snapshot via REST API to ensure consistency\n2. **Sequence Numbers**: Include message IDs to detect missed updates\n3. **Version Stamps**: Track data version to avoid stale overwrites\n\n#### Security Considerations\n1. **Authentication**: Pass JWT during WebSocket handshake (`ws://url?token=jwt`)\n2. **Always Use WSS**: Encrypted WebSocket in production\n3. **Message Validation**: Validate all incoming WebSocket messages\n4. **Rate Limiting**: Limit reconnection attempts and API calls\n\n### Alternative Approaches Considered\n\n#### Option 1: Server-Sent Events (SSE)\n**Pros**: Simpler unidirectional flow, built-in reconnection\n**Cons**: Less flexible than WebSockets, HTTP/1.1 connection limits\n**Verdict**: WebSocket already exists in codebase - stick with it\n\n#### Option 2: Long Polling\n**Pros**: Works everywhere, no special server support\n**Cons**: Inefficient, higher latency, more server load\n**Verdict**: WebSocket is superior for real-time requirements\n\n#### Option 3: GraphQL Subscriptions\n**Pros**: Type-safe, flexible queries, industry standard\n**Cons**: Requires significant infrastructure changes, overkill for this use case\n**Verdict**: Too heavy for current needs\n\n### Recommended Libraries\n\n| Library | Version | Purpose | Bundle Size |\n|---------|---------|---------|-------------|\n| react-use-websocket | ^4.8.1 | WebSocket management | ~5KB |\n| @tanstack/react-query | ^5.x | Server state management | ~40KB |\n| @tanstack/react-table | ^8.x | Data tables with grouping | ~30KB |\n| shadcn/ui | latest | UI components | Varies (copy-paste) |\n\n**Total Impact**: ~75KB gzipped (minimal for functionality gained)\n\n---\n\n## 3. Codebase Analysis\n\n### Current Architecture\n\nThe application follows **Vertical Slice Architecture**:\n- **Backend**: Fastify + WebSocket support (`@fastify/websocket`)\n- **Frontend**: React + React Router + TanStack Query + Tailwind CSS\n- **Database**: SQLite with Drizzle ORM\n- **Real-time**: WebSocket Hub Service for event broadcasting\n\n### Existing Dashboard Implementation\n\n**File**: `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/pages/Dashboard.tsx` (lines 1-615)\n\n**Current State**: Static mockup with hardcoded data\n- Mock agent data (lines 61-122)\n- Mock work items (lines 171-193)\n- Mock activity feed (lines 125-168)\n- **No API integration** - ready to be replaced with real data\n\n**Reusable Components** (keep these):\n- `StatCard` (lines 210-248) - metric display cards\n- `ThroughputChart` (lines 250-355) - time series visualization\n- `ActiveAgentsGrid` (lines 357-414) - agent status grid\n- `LiveActivityFeed` (lines 416-484) - recent activity list\n- `UpNextQueue` (lines 486-536) - upcoming work queue\n\n### Existing WebSocket Infrastructure\n\n**Service**: `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/shared/websocket/websocket-hub.service.ts`\n\n**Capabilities** (lines 1-360):\n- **Channel-based pub/sub**: Clients subscribe to specific channels (\"all\", \"agents\", \"work-items\")\n- **Event Broadcasting**: Send events to all subscribed clients\n- **Connection Management**: Track active connections, auto-cleanup on disconnect\n\n**Existing Event Types**:\n- `agent:state_changed` - Agent status updates (idle, working, error)\n- `work_item:updated` - Work item changes (status, assignee, etc.)\n- `work_item:progress` - Real-time progress updates (percentage, current step)\n- `metrics:updated` - System metrics changes (tokens used, costs, etc.)\n\n**Helper Methods Available**:\n```typescript\n// From lines 212-320\nnotifyAgentStateChange(workerId, oldState, newState, error?)\nnotifyWorkItemUpdate(workItemId, updates)\nnotifyMetricsUpdate(workerId, metrics)\nnotifyWorkItemProgress(workItemId, progress)\n```\n\n**Frontend WebSocket Setup**: Already has `react-use-websocket` installed (frontend/package.json line 26)\n\n### Affected Files and Components\n\n#### Backend Changes Required\n\n##### 1. Dashboard API Handler (NEW)\n**File**: `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/dashboard/handler/dashboard.handler.ts`\n\n**Pattern Reference**: `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/work-items/handlers/work-items.handler.ts`\n\n**Endpoints to Implement**:\n```typescript\nGET /api/dashboard/stats\nResponse: {\n  repositories: {\n    total: number;\n    syncing: number;\n    synced: number;\n    items: Array\u003c{ fullName: string; syncStatus: string; lastSyncAt: Date }\u003e;\n  };\n  agents: {\n    total: number;\n    active: number;\n    idle: number;\n    working: number;\n    items: Array\u003c{ id: string; status: string; currentWorkItem?: string; metrics: object }\u003e;\n  };\n  workItems: {\n    byStatus: { backlog: number; ready: number; in_progress: number; review: number; done: number };\n    recentCompletions: Array\u003cWorkItem\u003e; // completed in last 24h\n  };\n  recentActivity: Array\u003cAgentExecution\u003e; // last 20 executions\n}\n```\n\n##### 2. Dashboard Service (NEW)\n**File**: `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/dashboard/services/dashboard.service.ts`\n\n**Dependencies Needed**:\n- `RepositoryRepository` - from `/backend/src/features/repositories/repositories/repository.repository.ts`\n- `WorkerRepository` - from `/backend/src/features/workers/repositories/worker.repository.ts`\n- `WorkItemRepository` - from `/backend/src/features/work-items/repositories/work-item.repository.ts`\n- `AgentExecutionRepository` - from `/backend/src/features/agent-runtime/repositories/agent-execution.repository.ts`\n\n**Implementation Notes**:\n- Aggregate data from multiple repositories\n- Filter completed items to last 24 hours using `completedAt` field\n- Limit recent activity to 20 items (configurable)\n- Consider caching for 5-10 seconds to reduce DB load\n\n##### 3. WebSocket Handler Enhancement (NEW)\n**File**: `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/dashboard/handler/websocket.handler.ts`\n\n**Purpose**: Dedicated WebSocket endpoint for dashboard subscriptions\n\n**Implementation**:\n```typescript\nexport async function dashboardWebSocketHandler(\n  app: FastifyInstance,\n  options: { wsHub: WebSocketHubService }\n): Promise\u003cvoid\u003e {\n  app.get('/ws', { websocket: true }, (socket, request) =\u003e {\n    const clientId = crypto.randomUUID();\n\n    // Register client and subscribe to \"all\" channel\n    options.wsHub.registerClient(clientId, socket, ['all']);\n\n    // Send initial state\n    // (could fetch from DashboardService and send as first message)\n\n    socket.on('close', () =\u003e {\n      options.wsHub.unregisterClient(clientId);\n    });\n  });\n}\n```\n\n##### 4. App Registration (MODIFY)\n**File**: `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/app.ts`\n\n**Line**: After line 120 (after other handlers)\n\n**Changes**:\n```typescript\nimport { dashboardHandler } from \"./features/dashboard/handler/dashboard.handler.js\";\nimport { dashboardWebSocketHandler } from \"./features/dashboard/handler/websocket.handler.js\";\n\n// Register REST endpoints\nawait app.register(dashboardHandler, {\n  prefix: \"/api/dashboard\",\n  db,\n});\n\n// Register WebSocket endpoint\nawait app.register(dashboardWebSocketHandler, {\n  prefix: \"/api/dashboard\",\n  wsHub,\n});\n```\n\n##### 5. Repository Enhancements (MODIFY)\n\n**File**: `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/repositories/repositories/repository.repository.ts`\n\n**New Method**:\n```typescript\nasync countByStatus(): Promise\u003cRecord\u003cRepoSyncStatus, number\u003e\u003e {\n  const repos = await this.findAll();\n  return repos.reduce((acc, repo) =\u003e {\n    acc[repo.syncStatus] = (acc[repo.syncStatus] || 0) + 1;\n    return acc;\n  }, {} as Record\u003cRepoSyncStatus, number\u003e);\n}\n```\n\n**File**: `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/agent-runtime/repositories/agent-execution.repository.ts`\n\n**New Method** (if not exists):\n```typescript\nasync findRecent(limit: number = 20): Promise\u003cAgentExecution[]\u003e {\n  return this.db\n    .select()\n    .from(agentExecutions)\n    .where(or(\n      eq(agentExecutions.status, 'success'),\n      eq(agentExecutions.status, 'error')\n    ))\n    .orderBy(desc(agentExecutions.completedAt))\n    .limit(limit);\n}\n```\n\n#### Frontend Changes Required\n\n##### 6. Dashboard Hooks (NEW)\n**File**: `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/hooks/use-dashboard.ts`\n\n**Pattern Reference**: `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/hooks/use-containers.ts`\n\n**Implementation**:\n```typescript\nimport { useQuery, useQueryClient } from '@tanstack/react-query';\nimport useWebSocket from 'react-use-websocket';\nimport { API_BASE, WS_BASE } from '../lib/api';\n\ninterface DashboardStats {\n  repositories: {\n    total: number;\n    syncing: number;\n    synced: number;\n    items: Repository[];\n  };\n  agents: {\n    total: number;\n    active: number;\n    idle: number;\n    working: number;\n    items: Agent[];\n  };\n  workItems: {\n    byStatus: Record\u003cstring, number\u003e;\n    recentCompletions: WorkItem[];\n  };\n  recentActivity: AgentExecution[];\n}\n\nasync function fetchDashboardStats(): Promise\u003cDashboardStats\u003e {\n  const response = await fetch(`${API_BASE}/api/dashboard/stats`);\n  if (!response.ok) {\n    throw new Error('Failed to fetch dashboard stats');\n  }\n  return response.json();\n}\n\nexport function useDashboardStats() {\n  return useQuery({\n    queryKey: ['dashboard', 'stats'],\n    queryFn: fetchDashboardStats,\n    refetchInterval: 30000, // Poll every 30s as fallback\n    staleTime: 10000, // Consider fresh for 10s\n  });\n}\n\nexport function useDashboardWebSocket() {\n  const queryClient = useQueryClient();\n\n  const { lastJsonMessage, readyState } = useWebSocket(\n    `${WS_BASE}/api/dashboard/ws`,\n    {\n      onMessage: () =\u003e {\n        // Invalidate dashboard queries on any message\n        queryClient.invalidateQueries({ queryKey: ['dashboard'] });\n      },\n      shouldReconnect: () =\u003e true,\n      reconnectAttempts: 10,\n      reconnectInterval: 3000,\n    }\n  );\n\n  return { lastJsonMessage, readyState };\n}\n```\n\n##### 7. API Configuration (MODIFY)\n**File**: `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/lib/api.ts`\n\n**Current**: Only exports `API_BASE` (line 6)\n\n**Add**:\n```typescript\nconst WS_BASE = API_BASE.replace(/^http/, 'ws');\nexport { API_BASE, WS_BASE };\n```\n\n##### 8. Dashboard Component Refactor (MODIFY)\n**File**: `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/pages/Dashboard.tsx`\n\n**Changes**:\n1. **Remove Mock Data** (lines 21-206):\n   - Delete all mock agent/work item/activity data\n   - Replace with hooks\n\n2. **Add Hooks** (top of component):\n   ```typescript\n   import { useDashboardStats, useDashboardWebSocket } from '../hooks/use-dashboard';\n\n   function Dashboard() {\n     const { data: stats, isLoading, error } = useDashboardStats();\n     const { readyState } = useDashboardWebSocket();\n\n     if (isLoading) return \u003cLoadingSpinner /\u003e;\n     if (error) return \u003cErrorDisplay error={error} /\u003e;\n     if (!stats) return null;\n\n     // Use stats.agents.items, stats.workItems.byStatus, etc.\n   ```\n\n3. **Keep Existing UI Components** (lines 210-615):\n   - `StatCard` - update with real data\n   - `ThroughputChart` - may need real data source\n   - `ActiveAgentsGrid` - pass `stats.agents.items`\n   - `LiveActivityFeed` - pass `stats.recentActivity`\n   - `UpNextQueue` - pass filtered work items\n\n4. **Add Connection Status Indicator**:\n   ```typescript\n   \u003cdiv className=\"flex items-center gap-2\"\u003e\n     \u003cdiv className={`h-2 w-2 rounded-full ${\n       readyState === WebSocket.OPEN ? 'bg-green-500' : 'bg-gray-400'\n     }`} /\u003e\n     \u003cspan className=\"text-xs text-muted-foreground\"\u003e\n       {readyState === WebSocket.OPEN ? 'Connected' : 'Connecting...'}\n     \u003c/span\u003e\n   \u003c/div\u003e\n   ```\n\n##### 9. Type Definitions (NEW)\n**File**: `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/types/dashboard.ts`\n\n**Purpose**: Shared TypeScript interfaces\n\n**Content**:\n```typescript\nexport interface DashboardStats {\n  repositories: {\n    total: number;\n    syncing: number;\n    synced: number;\n    items: Repository[];\n  };\n  agents: {\n    total: number;\n    active: number;\n    idle: number;\n    working: number;\n    items: Agent[];\n  };\n  workItems: {\n    byStatus: Record\u003cWorkItemStatus, number\u003e;\n    recentCompletions: WorkItem[];\n  };\n  recentActivity: AgentExecution[];\n}\n\nexport interface Repository {\n  id: number;\n  fullName: string;\n  owner: string;\n  name: string;\n  syncStatus: 'pending' | 'syncing' | 'synced' | 'error';\n  syncEnabled: boolean;\n  lastSyncAt?: Date;\n}\n\nexport interface Agent {\n  id: string;\n  status: 'idle' | 'working' | 'error';\n  templateId: string;\n  currentWorkItemId?: string;\n  tokensUsed: number;\n  costUsd: number;\n  metrics?: object;\n}\n\nexport interface WorkItem {\n  id: string;\n  title: string;\n  status: WorkItemStatus;\n  type: string;\n  priority: string;\n  completedAt?: Date;\n  createdAt: Date;\n}\n\nexport type WorkItemStatus = 'backlog' | 'ready' | 'in_progress' | 'review' | 'done';\n\nexport interface AgentExecution {\n  id: string;\n  workerId: string;\n  workItemId: string;\n  status: 'success' | 'error';\n  startedAt: Date;\n  completedAt?: Date;\n  error?: string;\n}\n```\n\n##### 10. Repository Status Component (NEW - Optional)\n**File**: `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/dashboard/RepositoryStatus.tsx`\n\n**Purpose**: Dedicated component for repository display\n\n**Pattern**: Follow `ActiveAgentsGrid` design (lines 357-414 in Dashboard.tsx)\n\n**Implementation**:\n```typescript\ninterface RepositoryStatusProps {\n  repositories: Repository[];\n}\n\nexport function RepositoryStatus({ repositories }: RepositoryStatusProps) {\n  return (\n    \u003cdiv className=\"space-y-2\"\u003e\n      {repositories.map((repo) =\u003e (\n        \u003cdiv key={repo.id} className=\"flex items-center justify-between p-3 bg-card rounded-lg\"\u003e\n          \u003cdiv\u003e\n            \u003cp className=\"font-medium font-mono text-sm\"\u003e{repo.fullName}\u003c/p\u003e\n            {repo.lastSyncAt \u0026\u0026 (\n              \u003cp className=\"text-xs text-muted-foreground\"\u003e\n                Last sync: {formatDistanceToNow(repo.lastSyncAt)} ago\n              \u003c/p\u003e\n            )}\n          \u003c/div\u003e\n          \u003cBadge variant={getSyncStatusVariant(repo.syncStatus)}\u003e\n            {repo.syncStatus}\n          \u003c/Badge\u003e\n        \u003c/div\u003e\n      ))}\n    \u003c/div\u003e\n  );\n}\n```\n\n### Existing Design System to Follow\n\n**CSS Variables** (from `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/index.css`):\n- Colors: `var(--cyan-glow)`, `var(--emerald)`, `var(--bg-card)`, `var(--text-primary)`\n- Status classes: `status-active`, `status-idle`, `status-error`, `status-warning` (lines 246-280)\n- Animations: `animate-fade-in`, `animate-slide-up`, `card-hover`\n- Typography: `font-mono` for data/metrics, Outfit (default) for UI text\n\n**Component Patterns**:\n- Cards: Rounded corners, subtle borders, hover effects\n- Badges: Small, colored indicators for status\n- Grids: Responsive grid layouts with gap-4\n- Spacing: Consistent padding (p-4, p-6) and margins (space-y-4)\n\n### Current Dependencies (Already Installed)\n\n**Backend** (from `/backend/package.json`):\n- `@fastify/websocket` - WebSocket support ✅\n- `better-sqlite3` - Database ✅\n- `drizzle-orm` - ORM ✅\n\n**Frontend** (from `/frontend/package.json`):\n- `@tanstack/react-query` v5.62.8 - Server state ✅\n- `react-use-websocket` v4.11.0 - WebSocket client ✅\n- `react-router-dom` v7.1.1 - Routing ✅\n- `tailwindcss` v3.4.17 - Styling ✅\n\n**No new dependencies required!** All necessary libraries already installed.\n\n### Integration Points\n\n#### Backend Integration\n1. **Route Registration**: Add dashboard handler to `app.ts` after line 120\n2. **WebSocket Events**: Existing `WebSocketHubService` already broadcasts relevant events\n3. **Database Queries**: Use existing repository pattern - just add new `DashboardService`\n\n#### Frontend Integration\n1. **Query Client**: Already configured in `App.tsx` - just add new hooks\n2. **WebSocket**: Use existing `react-use-websocket` - add new hook\n3. **Routing**: Dashboard already exists at `/` - just enhance component\n4. **Styling**: Use existing Tailwind classes and CSS variables\n\n### Performance Considerations\n\n#### Backend\n1. **Database Query Optimization**:\n   - Use single query with JOINs instead of multiple round trips\n   - Add indexes on frequently queried fields (status, completedAt)\n   - Consider caching dashboard stats for 5-10 seconds\n\n2. **WebSocket Scalability**:\n   - Current implementation handles single-instance\n   - For multi-instance: add Redis Pub/Sub (future enhancement)\n\n#### Frontend\n1. **Re-render Optimization**:\n   - Wrap stat cards in `React.memo()` to prevent unnecessary re-renders\n   - Use selective state subscriptions\n\n2. **Large Dataset Handling**:\n   - Implement pagination for work items table (if \u003e100 items)\n   - Consider `react-window` for virtualization (if \u003e500 items)\n\n3. **WebSocket Update Throttling**:\n   - Debounce rapid updates with `requestAnimationFrame`\n   - Batch multiple events within 100ms window\n\n### Security \u0026 Error Handling\n\n#### Backend\n- **Error Handling**: Wrap all service calls in try/catch, return 500 with error message\n- **Input Validation**: Validate query parameters (limit, offset) to prevent abuse\n- **Rate Limiting**: Consider adding rate limit to `/api/dashboard/stats` (future enhancement)\n\n#### Frontend\n- **Error Boundaries**: Wrap Dashboard in error boundary to catch render errors\n- **Loading States**: Show skeleton loading for better UX\n- **Fallback Polling**: If WebSocket fails, fall back to 30s polling\n- **Connection Status**: Display WebSocket connection state to user\n\n---\n\n## 4. Proposed Solution Approach\n\n### High-Level Strategy\n\n**Architecture**: Hybrid REST + WebSocket approach\n1. **Initial Load**: Fetch full dashboard snapshot via REST API (`GET /api/dashboard/stats`)\n2. **Real-time Updates**: Subscribe to WebSocket for live events\n3. **Event-Driven Invalidation**: WebSocket events trigger React Query invalidation, which refetches affected data\n4. **Fallback Polling**: 30-second polling as backup if WebSocket disconnects\n\n**Data Flow**:\n```\nBackend Event → WebSocket Hub → Frontend WebSocket Hook →\nQuery Invalidation → React Query Refetch → UI Update\n```\n\n### Implementation Phases\n\n#### Phase 1: Backend API (Day 1)\n**Goal**: Create REST endpoint for dashboard data\n\n**Tasks**:\n1. Create `DashboardService` class\n   - Method: `getStats()` - aggregates data from all repositories\n   - Implements caching (5-10 second TTL)\n\n2. Create `DashboardHandler` Fastify plugin\n   - Endpoint: `GET /api/dashboard/stats`\n   - Error handling and logging\n\n3. Enhance repository methods\n   - `RepositoryRepository.countByStatus()`\n   - `AgentExecutionRepository.findRecent(limit)`\n\n4. Register handler in `app.ts`\n\n5. Write unit tests for service and handler\n\n**Deliverables**:\n- `/api/dashboard/stats` endpoint working\n- Returns aggregated data for all dashboard sections\n- Test coverage \u003e80%\n\n#### Phase 2: WebSocket Integration (Day 1-2)\n**Goal**: Enable real-time updates\n\n**Tasks**:\n1. Create `DashboardWebSocketHandler`\n   - Endpoint: `GET /api/dashboard/ws`\n   - Subscribe clients to \"all\" channel\n   - Send initial state on connect\n\n2. Ensure existing events work for dashboard\n   - `agent:state_changed` already broadcasts\n   - `work_item:updated` already broadcasts\n   - Add `dashboard:stats_changed` for general updates\n\n3. Test WebSocket connectivity and event flow\n\n**Deliverables**:\n- WebSocket endpoint functional\n- Events broadcast to connected clients\n- Reconnection working with exponential backoff\n\n#### Phase 3: Frontend Data Layer (Day 2)\n**Goal**: Fetch and manage dashboard data\n\n**Tasks**:\n1. Create type definitions (`types/dashboard.ts`)\n\n2. Update API config to export `WS_BASE`\n\n3. Create custom hooks:\n   - `useDashboardStats()` - React Query hook for REST data\n   - `useDashboardWebSocket()` - WebSocket connection + query invalidation\n\n4. Write hook tests (mock fetch and WebSocket)\n\n**Deliverables**:\n- Hooks tested and working\n- Data flows from backend to frontend\n- WebSocket invalidation triggers refetch\n\n#### Phase 4: UI Enhancement (Day 2-3)\n**Goal**: Replace mock data with real data\n\n**Tasks**:\n1. Refactor `Dashboard.tsx`:\n   - Remove all mock data (lines 21-206)\n   - Integrate `useDashboardStats()` and `useDashboardWebSocket()`\n   - Add loading/error states\n   - Add connection status indicator\n\n2. Update existing components to use real data:\n   - `StatCard` - show real counts\n   - `ActiveAgentsGrid` - map over `stats.agents.items`\n   - `LiveActivityFeed` - map over `stats.recentActivity`\n   - `UpNextQueue` - filter work items by status\n\n3. Create `RepositoryStatus` component (optional)\n\n4. Apply status design system (colors, badges, icons)\n\n**Deliverables**:\n- Dashboard displays real data\n- Real-time updates working\n- Responsive design maintained\n- Test coverage for component rendering\n\n#### Phase 5: Polish \u0026 Optimization (Day 3)\n**Goal**: Production-ready quality\n\n**Tasks**:\n1. Performance optimization:\n   - Add `React.memo()` to cards\n   - Implement WebSocket update debouncing\n   - Verify no memory leaks\n\n2. Accessibility audit:\n   - Ensure status badges have aria-labels\n   - Verify keyboard navigation\n   - Check color contrast ratios\n\n3. Error handling:\n   - Add error boundaries\n   - Improve error messages\n   - Handle edge cases (empty data, network failures)\n\n4. Documentation:\n   - Add JSDoc comments to hooks\n   - Update README with dashboard features\n   - Document WebSocket event format\n\n**Deliverables**:\n- Production-ready dashboard\n- Accessible and performant\n- Documented for future maintainers\n\n### Key Implementation Steps\n\n#### Step 1: Create Backend Service\n```typescript\n// backend/src/features/dashboard/services/dashboard.service.ts\nexport class DashboardService {\n  private cache: { data: DashboardStats | null; timestamp: number } = {\n    data: null,\n    timestamp: 0,\n  };\n\n  private readonly CACHE_TTL_MS = 5000; // 5 seconds\n\n  constructor(\n    private repoRepository: RepositoryRepository,\n    private workerRepository: WorkerRepository,\n    private workItemRepository: WorkItemRepository,\n    private executionRepository: AgentExecutionRepository\n  ) {}\n\n  async getStats(): Promise\u003cDashboardStats\u003e {\n    const now = Date.now();\n\n    // Return cached data if fresh\n    if (this.cache.data \u0026\u0026 now - this.cache.timestamp \u003c this.CACHE_TTL_MS) {\n      return this.cache.data;\n    }\n\n    // Fetch all data in parallel\n    const [repos, workers, workItemsByStatus, recentExecutions] = await Promise.all([\n      this.repoRepository.findAll(),\n      this.workerRepository.findAll(),\n      this.workItemRepository.countByStatus(),\n      this.executionRepository.findRecent(20),\n    ]);\n\n    // Get recent completions (last 24h)\n    const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);\n    const completedItems = await this.workItemRepository.findAll({\n      status: 'done',\n      completedAfter: oneDayAgo,\n    });\n\n    // Aggregate repository stats\n    const repoStats = repos.reduce(\n      (acc, repo) =\u003e {\n        acc.total++;\n        if (repo.syncStatus === 'syncing') acc.syncing++;\n        if (repo.syncStatus === 'synced') acc.synced++;\n        return acc;\n      },\n      { total: 0, syncing: 0, synced: 0 }\n    );\n\n    // Aggregate worker stats\n    const workerStats = workers.reduce(\n      (acc, worker) =\u003e {\n        acc.total++;\n        if (worker.status === 'active') acc.active++;\n        if (worker.status === 'idle') acc.idle++;\n        if (worker.status === 'working') acc.working++;\n        return acc;\n      },\n      { total: 0, active: 0, idle: 0, working: 0 }\n    );\n\n    const stats = {\n      repositories: { ...repoStats, items: repos },\n      agents: { ...workerStats, items: workers },\n      workItems: {\n        byStatus: workItemsByStatus,\n        recentCompletions: completedItems,\n      },\n      recentActivity: recentExecutions,\n    };\n\n    // Update cache\n    this.cache = { data: stats, timestamp: now };\n\n    return stats;\n  }\n}\n```\n\n#### Step 2: Create Frontend Hooks\n```typescript\n// frontend/src/hooks/use-dashboard.ts\nexport function useDashboardWebSocket() {\n  const queryClient = useQueryClient();\n\n  const { lastJsonMessage, readyState } = useWebSocket(\n    `${WS_BASE}/api/dashboard/ws`,\n    {\n      onMessage: (event) =\u003e {\n        const message = JSON.parse(event.data);\n\n        // Selective invalidation based on event type\n        switch (message.type) {\n          case 'agent:state_changed':\n            queryClient.invalidateQueries({ queryKey: ['dashboard', 'stats'] });\n            break;\n          case 'work_item:updated':\n            queryClient.invalidateQueries({ queryKey: ['dashboard', 'stats'] });\n            break;\n          case 'metrics:updated':\n            queryClient.invalidateQueries({ queryKey: ['dashboard', 'stats'] });\n            break;\n          case 'dashboard:stats_changed':\n            queryClient.invalidateQueries({ queryKey: ['dashboard'] });\n            break;\n        }\n      },\n      shouldReconnect: () =\u003e true,\n      reconnectAttempts: 10,\n      reconnectInterval: (attemptNumber) =\u003e\n        Math.min(500 * 2 ** attemptNumber, 30000), // Exponential backoff\n    }\n  );\n\n  return { lastJsonMessage, readyState };\n}\n```\n\n#### Step 3: Refactor Dashboard Component\n```typescript\n// frontend/src/pages/Dashboard.tsx\nfunction Dashboard() {\n  const { data: stats, isLoading, error } = useDashboardStats();\n  const { readyState } = useDashboardWebSocket();\n\n  if (isLoading) {\n    return (\n      \u003cdiv className=\"flex items-center justify-center h-screen\"\u003e\n        \u003cdiv className=\"animate-spin h-8 w-8 border-4 border-cyan-500 border-t-transparent rounded-full\" /\u003e\n      \u003c/div\u003e\n    );\n  }\n\n  if (error) {\n    return (\n      \u003cdiv className=\"flex items-center justify-center h-screen\"\u003e\n        \u003cdiv className=\"text-red-500\"\u003e\n          Failed to load dashboard: {error.message}\n        \u003c/div\u003e\n      \u003c/div\u003e\n    );\n  }\n\n  if (!stats) return null;\n\n  return (\n    \u003cdiv className=\"p-6 space-y-6\"\u003e\n      {/* Connection Status */}\n      \u003cdiv className=\"flex items-center justify-between\"\u003e\n        \u003ch1 className=\"text-2xl font-bold\"\u003eDashboard\u003c/h1\u003e\n        \u003cdiv className=\"flex items-center gap-2\"\u003e\n          \u003cdiv\n            className={`h-2 w-2 rounded-full ${\n              readyState === WebSocket.OPEN ? 'bg-green-500 animate-pulse' : 'bg-gray-400'\n            }`}\n          /\u003e\n          \u003cspan className=\"text-xs text-muted-foreground\"\u003e\n            {readyState === WebSocket.OPEN ? 'Live' : 'Connecting...'}\n          \u003c/span\u003e\n        \u003c/div\u003e\n      \u003c/div\u003e\n\n      {/* Stats Grid */}\n      \u003cdiv className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\"\u003e\n        \u003cStatCard\n          title=\"Active Agents\"\n          value={stats.agents.active}\n          total={stats.agents.total}\n          status=\"active\"\n        /\u003e\n        \u003cStatCard\n          title=\"Repositories\"\n          value={stats.repositories.synced}\n          total={stats.repositories.total}\n          status=\"normal\"\n        /\u003e\n        \u003cStatCard\n          title=\"In Progress\"\n          value={stats.workItems.byStatus.in_progress || 0}\n          status=\"info\"\n        /\u003e\n        \u003cStatCard\n          title=\"Completed Today\"\n          value={stats.workItems.recentCompletions.length}\n          status=\"success\"\n        /\u003e\n      \u003c/div\u003e\n\n      {/* Active Agents */}\n      \u003cActiveAgentsGrid agents={stats.agents.items} /\u003e\n\n      {/* Recent Activity */}\n      \u003cLiveActivityFeed activities={stats.recentActivity} /\u003e\n\n      {/* Work Items by Status */}\n      \u003cWorkItemsGrouped items={stats.workItems.byStatus} /\u003e\n    \u003c/div\u003e\n  );\n}\n```\n\n### Technology/Library Choices with Justification\n\n| Technology | Justification | Alternatives Considered |\n|------------|---------------|-------------------------|\n| **react-use-websocket** | Already installed, production-tested, automatic reconnection | Native WebSocket API (too low-level), socket.io (overkill) |\n| **React Query** | Already in use, perfect for server state management, query invalidation | Zustand (manual state sync), Redux (too complex) |\n| **TanStack Table** | Best-in-class for grouping/filtering work items | AG Grid (paid), Material Table (opinionated styling) |\n| **shadcn/ui** | Already in use, accessible by default, Tailwind integration | Ant Design (bundle size), Material UI (design conflicts) |\n| **Fastify WebSocket** | Already integrated, lightweight, performant | Socket.io (heavier), native WS (less features) |\n\n---\n\n## 5. Next Steps\n\n### Prerequisites (Must Be in Place)\n\n1. **Database Schema Validation**:\n   - ✅ `repositories` table exists with `syncStatus` field\n   - ✅ `workers` table exists with `status` field\n   - ✅ `workItems` table exists with `status` and `completedAt` fields\n   - ✅ `agentExecutions` table exists with `completedAt` field\n   - Verify: Run migration check `npm run db:push` in backend\n\n2. **WebSocket Infrastructure Working**:\n   - ✅ `WebSocketHubService` operational\n   - Verify: Check existing agents can broadcast events\n   - Test: Connect to existing WebSocket endpoint\n\n3. **Frontend Build Setup**:\n   - ✅ TanStack Query configured in `App.tsx`\n   - ✅ Tailwind CSS working\n   - Verify: `npm run dev` starts frontend without errors\n\n### Recommended Implementation Order\n\n#### Sprint 1: Backend Foundation (Days 1-2)\n**Goal**: API and WebSocket infrastructure ready\n\n1. **Create Dashboard Service** (4 hours)\n   - Write `DashboardService.getStats()` method\n   - Add caching logic\n   - Write unit tests (AAA pattern)\n   - Test coverage: \u003e80%\n\n2. **Create Dashboard Handler** (2 hours)\n   - Fastify plugin with `GET /api/dashboard/stats`\n   - Error handling and logging\n   - Integration test with real DB\n\n3. **Enhance Repositories** (2 hours)\n   - Add `countByStatus()` to RepositoryRepository\n   - Add `findRecent(limit)` to AgentExecutionRepository\n   - Write tests for new methods\n\n4. **Create WebSocket Handler** (3 hours)\n   - Dedicated endpoint `/api/dashboard/ws`\n   - Client subscription to \"all\" channel\n   - Send initial state on connect\n   - Test reconnection behavior\n\n5. **Register in App** (1 hour)\n   - Add imports to `app.ts`\n   - Register both handlers\n   - Manual testing with Postman/Insomnia\n\n**Deliverables**:\n- [ ] `GET /api/dashboard/stats` returns correct data\n- [ ] WebSocket endpoint accepts connections\n- [ ] Events broadcast to dashboard clients\n- [ ] All tests passing (backend)\n\n#### Sprint 2: Frontend Data Layer (Day 2-3)\n**Goal**: Data flows from backend to frontend\n\n1. **Create Type Definitions** (1 hour)\n   - Define all interfaces in `types/dashboard.ts`\n   - Export types for both hooks and components\n   - Ensure alignment with backend response\n\n2. **Update API Config** (30 min)\n   - Add `WS_BASE` export to `lib/api.ts`\n   - Verify URL construction\n\n3. **Create Dashboard Hooks** (4 hours)\n   - `useDashboardStats()` with React Query\n   - `useDashboardWebSocket()` with reconnection\n   - Query invalidation logic\n   - Write tests with mocked fetch/WebSocket\n\n4. **Manual Testing** (1 hour)\n   - Test data fetching in isolation\n   - Verify WebSocket connection\n   - Check query invalidation on events\n\n**Deliverables**:\n- [ ] Hooks fetch data correctly\n- [ ] WebSocket invalidates queries on events\n- [ ] Reconnection works with exponential backoff\n- [ ] All tests passing (frontend hooks)\n\n#### Sprint 3: UI Integration (Day 3-4)\n**Goal**: Dashboard displays real data with real-time updates\n\n1. **Refactor Dashboard Component** (4 hours)\n   - Remove all mock data\n   - Integrate hooks\n   - Add loading/error states\n   - Add connection status indicator\n\n2. **Update Existing Components** (3 hours)\n   - `StatCard` - real metrics\n   - `ActiveAgentsGrid` - map over real agents\n   - `LiveActivityFeed` - real activity data\n   - Style work items by status\n\n3. **Create Repository Component** (2 hours)\n   - `RepositoryStatus.tsx`\n   - Display sync status with badges\n   - Follow existing design patterns\n\n4. **Component Testing** (2 hours)\n   - Test loading states\n   - Test error states\n   - Test data rendering\n   - Test real-time updates (mock WebSocket)\n\n**Deliverables**:\n- [ ] Dashboard shows real data\n- [ ] Real-time updates visible\n- [ ] Loading and error states work\n- [ ] All tests passing (component tests)\n\n#### Sprint 4: Polish \u0026 Production-Ready (Day 4-5)\n**Goal**: Optimized, accessible, documented\n\n1. **Performance Optimization** (3 hours)\n   - Add `React.memo()` to cards\n   - Implement update debouncing\n   - Profile for memory leaks\n   - Add virtualization if needed\n\n2. **Accessibility Audit** (2 hours)\n   - Add aria-labels to status badges\n   - Verify keyboard navigation\n   - Check color contrast (4.5:1 minimum)\n   - Test with screen reader\n\n3. **Error Handling** (2 hours)\n   - Add error boundaries\n   - Improve error messages\n   - Handle edge cases (no data, network failure)\n   - Add retry mechanisms\n\n4. **Documentation** (2 hours)\n   - JSDoc comments for all hooks\n   - Update README with dashboard features\n   - Document WebSocket event format\n   - Add architecture diagram\n\n**Deliverables**:\n- [ ] Performance benchmarks met (load \u003c2s, updates \u003c500ms)\n- [ ] WCAG 2.1 AA compliance\n- [ ] Comprehensive error handling\n- [ ] Documentation complete\n\n### Testing Considerations\n\n#### Unit Tests (Backend)\n**Pattern**: AAA (Arrange-Act-Assert)\n\n```typescript\n// dashboard.service.test.ts\ndescribe('DashboardService', () =\u003e {\n  describe('getStats', () =\u003e {\n    it('should aggregate repository stats correctly', async () =\u003e {\n      // Arrange\n      const service = new DashboardService(mockRepos, mockWorkers, mockItems, mockExecutions);\n\n      // Act\n      const stats = await service.getStats();\n\n      // Assert\n      expect(stats.repositories.total).toBe(5);\n      expect(stats.repositories.synced).toBe(3);\n    });\n\n    it('should filter completed items to last 24 hours', async () =\u003e {\n      // Arrange: Create items with old and recent completions\n\n      // Act\n      const stats = await service.getStats();\n\n      // Assert: Only recent items included\n      expect(stats.workItems.recentCompletions.length).toBe(2);\n    });\n\n    it('should cache stats for 5 seconds', async () =\u003e {\n      // Arrange\n      const service = new DashboardService(...);\n\n      // Act: Call twice within 5 seconds\n      await service.getStats();\n      const spy = vi.spyOn(mockRepos, 'findAll');\n      await service.getStats();\n\n      // Assert: Second call doesn't hit DB\n      expect(spy).not.toHaveBeenCalled();\n    });\n  });\n});\n```\n\n#### Integration Tests (Backend)\n```typescript\n// dashboard.handler.test.ts\ndescribe('Dashboard Handler', () =\u003e {\n  it('should return 200 with dashboard stats', async () =\u003e {\n    // Arrange: Real DB with test data\n\n    // Act\n    const response = await app.inject({\n      method: 'GET',\n      url: '/api/dashboard/stats',\n    });\n\n    // Assert\n    expect(response.statusCode).toBe(200);\n    expect(response.json()).toMatchObject({\n      repositories: expect.any(Object),\n      agents: expect.any(Object),\n    });\n  });\n});\n```\n\n#### Component Tests (Frontend)\n```typescript\n// Dashboard.test.tsx\ndescribe('Dashboard', () =\u003e {\n  it('should show loading state initially', () =\u003e {\n    // Arrange\n    render(\u003cDashboard /\u003e, { wrapper: QueryWrapper });\n\n    // Assert\n    expect(screen.getByRole('status')).toBeInTheDocument();\n  });\n\n  it('should display stats when loaded', async () =\u003e {\n    // Arrange: Mock successful fetch\n    server.use(\n      rest.get('/api/dashboard/stats', (req, res, ctx) =\u003e {\n        return res(ctx.json(mockStats));\n      })\n    );\n\n    // Act\n    render(\u003cDashboard /\u003e, { wrapper: QueryWrapper });\n\n    // Assert\n    await waitFor(() =\u003e {\n      expect(screen.getByText('Active Agents')).toBeInTheDocument();\n      expect(screen.getByText('12')).toBeInTheDocument(); // Agent count\n    });\n  });\n\n  it('should update when WebSocket message received', async () =\u003e {\n    // Arrange: Mock WebSocket\n    const mockWS = createMockWebSocket();\n\n    // Act: Render and send WS message\n    render(\u003cDashboard /\u003e, { wrapper: QueryWrapper });\n    mockWS.send({ type: 'agent:state_changed' });\n\n    // Assert: Query invalidated and refetch triggered\n    await waitFor(() =\u003e {\n      expect(mockFetch).toHaveBeenCalledTimes(2); // Initial + refetch\n    });\n  });\n});\n```\n\n#### Hook Tests (Frontend)\n```typescript\n// use-dashboard.test.ts\ndescribe('useDashboardStats', () =\u003e {\n  it('should fetch dashboard stats', async () =\u003e {\n    // Arrange\n    const { result } = renderHook(() =\u003e useDashboardStats(), {\n      wrapper: QueryWrapper,\n    });\n\n    // Assert\n    await waitFor(() =\u003e {\n      expect(result.current.isSuccess).toBe(true);\n      expect(result.current.data).toBeDefined();\n    });\n  });\n\n  it('should handle fetch errors', async () =\u003e {\n    // Arrange: Mock failed fetch\n    server.use(\n      rest.get('/api/dashboard/stats', (req, res, ctx) =\u003e {\n        return res(ctx.status(500));\n      })\n    );\n\n    // Act\n    const { result } = renderHook(() =\u003e useDashboardStats(), {\n      wrapper: QueryWrapper,\n    });\n\n    // Assert\n    await waitFor(() =\u003e {\n      expect(result.current.isError).toBe(true);\n    });\n  });\n});\n```\n\n### Monitoring \u0026 Observability\n\n#### Metrics to Track\n1. **Dashboard Load Time**: Time from page load to data display (\u003c2s target)\n2. **WebSocket Connection Uptime**: Percentage of time connected (\u003e99% target)\n3. **Query Invalidation Frequency**: Events per minute (baseline for alerts)\n4. **API Response Time**: `/api/dashboard/stats` latency (\u003c200ms target)\n5. **Cache Hit Rate**: Percentage of cached responses (target \u003e80%)\n\n#### Logging Strategy\n```typescript\n// Backend\nlogger.info({\n  event: 'dashboard_stats_request',\n  cacheHit: isCacheHit,\n  responseTime: duration\n});\n\nlogger.info({\n  event: 'websocket_client_connected',\n  clientId,\n  subscriptions: ['all']\n});\n\n// Frontend\nconsole.debug('Dashboard WebSocket state:', {\n  readyState,\n  lastMessage: lastJsonMessage,\n  timestamp: new Date()\n});\n```\n\n#### Error Alerts\n- WebSocket disconnects \u003e3 times/minute\n- API response time \u003e1 second\n- Error rate \u003e1%\n- Cache invalidation failing\n\n### Success Metrics\n\n**Functionality**:\n- ✅ All 4 data sections displayed (repos, agents, work items, completions)\n- ✅ Real-time updates working (\u003c500ms latency)\n- ✅ Graceful degradation if WebSocket fails (fall back to polling)\n\n**Performance**:\n- ✅ Initial load \u003c2 seconds\n- ✅ Updates \u003c500ms from backend event\n- ✅ No memory leaks (stable memory over 1 hour)\n- ✅ Smooth UI (no jank during updates)\n\n**Quality**:\n- ✅ Test coverage \u003e80% (unit + integration)\n- ✅ WCAG 2.1 AA compliance\n- ✅ Zero TypeScript errors\n- ✅ Linter passing\n\n**User Experience**:\n- ✅ Clear loading states\n- ✅ Helpful error messages\n- ✅ Connection status visible\n- ✅ Responsive design (mobile + desktop)\n\n---\n\n## Appendix: File Inventory\n\n### Files to Create (NEW)\n\n#### Backend\n1. `/backend/src/features/dashboard/handler/dashboard.handler.ts` - REST API handler\n2. `/backend/src/features/dashboard/handler/websocket.handler.ts` - WebSocket handler\n3. `/backend/src/features/dashboard/services/dashboard.service.ts` - Business logic\n4. `/backend/src/features/dashboard/handler/dashboard.handler.test.ts` - Handler tests\n5. `/backend/src/features/dashboard/services/dashboard.service.test.ts` - Service tests\n6. `/backend/src/features/dashboard/handler/websocket.handler.test.ts` - WebSocket tests\n\n#### Frontend\n1. `/frontend/src/hooks/use-dashboard.ts` - Custom React hooks\n2. `/frontend/src/hooks/use-dashboard.test.ts` - Hook tests\n3. `/frontend/src/types/dashboard.ts` - Type definitions\n4. `/frontend/src/components/dashboard/RepositoryStatus.tsx` - Repository component\n5. `/frontend/src/pages/Dashboard.test.tsx` - Component tests (if not exists)\n\n### Files to Modify (EXISTING)\n\n#### Backend\n1. `/backend/src/app.ts` - Register dashboard handlers (lines 120+)\n2. `/backend/src/features/repositories/repositories/repository.repository.ts` - Add countByStatus()\n3. `/backend/src/features/agent-runtime/repositories/agent-execution.repository.ts` - Add findRecent()\n\n#### Frontend\n1. `/frontend/src/pages/Dashboard.tsx` - Replace mock data (lines 21-206, keep 210-615)\n2. `/frontend/src/lib/api.ts` - Add WS_BASE export (after line 6)\n\n### Files to Reference (PATTERNS)\n\n#### Backend Patterns\n- `/backend/src/features/work-items/handlers/work-items.handler.ts` - Handler pattern\n- `/backend/src/features/work-items/repositories/work-item.repository.ts` - Repository pattern\n- `/backend/src/shared/websocket/websocket-hub.service.ts` - WebSocket usage\n\n#### Frontend Patterns\n- `/frontend/src/hooks/use-containers.ts` - React Query hook pattern\n- `/frontend/src/pages/Containers.tsx` - Component integration pattern\n- `/frontend/src/components/Layout.tsx` - Page layout pattern\n\n---\n\n## Summary\n\nThis research provides a comprehensive blueprint for implementing a production-ready status dashboard. The solution leverages existing infrastructure (WebSocket, React Query, Tailwind) and follows established patterns in the codebase. No new dependencies are required.\n\n**Key Strengths**:\n- ✅ Uses existing WebSocket infrastructure\n- ✅ Follows vertical slice architecture\n- ✅ No new dependencies needed\n- ✅ Clear implementation path with specific file locations\n- ✅ Comprehensive testing strategy\n- ✅ Production-ready performance and accessibility\n\n**Estimated Effort**: 3-5 days for complete implementation including tests and documentation\n\n**Next Action**: Proceed to planning phase to break down into atomic tasks\n","created_at":"2025-12-24T22:16:37Z"}]}
{"id":"agent-ops-kpr.2","title":"Execution log viewer","description":"View agent execution logs and traces. Show tool calls, decisions, errors. Link to OpenTelemetry traces in Aspire dashboard.","design":"# Implementation Plan: Execution Log Viewer Feature\n\n## Problem Summary\n\nBuild an Execution Log Viewer feature that displays agent execution logs and traces, showing tool calls, decisions, and errors, with deep-linking to the Aspire dashboard for detailed trace analysis. The feature follows TDD principles and integrates with the existing vertical slice architecture.\n\n## FACTS Validation Summary\n\n- **Feasibility**: All dependencies are available. React 19.2.0 is installed (AgentPrism compatible). Existing patterns for handlers, services, hooks, and components are well-established. The `agentExecutions` and `traces` tables exist with all required fields.\n- **Atomicity**: Each task represents a single, verifiable unit of work (one test, one function, one component). Tasks are sized for 5-15 minute completion.\n- **Clarity**: Tasks reference specific files, methods, and patterns from the existing codebase. Test expectations are explicit.\n- **Testability**: Every feature has corresponding test tasks. Backend uses Vitest with in-memory SQLite. Frontend uses Vitest with React Testing Library.\n- **Scope**: Four phases, each representing a deployable milestone. Phases build incrementally and can be committed independently.\n\n## Prerequisites\n\n**Dependencies to Install:**\n```bash\n# Backend - none needed (existing stack sufficient)\n\n# Frontend - optional visualization libraries\nnpm install @melloware/react-logviewer  # For console log display\n```\n\n**Environment:**\n- Aspire dashboard URL configured (e.g., `ASPIRE_DASHBOARD_URL=http://localhost:18888`)\n- Existing database with `agent_executions` and `traces` tables\n\n**Blocking Issues to Verify:**\n- [ ] Confirm `traces` table has data or seeding mechanism exists\n- [ ] Confirm Aspire dashboard is running for integration testing\n\n## Phase 1: Backend - Execution Log Service and Types\n\n**Goal:** Create the backend types, service layer, and repository extensions for querying execution logs with traces.\n\n**Committable State:** Backend service and types ready for handler integration. All unit tests passing.\n\n**Context:**\n- Pattern: `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/dashboard/services/dashboard.service.ts`\n- Pattern: `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/dashboard/types/dashboard.types.ts`\n- Schema: `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/shared/db/schema.ts` (lines 40-48 for TraceEventType, lines 271-283 for traces table)\n\n### Tasks\n\n- [ ] Create `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/executions/types/execution-log.types.ts` with interfaces:\n  - `ExecutionListItem` (id, status, workerId, workItemId, startedAt, completedAt, durationMs, tokensUsed, errorMessage)\n  - `ExecutionDetail` (extends ListItem + output, traces)\n  - `TraceEvent` (id, eventType, data, timestamp)\n  - `ExecutionFilters` (status?, workerId?, workItemId?, dateFrom?, dateTo?, limit?, offset?)\n  - `ExecutionListResponse` (items, total, hasMore)\n\n- [ ] [P] Create test file `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/executions/tests/execution-log.service.test.ts` with test structure matching `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/agent-runtime/tests/agent-execution.repository.test.ts`\n\n- [ ] Write test: `getExecutionList returns paginated executions ordered by createdAt desc` (RED)\n  - Arrange: Create 5 executions with different statuses and timestamps\n  - Act: Call `service.getExecutionList({ limit: 3 })`\n  - Assert: Returns 3 items, ordered by createdAt descending, hasMore is true\n\n- [ ] Implement `getExecutionList` method in `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/executions/services/execution-log.service.ts` (GREEN)\n  - Use existing `AgentExecutionRepository` pattern\n  - Add orderBy, limit, offset support\n\n- [ ] Write test: `getExecutionList filters by status` (RED)\n  - Arrange: Create executions with 'success', 'error', 'running' statuses\n  - Act: Call `service.getExecutionList({ status: 'error' })`\n  - Assert: Returns only error executions\n\n- [ ] Implement status filter in `getExecutionList` (GREEN)\n\n- [ ] Write test: `getExecutionById returns execution with traces` (RED)\n  - Arrange: Create execution and 3 associated trace records\n  - Act: Call `service.getExecutionById(executionId)`\n  - Assert: Returns execution with traces array ordered by timestamp\n\n- [ ] Implement `getExecutionById` method (GREEN)\n  - Join agentExecutions with traces on workerId/workItemId or add executionId to traces\n\n- [ ] Write test: `getTracesByExecutionId returns filtered traces` (RED)\n  - Arrange: Create traces of different eventTypes (tool_call, error, agent_state)\n  - Act: Call `service.getTracesByExecutionId(id, { eventType: 'tool_call' })`\n  - Assert: Returns only tool_call traces\n\n- [ ] Implement `getTracesByExecutionId` method with eventType filter (GREEN)\n\n\n## Phase 2: Backend - REST API Handler\n\n**Goal:** Expose execution log data via REST endpoints following existing handler patterns.\n\n**Committable State:** Full backend API functional. Handler tests passing. Ready for frontend integration.\n\n**Context:**\n- Pattern: `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/agent-runtime/handler/agent-runtime.handler.ts`\n- Pattern: `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/dashboard/handler/dashboard.handler.ts`\n- App registration: `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/app.ts`\n\n### Tasks\n\n- [ ] Create `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/executions/handler/executions.handler.ts` with route options interface matching `DashboardHandlerOptions` pattern\n\n- [ ] [P] Create test file `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/executions/tests/executions.handler.test.ts`\n\n- [ ] Write test: `GET /api/executions returns paginated list` (RED)\n  - Arrange: Seed database with executions\n  - Act: GET `/api/executions?limit=10`\n  - Assert: Status 200, body contains items array, total count, hasMore flag\n\n- [ ] Implement `GET /` endpoint in handler (GREEN)\n  - Parse query params: status, workerId, workItemId, limit, offset\n  - Call service.getExecutionList\n\n- [ ] Write test: `GET /api/executions/:id returns execution with traces` (RED)\n  - Arrange: Create execution with traces\n  - Act: GET `/api/executions/{id}`\n  - Assert: Status 200, body contains execution detail with traces array\n\n- [ ] Implement `GET /:id` endpoint (GREEN)\n  - Call service.getExecutionById\n  - Return 404 if not found\n\n- [ ] Write test: `GET /api/executions/:id returns 404 for non-existent execution` (RED)\n  - Act: GET `/api/executions/non-existent-id`\n  - Assert: Status 404, error message\n\n- [ ] Implement 404 handling in `GET /:id` (GREEN)\n\n- [ ] Write test: `GET /api/executions/:id/traces returns filtered traces` (RED)\n  - Arrange: Create execution with tool_call and error traces\n  - Act: GET `/api/executions/{id}/traces?eventType=tool_call`\n  - Assert: Status 200, returns only tool_call traces\n\n- [ ] Implement `GET /:id/traces` endpoint (GREEN)\n\n- [ ] Register handler in `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/app.ts`:\n  ```typescript\n  import { executionsHandler } from \"./features/executions/handler/executions.handler.js\";\n  // In buildApp, after dashboard handler:\n  await app.register(executionsHandler, {\n    prefix: \"/api/executions\",\n    db,\n  });\n  ```\n\n\n## Phase 3: Frontend - Types, Hooks, and Data Layer\n\n**Goal:** Create React Query hooks and TypeScript types for fetching execution data.\n\n**Committable State:** Data layer complete. Hooks tested and functional. Ready for UI components.\n\n**Context:**\n- Pattern: `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/hooks/use-containers.ts`\n- Pattern: `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/types/container.ts`\n- Pattern: `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/types/dashboard.ts`\n\n### Tasks\n\n- [ ] Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/types/execution.ts` with interfaces:\n  - `ExecutionStatus` type (matching backend AgentExecutionStatus)\n  - `TraceEventType` type (agent_state, work_item_update, tool_call, metric_update, error, approval_required)\n  - `ExecutionListItem` interface\n  - `ExecutionDetail` interface (with traces)\n  - `TraceEvent` interface (id, eventType, data, timestamp)\n  - `ExecutionFilters` interface\n  - `ToolCallData` interface (for tool_call trace data: name, input, output, durationMs)\n  - `ErrorData` interface (for error trace data: message, stack, context)\n\n- [ ] Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/hooks/use-executions.ts` with query key structure matching `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/hooks/use-containers.ts`:\n  ```typescript\n  const executionKeys = {\n    all: ['executions'] as const,\n    lists: () =\u003e [...executionKeys.all, 'list'] as const,\n    list: (filters: ExecutionFilters) =\u003e [...executionKeys.lists(), filters] as const,\n    details: () =\u003e [...executionKeys.all, 'detail'] as const,\n    detail: (id: string) =\u003e [...executionKeys.details(), id] as const,\n    traces: (id: string) =\u003e [...executionKeys.detail(id), 'traces'] as const,\n  };\n  ```\n\n- [ ] [P] Create test file `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/hooks/use-executions.test.ts`\n\n- [ ] Write test: `useExecutions fetches execution list with polling` (RED)\n  - Arrange: Mock fetch to return execution list\n  - Act: Render hook with useExecutions()\n  - Assert: Returns data, isLoading states correctly\n\n- [ ] Implement `useExecutions(filters?)` hook (GREEN)\n  - Use `useQuery` with 5-second refetchInterval (matching containers pattern)\n  - Parse date strings to Date objects\n\n- [ ] Write test: `useExecution fetches single execution with traces` (RED)\n  - Arrange: Mock fetch to return execution detail\n  - Act: Render hook with useExecution(id)\n  - Assert: Returns execution with traces array\n\n- [ ] Implement `useExecution(id)` hook (GREEN)\n  - Fetch from `/api/executions/{id}`\n  - Parse nested trace timestamps\n\n- [ ] Write test: `useExecutionTraces fetches traces with filter` (RED)\n  - Arrange: Mock fetch to return traces\n  - Act: Render hook with useExecutionTraces(id, { eventType: 'tool_call' })\n  - Assert: Returns filtered traces\n\n- [ ] Implement `useExecutionTraces(id, filters?)` hook (GREEN)\n\n- [ ] Add date parsing helper functions (matching `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/hooks/use-dashboard.ts` pattern):\n  ```typescript\n  function parseExecutionDates(execution: Record\u003cstring, unknown\u003e): ExecutionListItem\n  function parseTraceDates(trace: Record\u003cstring, unknown\u003e): TraceEvent\n  ```\n\n\n## Phase 4: Frontend - UI Components and Page\n\n**Goal:** Build the ExecutionLogs page with list/detail views, trace visualization, and Aspire deep-linking.\n\n**Committable State:** Full feature complete. Page accessible via navigation. All UI components functional.\n\n**Context:**\n- Page pattern: `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/pages/Containers.tsx`\n- Page pattern: `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/pages/Dashboard.tsx`\n- Layout: `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/Layout.tsx`\n- App routes: `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/App.tsx`\n\n### Tasks\n\n- [ ] Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/executions/ExecutionList.tsx`:\n  - Props: executions, isLoading, selectedId, onSelect\n  - Render list items with status badge, workerId, duration, timestamp\n  - Highlight selected execution\n  - Show loading skeleton when isLoading\n\n- [ ] Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/executions/ExecutionFilters.tsx`:\n  - Status filter dropdown (all, pending, running, success, error, cancelled)\n  - Date range picker (from/to)\n  - Worker ID search input\n  - Apply/Clear buttons\n\n- [ ] Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/executions/ExecutionMetadata.tsx`:\n  - Props: execution (ExecutionDetail)\n  - Display: status, duration, tokens used, cost, tool calls count\n  - Error message display (if status === 'error')\n  - Timestamps: started, completed\n\n- [ ] Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/executions/AspireLink.tsx`:\n  - Props: executionId, traceId?\n  - Generate Aspire dashboard deep-link URL\n  - Render button with external link icon\n  - Open in new tab on click\n\n- [ ] Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/executions/TraceTimeline.tsx`:\n  - Props: traces (TraceEvent[])\n  - Vertical timeline layout\n  - Icon per event type (tool=wrench, error=alert, state=refresh)\n  - Timestamp display (relative: \"2m ago\")\n  - Expandable detail view for each trace\n  - Tool call: show name, input/output JSON\n  - Error: show message, stack trace\n\n- [ ] Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/executions/LogViewer.tsx`:\n  - Props: logs (string[])\n  - Console-style display with monospace font\n  - Auto-scroll to bottom option\n  - Line numbers\n  - Search/filter capability (optional, can defer)\n\n- [ ] Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/executions/ExecutionDetail.tsx`:\n  - Props: execution (ExecutionDetail)\n  - Tabbed interface: Trace | Logs | Metrics\n  - Sidebar with ExecutionMetadata + AspireLink\n  - Main content switches based on active tab\n\n- [ ] Create `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/pages/ExecutionLogs.tsx`:\n  - Two-panel layout (list on left, detail on right)\n  - Use useExecutions() for list\n  - Use useExecution(selectedId) for detail\n  - Handle empty state (no executions)\n  - Handle loading states\n  - Responsive: stack panels on mobile\n\n- [ ] Add route to `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/App.tsx`:\n  ```typescript\n  import { ExecutionLogs } from \"./pages/ExecutionLogs\";\n  // In Routes:\n  \u003cRoute path=\"/executions\" element={\u003cExecutionLogs /\u003e} /\u003e\n  ```\n\n- [ ] Add navigation item to `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/Layout.tsx`:\n  ```typescript\n  import { ScrollText } from \"lucide-react\";\n  // In NAV_ITEMS array (after Containers):\n  { to: \"/executions\", label: \"Execution Logs\", icon: ScrollText },\n  ```\n\n- [ ] [P] Create test file `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/pages/ExecutionLogs.test.tsx`\n\n- [ ] Write test: `ExecutionLogs page renders execution list` (RED)\n  - Arrange: Mock useExecutions to return list\n  - Act: Render ExecutionLogs\n  - Assert: Execution items visible in list\n\n- [ ] Write test: `ExecutionLogs page shows detail when execution selected` (RED)\n  - Arrange: Mock hooks, simulate click on execution\n  - Act: Click execution item\n  - Assert: Detail panel shows execution metadata and traces\n\n- [ ] Implement tests to pass (GREEN)\n\n\n## Phase 5: Polish and Integration\n\n**Goal:** Add real-time updates, performance optimizations, and final integration testing.\n\n**Committable State:** Feature complete, polished, and production-ready.\n\n### Tasks\n\n- [ ] Add WebSocket support for running executions:\n  - Subscribe to execution updates via `/api/executions/ws`\n  - Update list automatically when execution status changes\n  - Show real-time trace events for running executions\n\n- [ ] Add loading skeletons matching dashboard pattern (`/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/pages/Dashboard.tsx` lines 606-616)\n\n- [ ] Add error states matching dashboard pattern (lines 619-639)\n\n- [ ] Performance: Implement virtualization for trace timeline (1000+ events)\n  - Use `react-window` or similar for long lists\n\n- [ ] Add keyboard navigation:\n  - Arrow up/down to navigate execution list\n  - Enter to select\n  - Escape to clear selection\n\n- [ ] Manual integration test checklist:\n  - [ ] Navigate to /executions from sidebar\n  - [ ] Filter executions by status\n  - [ ] Select execution to view details\n  - [ ] Switch between Trace/Logs/Metrics tabs\n  - [ ] Click Aspire link and verify deep-link works\n  - [ ] Verify real-time updates for running execution\n\n\n## Validation Checklist\n\n- [ ] All backend tests passing (`cd backend \u0026\u0026 npm test`)\n- [ ] All frontend tests passing (`cd frontend \u0026\u0026 npm test`)\n- [ ] TypeScript compilation succeeds (`npm run build` in both directories)\n- [ ] ESLint passes with no errors\n- [ ] Feature accessible via navigation menu\n- [ ] Execution list loads and displays correctly\n- [ ] Execution detail shows traces in timeline format\n- [ ] Tool calls display input/output data\n- [ ] Errors are highlighted and easy to locate\n- [ ] Aspire dashboard link works correctly\n- [ ] Real-time updates work for running executions\n- [ ] Performance acceptable with 100+ executions, 1000+ traces\n\n\n## Appendix: Code Examples\n\n### A1: Service Pattern (from dashboard.service.ts)\n\n```typescript\nexport class ExecutionLogService {\n  private executionRepo: AgentExecutionRepository;\n\n  constructor(db: DrizzleDatabase) {\n    this.executionRepo = new AgentExecutionRepository(db);\n  }\n\n  async getExecutionList(filters: ExecutionFilters): Promise\u003cExecutionListResponse\u003e {\n    // Implementation here\n  }\n}\n```\n\n### A2: Handler Pattern (from agent-runtime.handler.ts)\n\n```typescript\nexport async function executionsHandler(\n  app: FastifyInstance,\n  options: ExecutionsHandlerOptions\n): Promise\u003cvoid\u003e {\n  const { db } = options;\n  const service = new ExecutionLogService(db);\n\n  app.get(\"/\", async (request, reply) =\u003e {\n    const filters = request.query as ExecutionFilters;\n    const result = await service.getExecutionList(filters);\n    return result;\n  });\n}\n```\n\n### A3: React Query Hook Pattern (from use-containers.ts)\n\n```typescript\nexport function useExecutions(filters?: ExecutionFilters) {\n  return useQuery({\n    queryKey: executionKeys.list(filters ?? {}),\n    queryFn: () =\u003e fetchExecutions(filters),\n    refetchInterval: 5000,\n  });\n}\n```\n\n### A4: Page Component Pattern (from Containers.tsx)\n\n```typescript\nexport function ExecutionLogs() {\n  const [selectedId, setSelectedId] = useState\u003cstring | null\u003e(null);\n  const { data: executions = [], isLoading } = useExecutions();\n  const { data: execution } = useExecution(selectedId ?? '');\n\n  return (\n    \u003cdiv className=\"min-h-screen bg-[var(--bg-deep)] relative\"\u003e\n      {/* Left panel: List */}\n      {/* Right panel: Detail */}\n    \u003c/div\u003e\n  );\n}\n```\n\n### A5: Trace Event Type Discrimination\n\n```typescript\ninterface ToolCallTraceData {\n  name: string;\n  input: unknown;\n  output: unknown;\n  durationMs: number;\n}\n\ninterface ErrorTraceData {\n  message: string;\n  stack?: string;\n  context?: Record\u003cstring, unknown\u003e;\n}\n\n// Type guard for trace data\nfunction isToolCallData(eventType: TraceEventType, data: unknown): data is ToolCallTraceData {\n  return eventType === 'tool_call';\n}\n```\n\n### A6: Aspire Dashboard Deep-Link Format\n\n```typescript\n// Aspire uses a specific URL format for trace correlation\nfunction getAspireTraceUrl(executionId: string): string {\n  const baseUrl = import.meta.env.VITE_ASPIRE_DASHBOARD_URL || 'http://localhost:18888';\n  // Aspire trace view URL format (verify with actual Aspire docs)\n  return `${baseUrl}/traces?traceId=${executionId}`;\n}\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-23T20:18:17.001415-06:00","updated_at":"2025-12-24T17:53:51.333969-06:00","closed_at":"2025-12-24T17:53:51.333969-06:00","close_reason":"Closed","labels":["logs","ui"],"dependencies":[{"issue_id":"agent-ops-kpr.2","depends_on_id":"agent-ops-kpr","type":"parent-child","created_at":"2025-12-23T20:18:17.004958-06:00","created_by":"daemon"}],"comments":[{"id":3,"issue_id":"agent-ops-kpr.2","author":"probinson","text":"# Research Document: Execution Log Viewer\n\n**Issue**: agent-ops-kpr.2\n**Created**: 2025-12-24\n**Status**: Research Complete\n\n## 1. Problem Overview\n\n### Problem Statement\nBuild an execution log viewer that displays agent execution logs and traces, showing tool calls, decisions, and errors, with links to OpenTelemetry traces in the Aspire dashboard.\n\n### Key Objectives\n- Display agent execution logs in a user-friendly format\n- Show hierarchical trace visualization with tool calls and decisions\n- Highlight errors and execution flow\n- Link to OpenTelemetry traces in Aspire dashboard for deep analysis\n- Provide real-time updates for running executions\n- Enable efficient debugging of agent behavior\n\n### Success Criteria\n- Users can view execution history with filtering capabilities\n- Execution detail view shows comprehensive logs and trace information\n- Tool calls are clearly visible with input/output data\n- Errors are highlighted and easy to locate\n- One-click navigation to Aspire dashboard for specific traces\n- Real-time updates for active executions\n- Good performance with large execution logs (1000+ events)\n- Consistent with existing UI patterns (Tailwind CSS, React)\n\n---\n\n## 2. Web Research Findings\n\n### Recommended Solution: Hybrid Approach\n\nBased on extensive research of AI agent observability tools and React component libraries, the recommended approach combines three complementary solutions:\n\n#### **Primary: AgentPrism for Trace Visualization**\n\n**Source**: [AgentPrism GitHub](https://github.com/evilmartians/agent-prism) | [Evil Martians Blog](https://evilmartians.com/chronicles/debug-ai-fast-agent-prism-open-source-library-visualize-agent-traces)\n\nAgentPrism is an open-source React component library specifically designed for visualizing AI agent traces. Built by Evil Martians, it transforms OpenTelemetry data into clear hierarchical diagrams.\n\n**Key Features**:\n- Purpose-built for AI agent trace visualization\n- Native OpenTelemetry OTLP support via `@agent-prism/data/otlp` adapter\n- React 19 + Tailwind CSS (perfect stack match)\n- Modular architecture with three main components:\n  - `TraceViewer` - All-in-one solution\n  - `TreeView` - Hierarchical span visualization\n  - `DetailsView` - Individual span inspection\n- Production-proven (used by Quotient AI)\n- Reports 80% reduction in debugging time\n- Accessible components using Radix UI\n\n**Installation**:\n```bash\nnpx degit evilmartians/agent-prism/packages/ui/src/components frontend/src/components/agent-prism\nnpm install @agent-prism/data @agent-prism/types react-json-pretty\n```\n\n**Basic Usage**:\n```typescript\nimport { otlpToTraces } from '@agent-prism/data/otlp';\nimport { TraceViewer } from './components/agent-prism';\n\nconst traces = otlpToTraces(otlpDocument);\n\u003cTraceViewer traces={traces} /\u003e\n```\n\n**Pros**:\n- Designed specifically for AI agent debugging\n- Perfect technology stack alignment\n- Shows tool calls, decisions, and execution flow naturally\n- Themeable via CSS custom properties\n\n**Cons**:\n- Alpha status (API may change)\n- Requires React 19+ (may need upgrade from React 18)\n- Component copying rather than npm install\n- Limited documentation as early-stage project\n\n#### **Secondary: @melloware/react-logviewer for Console Output**\n\n**Source**: [@melloware/react-logviewer npm](https://www.npmjs.com/package/@melloware/react-logviewer) | [GitHub](https://github.com/melloware/react-logviewer)\n\nActively maintained fork of Mozilla's react-lazylog, designed for efficiently displaying large log files with ANSI color support and streaming.\n\n**Key Features**:\n- Virtual scrolling handles 100MB+ log files\n- ANSI color parsing for terminal-style output\n- Multiple data sources (URL, WebSocket, EventSource, static text)\n- Auto-follow scrolling for real-time logs\n- Line highlighting and search functionality\n- Cross-browser compatible\n\n**Installation**:\n```bash\nnpm install @melloware/react-logviewer\n```\n\n**Basic Usage**:\n```tsx\nimport { LazyLog, ScrollFollow } from '@melloware/react-logviewer';\n\n// Static logs\n\u003cLazyLog url=\"http://api/execution/123/logs\" height={600} enableSearch /\u003e\n\n// Real-time streaming\n\u003cScrollFollow startFollowing render={({ follow, onScroll }) =\u003e (\n  \u003cLazyLog url=\"ws://api/execution/123/stream\" stream follow={follow} onScroll={onScroll} websocket /\u003e\n)} /\u003e\n```\n\n**Pros**:\n- Excellent performance with large logs\n- Works seamlessly with Tailwind CSS\n- Real-time streaming support\n- Actively maintained\n\n**Cons**:\n- Not designed for structured trace data\n- No hierarchical visualization\n- Best for raw console output\n\n#### **Tertiary: Aspire Dashboard Deep-linking**\n\n**Source**: [Aspire Dashboard Documentation](https://learn.microsoft.com/en-us/dotnet/aspire/fundamentals/telemetry) | [Best Tool for OpenTelemetry](https://anthonysimmon.com/dotnet-aspire-dashboard-best-tool-visualize-opentelemetry-local-dev/)\n\nProvide deep links to Aspire dashboard for advanced trace analysis.\n\n**Implementation Pattern**:\n```typescript\nfunction openAspireTrace(traceId: string) {\n  const aspireDashboardUrl = `http://localhost:18888/traces/${traceId}`;\n  window.open(aspireDashboardUrl, '_blank');\n}\n```\n\n**Benefits**:\n- Leverage Aspire's excellent trace correlation\n- No need to rebuild complex trace features\n- Production-ready dashboard\n- Handles logs, metrics, and traces together\n\n### Alternative Solutions Evaluated\n\n#### **React Virtualization Libraries**\n- **react-virtuoso**: Exceptional performance for large lists with dynamic heights\n- **react-window**: Lightweight alternative for simple virtualization needs\n- **Use case**: Consider if AgentPrism doesn't handle large trace volumes well\n\n#### **Tree View Components**\n- **MUI X Tree View**: Robust tree component if building custom solution\n- **Pattern**: W3C ARIA tree view pattern for accessibility\n\n#### **Jaeger UI Components**\n- **jaeger-react-trace-component**: Reusable trace visualization from Jaeger\n- **Use case**: Fallback if AgentPrism doesn't work\n\n### Best Practices from Research\n\n**1. OpenTelemetry Semantic Conventions**\nFollow standardized attributes for agent traces:\n```typescript\n// LLM call spans\nattributes: {\n  'gen_ai.system': 'anthropic',\n  'gen_ai.request.model': 'claude-sonnet-4',\n  'gen_ai.usage.input_tokens': 1523,\n  'gen_ai.usage.output_tokens': 487,\n}\n\n// Tool call spans\nattributes: {\n  'tool.name': 'WebSearch',\n  'tool.input': JSON.stringify({ query: 'opentelemetry' }),\n  'tool.output': JSON.stringify({ results: [...] }),\n}\n\n// Agent decision spans\nattributes: {\n  'agent.decision': 'continue',\n  'agent.reasoning': 'Need more information...',\n}\n```\n\n**2. Performance Optimization**\n- Use virtual scrolling for lists with 100+ items\n- Implement WebSocket streaming for real-time updates\n- Batch log updates (every 500ms) to avoid UI thrashing\n- Cache completed executions (they don't change)\n\n**3. UI/UX Patterns**\n- Tabbed interface (Overview, Logs, Traces, Metrics)\n- Timeline visualization for execution flow\n- Color-coded status indicators (running, success, error)\n- Search and filtering capabilities\n- Export functionality for debugging\n\n---\n\n## 3. Codebase Analysis\n\n### Current Architecture\n\n**Backend**: Fastify (Node.js/TypeScript) with Drizzle ORM (SQLite)\n**Frontend**: React + TypeScript with TanStack Query\n**Observability**: OpenTelemetry integration sending to Aspire dashboard\n**Real-time**: WebSocket support available\n\n### Database Schema\n\nFrom `backend/src/shared/db/schema.ts`:\n\n#### Agent Executions Table (lines 238-254)\n```typescript\nexport const agentExecutions = sqliteTable(\"agent_executions\", {\n  id: text(\"id\").primaryKey(),\n  workerId: text(\"worker_id\").references(() =\u003e workers.id),\n  workItemId: text(\"work_item_id\").references(() =\u003e workItems.id),\n  workspaceId: text(\"workspace_id\").references(() =\u003e workspaces.id),\n  templateId: text(\"template_id\").references(() =\u003e templates.id),\n  status: text(\"status\").$type\u003cAgentExecutionStatus\u003e().default(\"pending\"),\n  startedAt, completedAt, durationMs,\n  tokensUsed, costUsd, toolCallsCount,\n  errorMessage: text(\"error_message\"),\n  output: text(\"output\", { mode: \"json\" }).$type\u003cAgentExecutionOutput\u003e(),\n  createdAt\n});\n```\n\n**Key Fields**:\n- `status`: pending, running, completed, failed\n- `output`: Contains `summary`, `filesChanged`, `testsRun`, `logs[]`, `diff`\n- `errorMessage`: Error details if execution failed\n\n#### Traces Table (lines 272-283)\n```typescript\nexport const traces = sqliteTable(\"traces\", {\n  id: text(\"id\").primaryKey(),\n  workerId, workItemId,\n  eventType: text(\"event_type\").$type\u003cTraceEventType\u003e(),\n  data: text(\"data\", { mode: \"json\" }).$type\u003cunknown\u003e(),\n  timestamp: integer(\"timestamp\", { mode: \"timestamp_ms\" })\n});\n```\n\n**Event Types** (lines 40-48):\n- `agent_state`\n- `work_item_update`\n- `tool_call`\n- `metric_update`\n- `error`\n- `approval_required`\n\n### Existing Services\n\n#### ObservabilityService (`backend/src/shared/observability/observability.service.ts`)\n\nAlready provides comprehensive trace recording and querying:\n\n**Key Methods**:\n- `getTraces(options)` (lines 344-427) - Query traces with filters\n- `getTracesForWorker(workerId)` - Worker-specific traces\n- `getRecentErrors(limit)` - Error traces\n- `recordToolCall()`, `recordError()`, etc. - Trace recording\n\n**Usage Pattern**:\n```typescript\nconst traces = await observabilityService.getTraces({\n  workerId: 'worker-123',\n  eventTypes: ['tool_call', 'error'],\n  startTime: Date.now() - 3600000, // Last hour\n});\n```\n\n#### AgentExecutionRepository (`backend/src/features/agent-runtime/repositories/agent-execution.repository.ts`)\n\nProvides execution data access:\n- `findById(id)` - Get single execution\n- `findAll(filters)` - List executions with filtering\n- `updateStatus(id, status)` - Update execution status\n\n### OpenTelemetry Configuration\n\nFrom `backend/src/shared/telemetry.ts`:\n- OTLP Exporter sends traces to `OTEL_EXPORTER_OTLP_ENDPOINT`\n- Default: `http://localhost:4317`\n- Service name: `agent-ops-backend`\n- Aspire Dashboard: `http://localhost:19147` (from AppHost configuration)\n\n### Existing Frontend Patterns\n\n#### API Hook Pattern (`frontend/src/hooks/use-containers.ts`)\n```typescript\nexport function useResource(id: string) {\n  return useQuery({\n    queryKey: resourceKeys.detail(id),\n    queryFn: () =\u003e fetchResource(id),\n    refetchInterval: 5000, // Real-time updates\n  });\n}\n```\n\n#### Date Parsing Pattern (`frontend/src/hooks/use-dashboard.ts`, lines 50-57)\n```typescript\nfunction parseEntityDates(entity: Record\u003cstring, unknown\u003e): Entity {\n  return {\n    ...entity,\n    createdAt: new Date(entity.createdAt as string),\n    startedAt: entity.startedAt ? new Date(entity.startedAt as string) : undefined,\n  } as Entity;\n}\n```\n\n#### Component Structure (`frontend/src/pages/Dashboard.tsx`, `frontend/src/pages/Containers.tsx`)\n- List/detail pattern for resources\n- Tabbed interfaces for different views\n- Real-time polling for active resources\n- Consistent card-based layouts with Tailwind\n\n---\n\n## 4. Affected Files\n\n### Backend Files (New)\n\n#### 1. `backend/src/features/executions/handler/executions.handler.ts`\n**Purpose**: API endpoints for execution log viewing\n**Endpoints**:\n- `GET /api/executions` - List all executions with filters\n- `GET /api/executions/:id` - Get single execution details\n- `GET /api/executions/:id/traces` - Get all traces for an execution\n- `GET /api/executions/:id/logs` - Get formatted logs\n- `GET /api/executions/:id/trace-url` - Generate Aspire trace URL\n\n**Pattern**: Follow `backend/src/features/agent-runtime/handler/agent-runtime.handler.ts` (lines 27-228)\n\n#### 2. `backend/src/features/executions/services/execution-log.service.ts`\n**Purpose**: Business logic for formatting logs and aggregating traces\n**Methods**:\n- `getExecutionWithTraces(id)` - Combine execution + traces\n- `formatExecutionLogs(execution)` - Format output.logs and traces\n- `getToolCalls(executionId)` - Extract tool call traces\n- `getErrors(executionId)` - Extract error traces\n- `generateAspireTraceUrl(executionId, traceId?)` - Build Aspire URL\n\n**Pattern**: Follow `backend/src/features/dashboard/services/dashboard.service.ts`\n\n#### 3. `backend/src/features/executions/types/execution-log.types.ts`\n**Purpose**: Type definitions for log viewer API responses\n```typescript\nexport interface ExecutionWithTraces {\n  execution: AgentExecution;\n  traces: Trace[];\n  toolCalls: ToolCallTrace[];\n  errors: ErrorTrace[];\n  logs: LogEntry[];\n}\n\nexport interface LogEntry {\n  timestamp: Date;\n  level: 'info' | 'error' | 'warning' | 'debug';\n  message: string;\n  source: 'system' | 'tool' | 'agent';\n  metadata?: unknown;\n}\n```\n\n#### 4. `backend/src/features/executions/tests/executions.handler.test.ts`\n**Purpose**: Test coverage for new endpoints\n**Pattern**: Follow `backend/src/features/dashboard/handler/dashboard.handler.test.ts`\n\n### Backend Files (Modified)\n\n#### 5. `backend/src/app.ts`\n**Location**: Around line 138 (after dashboard handler)\n**Change**: Register execution routes\n```typescript\n// Execution logs routes\nawait app.register(executionsHandler, {\n  prefix: \"/api/executions\",\n  db,\n  config,\n});\n```\n\n### Frontend Files (New)\n\n#### 6. `frontend/src/pages/ExecutionLogs.tsx`\n**Purpose**: Main page component for execution log viewer\n**Features**:\n- Execution list with filters (status, date range)\n- Execution detail view with tabs (Overview, Logs, Traces, Metrics)\n- Real-time log streaming\n- Link to Aspire dashboard\n\n**Pattern**: Combines `frontend/src/pages/Dashboard.tsx` structure with `frontend/src/pages/Containers.tsx` list/detail pattern\n\n#### 7. `frontend/src/hooks/use-executions.ts`\n**Purpose**: React Query hooks for execution data fetching\n**Hooks**:\n- `useExecutions(filters)` - Fetch execution list\n- `useExecution(id)` - Fetch single execution\n- `useExecutionTraces(id)` - Fetch traces for execution\n- `useExecutionLogs(id)` - Fetch formatted logs\n\n**Pattern**: Follow `frontend/src/hooks/use-containers.ts` (lines 1-190)\n\n#### 8. `frontend/src/types/execution.ts`\n**Purpose**: TypeScript interfaces matching backend types\n**Pattern**: Follow `frontend/src/types/dashboard.ts`\n\n#### 9. `frontend/src/components/executions/ExecutionList.tsx`\n**Purpose**: Display list of executions with status indicators\n**Pattern**: Follow `frontend/src/components/containers/ContainerList.tsx`\n\n#### 10. `frontend/src/components/executions/ExecutionDetail.tsx`\n**Purpose**: Detailed view with tabs for logs, traces, metrics\n\n#### 11. `frontend/src/components/executions/LogViewer.tsx`\n**Purpose**: Terminal-style log viewer using @melloware/react-logviewer\n**Features**:\n- Virtual scrolling for large logs\n- Timestamp formatting\n- Level-based color coding\n- Search/filter functionality\n\n#### 12. `frontend/src/components/executions/TraceTimeline.tsx`\n**Purpose**: Visual timeline using AgentPrism TraceViewer\n**Features**:\n- Chronological event display\n- Tool call details\n- Error highlighting\n- Duration visualization\n\n#### 13. `frontend/src/components/executions/AspireLink.tsx`\n**Purpose**: Button component to open Aspire dashboard with trace\n\n### Frontend Files (Modified)\n\n#### 14. `frontend/src/App.tsx`\n**Location**: Line 32 (after existing routes)\n**Change**: Add execution logs routes\n```typescript\n\u003cRoute path=\"/executions\" element={\u003cExecutionLogs /\u003e} /\u003e\n\u003cRoute path=\"/executions/:id\" element={\u003cExecutionLogs /\u003e} /\u003e\n```\n\n#### 15. `frontend/src/components/Layout.tsx`\n**Location**: Line 14-20 (NAV_ITEMS array)\n**Change**: Add navigation item\n```typescript\nimport { ScrollText } from \"lucide-react\";\n// In NAV_ITEMS:\n{ to: \"/executions\", label: \"Execution Logs\", icon: ScrollText },\n```\n\n---\n\n## 5. Proposed Solution Approach\n\n### High-Level Strategy\n\nBuild a hybrid solution combining:\n1. **AgentPrism** for structured trace visualization\n2. **@melloware/react-logviewer** for console output\n3. **Aspire Dashboard** deep-linking for advanced analysis\n\nThis leverages best-in-class tools for each concern while maintaining consistency with the existing codebase architecture.\n\n### Component Architecture\n\n```\nExecutionLogs Page\n├── ExecutionList (left sidebar)\n│   ├── Filter controls (status, date range)\n│   └── Execution cards (status, duration, metrics)\n│\n└── ExecutionDetail (main content)\n    ├── Metadata sidebar\n    │   ├── Execution info\n    │   ├── Metrics summary\n    │   └── AspireLink button\n    │\n    └── Tabbed content\n        ├── Trace tab (AgentPrism TraceViewer)\n        ├── Logs tab (@melloware/react-logviewer)\n        └── Metrics tab (charts/stats)\n```\n\n### Data Flow\n\n```\nFrontend                    Backend                     Data Sources\n--------                    -------                     ------------\nuseExecutions() ──────────\u003e GET /api/executions ──────\u003e agentExecutions table\n                           (filters, pagination)\n\nuseExecution(id) ─────────\u003e GET /api/executions/:id ──\u003e agentExecutions + traces\n                                                         (JOIN query)\n\nuseExecutionTraces(id) ──\u003e GET /api/executions/:id/traces -\u003e ObservabilityService\n                           (formatted for AgentPrism)      .getTraces()\n\nuseExecutionLogs(id) ────\u003e GET /api/executions/:id/logs -\u003e Format output.logs\n                           (formatted for LazyLog)         + traces as log entries\n\nAspireLink ──────────────\u003e GET /api/executions/:id/trace-url\n                           Returns: http://localhost:18888/traces/{traceId}\n```\n\n### Technology Choices\n\n#### Primary Libraries\n1. **@agent-prism/data** + **@agent-prism/ui** (via degit)\n   - Rationale: Purpose-built for AI agent traces, OpenTelemetry native, perfect stack match\n   - Installation: Copy components + install data adapter\n   - Risk: Alpha status, requires React 19\n   - Mitigation: Fallback to custom tree view with MUI X if needed\n\n2. **@melloware/react-logviewer**\n   - Rationale: Best-in-class log viewer, handles large files, real-time streaming\n   - Installation: npm package\n   - Risk: Minimal, stable and actively maintained\n\n3. **TanStack Query** (already in use)\n   - Real-time polling for running executions (`refetchInterval`)\n   - Cache management for completed executions\n   - Optimistic updates for status changes\n\n#### Supporting Libraries\n- **react-json-pretty** (AgentPrism dependency) - JSON payload display\n- **lucide-react** (already in use) - Icons for UI\n- **Radix UI** (AgentPrism dependency) - Accessible components\n\n### Implementation Steps\n\n#### Phase 1: Backend Foundation\n1. Create `execution-log.service.ts` with business logic\n   - Implement `getExecutionWithTraces()`\n   - Implement `formatExecutionLogs()` to transform database traces into log entries\n   - Implement `generateAspireTraceUrl()` using config.aspireUrl\n2. Create `executions.handler.ts` with API endpoints\n   - Use Zod schemas for validation\n   - Follow error handling pattern from agent-runtime.handler\n3. Register routes in `app.ts`\n4. Write unit tests for service and handler\n\n#### Phase 2: Frontend Data Layer\n1. Create `types/execution.ts` with TypeScript interfaces\n   - Mirror backend types\n   - Add date parsing helpers\n2. Create `hooks/use-executions.ts` with query hooks\n   - Implement polling for running executions\n   - Add query key factory pattern\n3. Test API integration with backend\n\n#### Phase 3: Frontend Components\n1. Install AgentPrism components\n   ```bash\n   npx degit evilmartians/agent-prism/packages/ui/src/components frontend/src/components/agent-prism\n   npm install @agent-prism/data @agent-prism/types react-json-pretty\n   ```\n2. Install log viewer\n   ```bash\n   npm install @melloware/react-logviewer\n   ```\n3. Create `ExecutionList` component\n   - Filter controls for status, date range\n   - Card layout with status badges\n4. Create `LogViewer` component (wrapper for LazyLog)\n   - Configure styling to match app theme\n   - Add search controls\n5. Create `TraceTimeline` component (wrapper for AgentPrism)\n   - Transform API data to AgentPrism format\n   - Configure styling\n6. Create `ExecutionDetail` component\n   - Compose LogViewer + TraceTimeline in tabs\n   - Add metadata sidebar\n7. Create `ExecutionLogs` page\n   - Combine ExecutionList + ExecutionDetail\n   - Handle routing between list/detail views\n\n#### Phase 4: Integration \u0026 Polish\n1. Add routes and navigation in `App.tsx` and `Layout.tsx`\n2. Implement real-time WebSocket updates (optional)\n3. Add error boundaries and loading states\n4. Performance optimization\n   - Virtual scrolling if needed\n   - Pagination for execution list\n5. Accessibility audit\n6. Write integration tests\n\n---\n\n## 6. Next Steps\n\n### Prerequisites\n1. **Decision: React 19 upgrade**\n   - AgentPrism requires React 19+\n   - Current codebase may be on React 18\n   - Options:\n     - Upgrade to React 19 (recommended if no blockers)\n     - Use fallback solution (MUI X Tree View + custom components)\n   - **Action**: Check `frontend/package.json` for React version\n\n2. **Aspire Dashboard configuration**\n   - Ensure Aspire is accessible at expected URL\n   - Verify OTLP traces are flowing correctly\n   - **Action**: Test existing trace ingestion\n\n3. **Database schema review**\n   - Confirm trace data contains necessary fields\n   - Consider adding index on `traces.timestamp` for performance\n   - **Action**: Run sample queries to verify data structure\n\n### Implementation Order\n1. **Backend first** (1-2 days)\n   - Enables frontend development with real data\n   - Can test with curl/Postman\n\n2. **Frontend data layer** (1 day)\n   - Hooks and types\n   - Test API integration\n\n3. **Frontend UI** (2-3 days)\n   - Components in isolation\n   - Integration into page\n\n4. **Polish \u0026 testing** (1-2 days)\n   - Edge cases\n   - Performance optimization\n   - User testing\n\n### Testing Considerations\n\n#### Unit Tests\n- Service methods (log formatting, URL generation)\n- API endpoints (responses, error handling)\n- React hooks (data parsing, query management)\n\n#### Integration Tests\n- End-to-end flow: Create execution → View logs → Click Aspire link\n- Real-time updates for running executions\n- Performance with large datasets (1000+ trace events)\n\n#### Edge Cases\n- Execution with no traces\n- Execution with only error traces\n- Missing OpenTelemetry trace IDs\n- Malformed log data in output JSON\n- Concurrent executions\n- Very large log files (\u003e100MB)\n\n### Risks \u0026 Mitigation\n\n| Risk | Impact | Probability | Mitigation |\n|------|--------|-------------|------------|\n| AgentPrism requires React 19 | High | Medium | Check version first; have fallback plan with MUI X Tree View |\n| Performance with large traces | Medium | High | Implement virtual scrolling; paginate traces endpoint |\n| Aspire URL format changes | Low | Low | Make URL pattern configurable; test with current version |\n| OTLP trace ID mismatch | Medium | Medium | Store OTLP trace ID as metadata; fallback to timestamp search |\n| Real-time WebSocket overhead | Low | Low | Batch updates every 500ms; implement client buffering |\n\n### Performance Targets\n- Execution list loads in \u003c500ms (50 executions)\n- Trace visualization renders in \u003c1s (500 spans)\n- Log viewer handles 10,000 lines without lag\n- Real-time updates have \u003c2s latency\n- Search/filter operations complete in \u003c200ms\n\n### Security Considerations\n- **No authentication currently exists** - Development only\n- For production: Add session-based auth before exposing logs\n- **Log sanitization**: Implement redaction for sensitive data (API keys, tokens, PII)\n- **Access control**: Consider per-user or per-workspace execution visibility\n- **Rate limiting**: Protect log streaming endpoints\n\n---\n\n## 7. Appendix\n\n### Reference Implementation\n\nComplete example of the recommended hybrid approach:\n\n```typescript\n// frontend/src/pages/ExecutionLogs.tsx\nimport { useParams } from 'react-router-dom';\nimport { useExecution, useExecutionTraces } from '@/hooks/use-executions';\nimport { TraceViewer } from '@/components/agent-prism';\nimport { LazyLog } from '@melloware/react-logviewer';\nimport { otlpToTraces } from '@agent-prism/data/otlp';\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs';\nimport { Button } from '@/components/ui/button';\nimport { ExternalLink } from 'lucide-react';\n\nexport function ExecutionLogs() {\n  const { id } = useParams\u003c{ id: string }\u003e();\n\n  // Fetch execution metadata\n  const { data: execution, isLoading } = useExecution(id!, {\n    refetchInterval: (query) =\u003e\n      query.state.data?.status === 'running' ? 2000 : false,\n  });\n\n  // Fetch trace data for AgentPrism\n  const { data: otlpData } = useExecutionTraces(id!);\n  const traces = otlpData ? otlpToTraces(otlpData) : undefined;\n\n  // Generate Aspire dashboard URL\n  const aspireUrl = execution?.traceId\n    ? `http://localhost:18888/traces/${execution.traceId}`\n    : null;\n\n  if (isLoading) return \u003cdiv\u003eLoading...\u003c/div\u003e;\n  if (!execution) return \u003cdiv\u003eExecution not found\u003c/div\u003e;\n\n  return (\n    \u003cdiv className=\"grid grid-cols-12 gap-6 p-6\"\u003e\n      {/* Sidebar: Metadata */}\n      \u003cdiv className=\"col-span-3 space-y-4\"\u003e\n        \u003cdiv className=\"rounded-lg border p-4\"\u003e\n          \u003ch3 className=\"font-semibold mb-2\"\u003eExecution Info\u003c/h3\u003e\n          \u003cdl className=\"space-y-2 text-sm\"\u003e\n            \u003cdiv\u003e\n              \u003cdt className=\"text-muted-foreground\"\u003eStatus\u003c/dt\u003e\n              \u003cdd\u003e\n                \u003cStatusBadge status={execution.status} /\u003e\n              \u003c/dd\u003e\n            \u003c/div\u003e\n            \u003cdiv\u003e\n              \u003cdt className=\"text-muted-foreground\"\u003eDuration\u003c/dt\u003e\n              \u003cdd\u003e{execution.durationMs}ms\u003c/dd\u003e\n            \u003c/div\u003e\n            \u003cdiv\u003e\n              \u003cdt className=\"text-muted-foreground\"\u003eTokens\u003c/dt\u003e\n              \u003cdd\u003e{execution.tokensUsed?.toLocaleString()}\u003c/dd\u003e\n            \u003c/div\u003e\n            \u003cdiv\u003e\n              \u003cdt className=\"text-muted-foreground\"\u003eCost\u003c/dt\u003e\n              \u003cdd\u003e${execution.costUsd?.toFixed(4)}\u003c/dd\u003e\n            \u003c/div\u003e\n          \u003c/dl\u003e\n        \u003c/div\u003e\n\n        {aspireUrl \u0026\u0026 (\n          \u003cButton\n            variant=\"outline\"\n            className=\"w-full\"\n            onClick={() =\u003e window.open(aspireUrl, '_blank')}\n          \u003e\n            \u003cExternalLink className=\"w-4 h-4 mr-2\" /\u003e\n            View in Aspire\n          \u003c/Button\u003e\n        )}\n      \u003c/div\u003e\n\n      {/* Main content: Tabs */}\n      \u003cdiv className=\"col-span-9\"\u003e\n        \u003cTabs defaultValue=\"trace\" className=\"w-full\"\u003e\n          \u003cTabsList\u003e\n            \u003cTabsTrigger value=\"trace\"\u003eExecution Trace\u003c/TabsTrigger\u003e\n            \u003cTabsTrigger value=\"logs\"\u003eConsole Output\u003c/TabsTrigger\u003e\n            \u003cTabsTrigger value=\"metrics\"\u003eMetrics\u003c/TabsTrigger\u003e\n          \u003c/TabsList\u003e\n\n          \u003cTabsContent value=\"trace\" className=\"mt-4\"\u003e\n            {traces ? (\n              \u003cdiv className=\"rounded-lg border p-4\"\u003e\n                \u003cTraceViewer traces={traces} /\u003e\n              \u003c/div\u003e\n            ) : (\n              \u003cdiv\u003eNo trace data available\u003c/div\u003e\n            )}\n          \u003c/TabsContent\u003e\n\n          \u003cTabsContent value=\"logs\" className=\"mt-4\"\u003e\n            \u003cdiv className=\"rounded-lg border overflow-hidden\"\u003e\n              \u003cLazyLog\n                url={`/api/executions/${id}/logs`}\n                height={600}\n                enableSearch\n                stream={execution.status === 'running'}\n                follow={execution.status === 'running'}\n              /\u003e\n            \u003c/div\u003e\n          \u003c/TabsContent\u003e\n\n          \u003cTabsContent value=\"metrics\" className=\"mt-4\"\u003e\n            \u003cMetricsView execution={execution} /\u003e\n          \u003c/TabsContent\u003e\n        \u003c/Tabs\u003e\n      \u003c/div\u003e\n    \u003c/div\u003e\n  );\n}\n```\n\n### OpenTelemetry Data Structure\n\nExample of expected trace data format:\n\n```json\n{\n  \"resourceSpans\": [{\n    \"resource\": {\n      \"attributes\": [\n        { \"key\": \"service.name\", \"value\": { \"stringValue\": \"agent-executor\" }}\n      ]\n    },\n    \"scopeSpans\": [{\n      \"spans\": [\n        {\n          \"traceId\": \"a1b2c3d4e5f6g7h8\",\n          \"spanId\": \"span123\",\n          \"parentSpanId\": \"span122\",\n          \"name\": \"tool_call: WebSearch\",\n          \"kind\": \"SPAN_KIND_INTERNAL\",\n          \"startTimeUnixNano\": \"1640000000000000000\",\n          \"endTimeUnixNano\": \"1640000002000000000\",\n          \"attributes\": [\n            { \"key\": \"tool.name\", \"value\": { \"stringValue\": \"WebSearch\" }},\n            { \"key\": \"tool.input\", \"value\": { \"stringValue\": \"{\\\"query\\\":\\\"opentelemetry\\\"}\" }}\n          ],\n          \"events\": [\n            {\n              \"timeUnixNano\": \"1640000001000000000\",\n              \"name\": \"tool.result\",\n              \"attributes\": [\n                { \"key\": \"result.count\", \"value\": { \"intValue\": \"10\" }}\n              ]\n            }\n          ],\n          \"status\": { \"code\": \"STATUS_CODE_OK\" }\n        }\n      ]\n    }]\n  }]\n}\n```\n\n### Configuration\n\nEnvironment variables needed:\n\n```bash\n# Backend\nOTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317\nASPIRE_DASHBOARD_URL=http://localhost:18888\n\n# Frontend (if using direct OTLP export)\nVITE_OTEL_EXPORTER_URL=http://localhost:4317\nVITE_ASPIRE_DASHBOARD_URL=http://localhost:18888\n```\n\n---\n\n## Research Sources\n\n### AI Agent Observability\n- [AI Agent Monitoring Best Practices 2025](https://uptimerobot.com/knowledge-hub/monitoring/ai-agent-monitoring-best-practices-tools-and-metrics/)\n- [OpenTelemetry AI Agent Observability](https://opentelemetry.io/blog/2025/ai-agent-observability/)\n- [10 Best Tools to Monitor AI Agents](https://medium.com/@kuldeep.paul08/10-best-tools-to-monitor-ai-agents-in-2025-and-why-observability-matters-72657ddc241b)\n- [Microsoft Azure Agent Observability Best Practices](https://azure.microsoft.com/en-us/blog/agent-factory-top-5-agent-observability-best-practices-for-reliable-ai/)\n\n### AgentPrism\n- [AgentPrism GitHub](https://github.com/evilmartians/agent-prism)\n- [AgentPrism Announcement - Evil Martians](https://evilmartians.com/chronicles/debug-ai-fast-agent-prism-open-source-library-visualize-agent-traces)\n\n### React Log Viewer\n- [@melloware/react-logviewer npm](https://www.npmjs.com/package/@melloware/react-logviewer)\n- [@melloware/react-logviewer GitHub](https://github.com/melloware/react-logviewer)\n- [Storybook Demo](https://melloware.github.io/react-logviewer/)\n\n### OpenTelemetry\n- [OpenTelemetry Traces Concept](https://opentelemetry.io/docs/concepts/signals/traces/)\n- [Understanding OpenTelemetry Spans](https://signoz.io/blog/opentelemetry-spans/)\n- [OpenTelemetry React Implementation](https://signoz.io/blog/opentelemetry-react/)\n\n### Aspire Dashboard\n- [.NET Aspire Telemetry Documentation](https://learn.microsoft.com/en-us/dotnet/aspire/fundamentals/telemetry)\n- [Aspire Dashboard for OpenTelemetry](https://anthonysimmon.com/dotnet-aspire-dashboard-best-tool-visualize-opentelemetry-local-dev/)\n- [OpenTelemetry with Aspire Dashboard](https://medium.com/@gunaycoskunn/opentelemetry-with-aspire-dashboard-b433a405db1f)\n\n### Performance \u0026 Virtualization\n- [React Virtuoso Documentation](https://virtuoso.dev/)\n- [React Virtualization Comparison](https://dev.to/sanamumtaz/react-virtualization-react-window-vs-react-virtuoso-8g)\n\n### Jaeger UI\n- [Jaeger UI GitHub](https://github.com/jaegertracing/jaeger-ui)\n- [jaeger-react-trace-component](https://www.npmjs.com/package/jaeger-react-trace-component)\n\n### TanStack Query\n- [TanStack Query and WebSockets](https://blog.logrocket.com/tanstack-query-websockets-real-time-react-data-fetching/)\n- [Using WebSockets with React Query](https://tkdodo.eu/blog/using-web-sockets-with-react-query)\n\n---\n\n**End of Research Document**\n","created_at":"2025-12-24T23:38:42Z"}]}
{"id":"agent-ops-kpr.3","title":"PR and issue links","description":"Display links to GitHub issues and PRs for each work item. Quick navigation between agent-ops and GitHub for review.","design":"# Implementation Plan: GitHub Issue and PR Links for Work Items\n\n## Overview\n\nAdd clickable GitHub issue and PR links to work items throughout the agent-ops dashboard. This enables quick navigation between the internal work tracking system and GitHub for code review and issue management. The implementation adds PR fields to the database schema, saves PR URLs when creating pull requests, and displays links in the Kanban board TaskCard component.\n\n## FACTS Validation Summary\n\n- **Feasibility**: High - All required infrastructure exists (GitHub OAuth, PR service, lucide-react icons). Schema migration pattern is well-established.\n- **Atomicity**: High - Each task is focused on a single file or behavior change. TDD approach ensures clear boundaries.\n- **Clarity**: High - Tasks reference specific files, line numbers, and existing patterns. Code examples provided in research.\n- **Testability**: High - Each phase includes specific test cases. Existing test patterns (Dashboard.test.tsx) provide templates.\n- **Scope**: High - Four phases, each producing a committable milestone. Maximum 8 tasks per phase.\n\n## Prerequisites\n\n1. Backend development environment configured (`npm install` in `/backend`)\n2. Frontend development environment configured (`npm install` in `/frontend`)\n3. Drizzle ORM CLI available for migrations (`npx drizzle-kit`)\n4. SQLite database accessible at configured path\n5. Vitest configured for frontend testing (already set up in `frontend/vitest.config.ts`)\n\n---\n\n## Phase 1: Database Schema Extension\n\n**Goal**: Add `githubPrNumber` and `githubPrUrl` fields to the work_items table.\n\n**Committable State**: Database schema supports PR tracking. Migration file ready for deployment.\n\n**Context**:\n- Schema file: `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/shared/db/schema.ts` (lines 90-140)\n- Existing issue fields: `githubIssueNumber` (line 99), `githubIssueUrl` (line 100)\n- Migration journal: `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/shared/db/migrations/meta/_journal.json`\n- Migration example: `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/shared/db/migrations/0003_true_psylocke.sql`\n\n**Tasks**:\n\n- [ ] Add `githubPrNumber` field to work_items schema in `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/shared/db/schema.ts` (after line 100)\n  ```typescript\n  githubPrNumber: integer(\"github_pr_number\"),\n  githubPrUrl: text(\"github_pr_url\"),\n  ```\n\n- [ ] Generate database migration using Drizzle Kit\n  ```bash\n  cd /Users/probinson/Repos/on-par/saas/agent-ops/backend \u0026\u0026 npx drizzle-kit generate\n  ```\n\n- [ ] Verify migration SQL is correct (adds two nullable columns to work_items)\n\n- [ ] Run migration against development database\n  ```bash\n  cd /Users/probinson/Repos/on-par/saas/agent-ops/backend \u0026\u0026 npx drizzle-kit push\n  ```\n\n- [ ] Update work-item model schema in `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/work-items/models/work-item.ts` (after line 141)\n  ```typescript\n  // GitHub PR tracking (for agent-created PRs)\n  githubPrNumber: z.number().int().optional().describe(\"GitHub PR number\"),\n  githubPrUrl: z.string().url().optional().describe(\"GitHub PR URL\"),\n  ```\n\n---\n\n## Phase 2: Backend PR URL Storage\n\n**Goal**: Update the PR service to save PR URL and number back to the work item after creation.\n\n**Committable State**: Creating a PR via the service automatically records the PR URL in the database.\n\n**Context**:\n- PR service: `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/pull-requests/services/github-pr.service.ts`\n- `createPullRequest` method (lines 39-87) returns `PRResult` with `htmlUrl` and `number`\n- WorkItemRepository: `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/work-items/repositories/work-item.repository.ts`\n- Update method available (line 108)\n\n**Tasks**:\n\n- [ ] **[TDD Red]** Create test file `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/pull-requests/tests/github-pr.service.test.ts`\n  - Test: `createPullRequest should save PR URL and number to work item`\n  - Mock: Octokit PR creation, WorkItemRepository.update\n  - Assert: `workItemRepo.update` called with `{ githubPrNumber: 123, githubPrUrl: 'https://...' }`\n\n- [ ] **[TDD Green]** Update `createPullRequest` method in `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/pull-requests/services/github-pr.service.ts` (after line 86)\n  ```typescript\n  // Save PR details back to work item\n  await this.workItemRepo.update(workItemId, {\n    githubPrNumber: pr.number,\n    githubPrUrl: pr.html_url,\n  });\n  ```\n\n- [ ] **[TDD Red]** Add test: `createPullRequest should not fail if work item update fails`\n  - Mock: workItemRepo.update to throw\n  - Assert: Method still returns PRResult (log warning, don't throw)\n\n- [ ] **[TDD Green]** Wrap work item update in try-catch with warning log\n\n- [ ] [P] Verify existing handler tests still pass\n  ```bash\n  cd /Users/probinson/Repos/on-par/saas/agent-ops/backend \u0026\u0026 npm test\n  ```\n\n---\n\n## Phase 3: Frontend GitHubLinks Component\n\n**Goal**: Create a reusable `GitHubLinks` component with proper accessibility and event handling.\n\n**Committable State**: Component renders GitHub links with proper styling, ARIA labels, and event propagation handling.\n\n**Context**:\n- Component location: `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/GitHubLinks.tsx` (new file)\n- Test location: `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/GitHubLinks.test.tsx` (new file)\n- Icon imports: `Github`, `GitPullRequest`, `ExternalLink` from lucide-react\n- Styling reference: `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/containers/ContainerCard.tsx` (button styling)\n- Test pattern: `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/pages/Dashboard.test.tsx`\n\n**Tasks**:\n\n- [ ] **[TDD Red]** Create test file `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/GitHubLinks.test.tsx`\n  ```typescript\n  describe('GitHubLinks', () =\u003e {\n    it('should return null when no URLs provided');\n    it('should render issue link with correct href and aria-label');\n    it('should render PR link with correct href and aria-label');\n    it('should render both links when both URLs provided');\n    it('should have rel=\"noopener noreferrer\" on links');\n    it('should stop event propagation on click');\n  });\n  ```\n\n- [ ] **[TDD Green]** Create component `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/GitHubLinks.tsx`\n  ```typescript\n  interface GitHubLinksProps {\n    issueNumber?: number;\n    issueUrl?: string;\n    prNumber?: number;\n    prUrl?: string;\n    className?: string;\n  }\n  \n  export function GitHubLinks({ issueNumber, issueUrl, prNumber, prUrl, className }: GitHubLinksProps) {\n    // Return null if no links\n    // Render icons with links\n    // Use e.stopPropagation() on click handlers\n    // Include aria-labels: \"View GitHub issue #N\" / \"View pull request #N\"\n  }\n  ```\n\n- [ ] **[TDD Refactor]** Ensure component follows existing styling patterns (var(--cyan-glow), hover states)\n\n- [ ] Update frontend types in `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/types/dashboard.ts` (after line 80)\n  ```typescript\n  // Add to WorkItem interface\n  githubPrNumber?: number;\n  githubPrUrl?: string;\n  ```\n\n- [ ] Run frontend tests to verify\n  ```bash\n  cd /Users/probinson/Repos/on-par/saas/agent-ops/frontend \u0026\u0026 npm test\n  ```\n\n---\n\n## Phase 4: Kanban Board Integration\n\n**Goal**: Integrate GitHubLinks component into the Kanban TaskCard and connect to real API data.\n\n**Committable State**: Kanban board displays GitHub issue and PR links on work items. Links navigate to GitHub correctly.\n\n**Context**:\n- Kanban page: `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/pages/Kanban.tsx`\n- TaskCard component: lines 145-202\n- Mock data: lines 16-123 (to be replaced with API integration)\n- API client: `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/lib/api.ts`\n\n**Tasks**:\n\n- [ ] Import GitHubLinks in `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/pages/Kanban.tsx`\n  ```typescript\n  import { GitHubLinks } from '../components/GitHubLinks';\n  ```\n\n- [ ] Update TaskCard interface to include GitHub fields\n  ```typescript\n  interface Task {\n    id: string;\n    title: string;\n    description: string;\n    priority: string;\n    agent: string | null;\n    tags: string[];\n    githubIssueNumber?: number;\n    githubIssueUrl?: string;\n    githubPrNumber?: number;\n    githubPrUrl?: string;\n  }\n  ```\n\n- [ ] Add GitHubLinks to TaskCard component (after tags section, before Agent section ~line 183)\n  ```tsx\n  {/* GitHub Links */}\n  \u003cGitHubLinks\n    issueNumber={task.githubIssueNumber}\n    issueUrl={task.githubIssueUrl}\n    prNumber={task.githubPrNumber}\n    prUrl={task.githubPrUrl}\n    className=\"mb-3\"\n  /\u003e\n  ```\n\n- [ ] Update mock data to include sample GitHub links for testing UI\n  ```typescript\n  {\n    id: \"task-7\",\n    title: \"PR #247: User authentication\",\n    githubIssueNumber: 245,\n    githubIssueUrl: \"https://github.com/example/repo/issues/245\",\n    githubPrNumber: 247,\n    githubPrUrl: \"https://github.com/example/repo/pull/247\",\n    // ... other fields\n  }\n  ```\n\n- [ ] [P] Create Kanban.test.tsx with basic component rendering test\n  ```typescript\n  it('should render TaskCard with GitHub links when present');\n  it('should not render GitHub links when absent');\n  ```\n\n- [ ] Verify full application builds and runs\n  ```bash\n  cd /Users/probinson/Repos/on-par/saas/agent-ops/frontend \u0026\u0026 npm run build\n  ```\n\n- [ ] Manual verification: Navigate to Kanban board and confirm links appear and work\n\n---\n\n## Validation Checklist\n\nAfter completing all phases, verify:\n\n- [ ] All backend tests passing: `cd backend \u0026\u0026 npm test`\n- [ ] All frontend tests passing: `cd frontend \u0026\u0026 npm test`\n- [ ] TypeScript compilation clean: `cd frontend \u0026\u0026 npm run build`\n- [ ] Database migration applied successfully\n- [ ] GitHubLinks component renders correctly on Kanban board\n- [ ] Links open in new tab with proper security attributes\n- [ ] Links do not trigger card selection (event propagation stopped)\n- [ ] Screen reader announces links correctly (ARIA labels)\n- [ ] Styling consistent with existing UI (cyan glow, hover states)\n\n---\n\n## Files Modified Summary\n\n### Backend (3 files + 1 migration)\n1. `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/shared/db/schema.ts` - Add PR fields\n2. `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/work-items/models/work-item.ts` - Add PR fields to Zod schema\n3. `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/pull-requests/services/github-pr.service.ts` - Save PR URL after creation\n4. Migration file (auto-generated) - Add columns to work_items table\n\n### Backend Tests (1 new file)\n1. `/Users/probinson/Repos/on-par/saas/agent-ops/backend/src/features/pull-requests/tests/github-pr.service.test.ts` - PR service tests\n\n### Frontend (4 files)\n1. `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/types/dashboard.ts` - Add PR fields to WorkItem type\n2. `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/GitHubLinks.tsx` - New component\n3. `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/components/GitHubLinks.test.tsx` - Component tests\n4. `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/pages/Kanban.tsx` - Integrate component\n\n### Frontend Tests (1 new file)\n1. `/Users/probinson/Repos/on-par/saas/agent-ops/frontend/src/pages/Kanban.test.tsx` - Kanban integration tests\n\n---\n\n## Risk Mitigation\n\n1. **Database Migration**: The new columns are nullable, so existing data is unaffected. Rollback is safe.\n2. **PR Service Failure**: The update is wrapped in try-catch so PR creation succeeds even if recording fails.\n3. **Frontend Backward Compatibility**: GitHubLinks returns null when no URLs provided, so existing cards display normally.\n4. **Event Propagation**: Explicit stopPropagation() prevents link clicks from triggering card interactions.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-23T20:18:19.281504-06:00","updated_at":"2025-12-24T18:12:58.512716-06:00","labels":["github","ui"],"dependencies":[{"issue_id":"agent-ops-kpr.3","depends_on_id":"agent-ops-kpr","type":"parent-child","created_at":"2025-12-23T20:18:19.282651-06:00","created_by":"daemon"}],"comments":[{"id":4,"issue_id":"agent-ops-kpr.3","author":"probinson","text":"# Research: GitHub Issue and PR Links for Work Items\n\n**Issue**: agent-ops-kpr.3\n**Date**: 2025-12-24\n**Status**: Research Complete\n\n## 1. Problem Overview\n\n### Problem Statement\nDisplay links to GitHub issues and PRs for each work item in the agent-ops dashboard, enabling quick navigation between agent-ops and GitHub for review.\n\n### Key Objectives\n- Add GitHub issue and PR links to work item displays\n- Provide visual indicators for external links\n- Ensure accessibility and security best practices\n- Follow existing UI patterns and GitHub design standards\n- Enable quick navigation between agent-ops and GitHub\n\n### Success Criteria\n- GitHub issue URLs are displayed when available\n- GitHub PR URLs are displayed when available\n- Links open in new tabs with proper security attributes\n- Visual indicators (icons) show links are external\n- Accessible to screen readers with proper ARIA labels\n- Consistent with existing UI patterns\n- Works across Dashboard and Kanban board views\n\n## 2. Web Research Findings\n\n### Best Practices for GitHub Links\n\n#### Security Best Practices\nAll external links must include both security attributes:\n```html\n\u003ca target=\"_blank\" rel=\"noopener noreferrer\"\u003e\n```\n\n- **noopener**: Prevents `window.opener` access (prevents security vulnerabilities)\n- **noreferrer**: Prevents referrer information leakage (privacy protection)\n- Modern browsers (2021+) add `noopener` by default, but include for older browser support\n\n#### Accessibility Requirements (WCAG 2.2)\n\n**WCAG 2.4.4 (Link Purpose in Context)**:\n- Link text or `aria-label` must clearly describe the destination\n- Example: `aria-label=\"Issue #123, open (opens in new tab)\"`\n\n**WCAG 2.5.3 (Label in Name)**:\n- Visible text should be included in accessible name\n- Start `aria-label` with visible text\n\n**Icon Accessibility**:\n- Use `aria-hidden=\"true\"` on decorative icons\n- Icons should supplement, not replace, text labels\n\n**Color Contrast**:\n- Ensure all state colors meet WCAG AA standards\n- GitHub Primer colors are WCAG compliant\n\n#### GitHub URL Patterns\n\nSupported GitHub URL formats:\n```typescript\nconst patterns = {\n  https: 'https://github.com/owner/repo/issues/123',\n  ssh: 'git@github.com:owner/repo.git',\n  git: 'git://github.com/owner/repo.git',\n  shorthand: '#123',              // Same repo\n  crossRepo: 'owner/repo#123',    // Different repo\n  fullHash: 'GH-123',             // Alternative format\n};\n```\n\nRegex for parsing:\n```typescript\nconst regex = /github\\.com\\/([^\\/]+)\\/([^\\/]+)\\/(issues|pull)\\/(\\d+)/;\n```\n\n#### GitHub Primer Design System Colors\n\nOfficial GitHub state colors:\n```typescript\nconst GITHUB_COLORS = {\n  open: {\n    fg: '#1a7f37',      // Green\n    bg: '#dafbe1',\n    border: '#1a7f37'\n  },\n  closed: {\n    fg: '#d1242f',      // Red (unmerged closed PRs)\n    bg: '#ffebe9',\n    border: '#cf222e'\n  },\n  done: {               // Merged PRs\n    fg: '#8250df',      // Purple\n    bg: '#fbefff',\n    border: '#8250df'\n  },\n  draft: {\n    fg: '#59636e',      // Gray\n    bg: '#818b981f',\n    border: '#59636e'\n  }\n};\n```\n\nNote: GitHub changed closed issue icons from red to purple in October 2021.\n\n### Recommended Component Pattern\n\n**Basic GitHub Link Component**:\n```typescript\nimport { ExternalLink, Github } from 'lucide-react';\n\ninterface GitHubLinkProps {\n  url: string;\n  type: 'issue' | 'pr';\n  number?: number;\n  className?: string;\n}\n\nexport const GitHubLink: React.FC\u003cGitHubLinkProps\u003e = ({\n  url,\n  type,\n  number,\n  className = ''\n}) =\u003e {\n  const displayText = number ? `${type === 'issue' ? '#' : 'PR #'}${number}` : 'View on GitHub';\n\n  return (\n    \u003ca\n      href={url}\n      target=\"_blank\"\n      rel=\"noopener noreferrer\"\n      className={`inline-flex items-center gap-1 text-blue-600 hover:text-blue-800 hover:underline ${className}`}\n      aria-label={`${displayText} (opens in new tab)`}\n    \u003e\n      \u003cGithub size={14} aria-hidden=\"true\" /\u003e\n      \u003cspan\u003e{displayText}\u003c/span\u003e\n      \u003cExternalLink size={12} aria-hidden=\"true\" /\u003e\n    \u003c/a\u003e\n  );\n};\n```\n\n### UI/UX Patterns\n\n**Visual Indicators**:\n- GitHub icon to show it's a GitHub link\n- ExternalLink icon to indicate opens in new tab\n- Hover effects for interactivity\n- Subtle color changes on hover\n\n**Layout Patterns**:\n- Inline links within card metadata\n- Badge-style links for prominent display\n- Icon-only links for compact layouts\n\n**Best Practices**:\n- Keep links visually distinct but not overwhelming\n- Group related links (issue + PR) together\n- Use tooltips for additional context if needed\n- Prevent link clicks from triggering parent actions (e.g., card selection)\n\n## 3. Codebase Analysis\n\n### Current Database Schema\n\n**Schema file**: `backend/src/shared/db/schema.ts`\n\nThe work_items table **already includes GitHub issue fields**:\n```typescript\n// Line 97-100\nrepositoryId: integer(\"repository_id\"),\ngithubIssueNumber: integer(\"github_issue_number\"),\ngithubIssueUrl: text(\"github_issue_url\"),\n```\n\n**Missing fields for PRs**:\n```typescript\ngithubPrNumber: integer(\"github_pr_number\"),\ngithubPrUrl: text(\"github_pr_url\"),\n```\n\n### Work Item Data Model\n\n**Model file**: `backend/src/features/work-items/models/work-item.ts`\n\nCurrent interface needs PR fields added:\n```typescript\nexport interface WorkItem {\n  // ... existing fields\n  githubIssueNumber?: number;\n  githubIssueUrl?: string;\n  // Add:\n  githubPrNumber?: number;\n  githubPrUrl?: string;\n}\n```\n\n### UI Components Displaying Work Items\n\n#### 1. Dashboard (`frontend/src/pages/Dashboard.tsx`)\n- Line 102-147: \"Up Next Queue\" section\n- Currently uses mock data\n- Shows basic work item cards\n- **Impact**: Low priority - mostly aggregate stats\n\n#### 2. Kanban Board (`frontend/src/pages/Kanban.tsx`) ⭐ **PRIMARY TARGET**\n- Line 145-186: TaskCard component\n- Displays individual work items in columns\n- Currently uses mock data\n- **Key integration point**: Add GitHub links here\n- **Action needed**: Replace mock data with API calls\n\n**TaskCard structure** (lines 145-186):\n```typescript\nconst TaskCard = ({ task }: { task: Task }) =\u003e {\n  return (\n    \u003cdiv className=\"...\"\u003e\n      \u003ch3\u003e{task.title}\u003c/h3\u003e\n      \u003cdiv className=\"...\"\u003e\n        \u003cspan className=\"status-badge\"\u003e{task.status}\u003c/span\u003e\n        \u003cspan className=\"priority-badge\"\u003e{task.priority}\u003c/span\u003e\n      \u003c/div\u003e\n      {/* ADD GITHUB LINKS HERE */}\n    \u003c/div\u003e\n  );\n};\n```\n\n### Frontend Type Definitions\n\n**File**: `frontend/src/types/dashboard.ts`\n\nCurrent WorkItem interface (line 72-84):\n```typescript\nexport interface WorkItem {\n  id: string;\n  title: string;\n  description?: string;\n  type: TaskType;\n  status: TaskStatus;\n  priority: TaskPriority;\n  assignedTo?: string;\n  createdAt: Date;\n  updatedAt: Date;\n  estimatedHours?: number;\n  actualHours?: number;\n  tags?: string[];\n}\n```\n\n**Needs to add**:\n```typescript\ngithubIssueNumber?: number;\ngithubIssueUrl?: string;\ngithubPrNumber?: number;\ngithubPrUrl?: string;\n```\n\n### Existing Icon Usage\n\n**lucide-react** is already used throughout the codebase:\n- Dashboard.tsx: `Settings`, `Activity`, `Clock`, `AlertCircle`, `TrendingUp`\n- Kanban.tsx: `Play`, `Pause`\n- Available icons: `Github`, `ExternalLink`, `GitPullRequest`\n\nImport pattern:\n```typescript\nimport { Github, ExternalLink } from 'lucide-react';\n```\n\n### Existing Styling Patterns\n\n**CSS Custom Properties** (from index.css):\n```css\n--text-muted: rgba(255, 255, 255, 0.6);\n--cyan-glow: #00d9ff;\n--card-bg: rgba(42, 42, 60, 0.5);\n```\n\n**Link styling pattern** (from existing code):\n```typescript\nclassName=\"text-[var(--text-muted)] hover:text-[var(--cyan-glow)] transition-colors\"\n```\n\n### API Integration\n\n**API client**: `frontend/src/lib/api.ts`\n\nExports:\n```typescript\nexport const API_BASE = \"http://localhost:3001/api\";\n```\n\n**Expected endpoint**: `GET /api/work-items/:id` or `/api/dashboard/stats`\n\n### GitHub Integration Status\n\nThe codebase has **fully implemented GitHub integration**:\n\n1. **OAuth Authentication** (`backend/src/features/github/`)\n   - `github-oauth.service.ts`: Handles OAuth flow\n   - Already configured with client ID/secret\n\n2. **GitHub Sync Service** (`backend/src/features/github/services/github-sync.service.ts`)\n   - Already populates `githubIssueUrl` when syncing issues\n   - Line 45-60: Creates/updates work items from GitHub issues\n\n3. **PR Service** (`backend/src/features/pull-requests/services/github-pr.service.ts`)\n   - Line 86: Creates PRs via GitHub API\n   - **Missing**: Doesn't save PR URL back to work item\n   - **Action needed**: Add work item update after PR creation\n\n4. **Configuration** (`backend/src/shared/config.ts`)\n   - `GITHUB_CLIENT_ID`\n   - `GITHUB_CLIENT_SECRET`\n   - `GITHUB_WEBHOOK_SECRET`\n   - All already configured\n\n### Files to Modify\n\n#### Backend (3 files + 1 migration)\n\n1. **`backend/src/shared/db/schema.ts`** (line 100, after githubIssueUrl)\n   - Add PR fields to work_items table\n\n2. **`backend/src/shared/db/migrations/XXXX_add_pr_fields.sql`** (new file)\n   - Add columns for PR number and URL\n\n3. **`backend/src/features/pull-requests/services/github-pr.service.ts`** (line 86)\n   - Update work item with PR URL after creation\n\n4. **`backend/src/features/work-items/models/work-item.ts`**\n   - Add PR fields to interface\n\n#### Frontend (3 files + 1 new component)\n\n1. **`frontend/src/types/dashboard.ts`** (line 72-84)\n   - Add GitHub PR fields to WorkItem interface\n\n2. **`frontend/src/components/GitHubLinks.tsx`** (new file)\n   - Create reusable component for displaying GitHub links\n\n3. **`frontend/src/pages/Kanban.tsx`** (line 145-186)\n   - Add GitHubLinks component to TaskCard\n   - Replace mock data with real API calls\n   - Prevent event propagation on links\n\n4. **`frontend/src/pages/Dashboard.tsx`** (optional, line 102-147)\n   - Add GitHub links to \"Up Next Queue\" items\n\n## 4. Proposed Solution Approach\n\n### High-Level Strategy\n\n**Adopt a two-phase approach**:\n\n**Phase 1: Backend Foundation** (Database + API)\n1. Add PR fields to database schema\n2. Create and run migration\n3. Update PR service to save URLs\n4. Update type definitions\n\n**Phase 2: Frontend Display** (UI Components)\n1. Create reusable GitHubLinks component\n2. Update frontend types\n3. Integrate into Kanban board\n4. Replace mock data with API calls\n\n### Technology Choices\n\n**No additional libraries needed**:\n- ✅ lucide-react (already installed) - for icons\n- ✅ React + TypeScript (existing stack)\n- ✅ Tailwind CSS or CSS custom properties (existing patterns)\n\n**Why no external GitHub link libraries**:\n- Simple URL parsing with regex is sufficient\n- No need for parse-github-url (adds 10KB for minimal benefit)\n- No need for remark-github (not rendering markdown)\n- Keep bundle size minimal\n\n### Component Design\n\n**GitHubLinks Component**:\n```typescript\ninterface GitHubLinksProps {\n  issueNumber?: number;\n  issueUrl?: string;\n  prNumber?: number;\n  prUrl?: string;\n  className?: string;\n}\n\nexport const GitHubLinks: React.FC\u003cGitHubLinksProps\u003e = ({\n  issueNumber,\n  issueUrl,\n  prNumber,\n  prUrl,\n  className = ''\n}) =\u003e {\n  if (!issueUrl \u0026\u0026 !prUrl) return null;\n\n  return (\n    \u003cdiv className={`flex items-center gap-2 text-sm ${className}`}\u003e\n      {issueUrl \u0026\u0026 (\n        \u003ca\n          href={issueUrl}\n          target=\"_blank\"\n          rel=\"noopener noreferrer\"\n          onClick={(e) =\u003e e.stopPropagation()}\n          className=\"inline-flex items-center gap-1 text-[var(--text-muted)] hover:text-[var(--cyan-glow)] transition-colors\"\n          aria-label={`GitHub Issue #${issueNumber} (opens in new tab)`}\n        \u003e\n          \u003cGithub size={14} aria-hidden=\"true\" /\u003e\n          \u003cspan\u003e#{issueNumber}\u003c/span\u003e\n          \u003cExternalLink size={12} aria-hidden=\"true\" /\u003e\n        \u003c/a\u003e\n      )}\n\n      {prUrl \u0026\u0026 (\n        \u003ca\n          href={prUrl}\n          target=\"_blank\"\n          rel=\"noopener noreferrer\"\n          onClick={(e) =\u003e e.stopPropagation()}\n          className=\"inline-flex items-center gap-1 text-[var(--text-muted)] hover:text-[var(--cyan-glow)] transition-colors\"\n          aria-label={`GitHub Pull Request #${prNumber} (opens in new tab)`}\n        \u003e\n          \u003cGitPullRequest size={14} aria-hidden=\"true\" /\u003e\n          \u003cspan\u003ePR #{prNumber}\u003c/span\u003e\n          \u003cExternalLink size={12} aria-hidden=\"true\" /\u003e\n        \u003c/a\u003e\n      )}\n    \u003c/div\u003e\n  );\n};\n```\n\n**Key design decisions**:\n- `e.stopPropagation()`: Prevents link clicks from triggering parent card actions\n- Conditional rendering: Only shows links when URLs exist\n- Consistent styling: Uses existing CSS custom properties\n- Accessibility: Proper ARIA labels for screen readers\n- Icons: Github + ExternalLink for clear visual indicators\n\n## 5. Next Steps\n\n### Prerequisites\n\n✅ **Already in place**:\n- GitHub OAuth configured\n- GitHub sync service operational\n- Database schema supports issue URLs\n- lucide-react icons installed\n- Work item data model exists\n\n⚠️ **Needs verification**:\n- Confirm work items API endpoint returns GitHub fields\n- Verify PR creation flow creates work items or links to existing ones\n\n### Implementation Order\n\n**Step 1: Database Schema** (15 minutes)\n1. Add `githubPrNumber` and `githubPrUrl` to schema\n2. Generate migration: `npm run db:generate`\n3. Run migration: `npm run db:migrate`\n4. Verify columns exist: `sqlite3 agent-ops.db \".schema work_items\"`\n\n**Step 2: Backend Updates** (30 minutes)\n1. Update `WorkItem` interface in models\n2. Update PR service to save PR URL after creation\n3. Test PR creation flow saves URL correctly\n\n**Step 3: Frontend Types** (10 minutes)\n1. Add PR fields to `frontend/src/types/dashboard.ts`\n2. Ensure type compatibility with backend\n\n**Step 4: GitHubLinks Component** (45 minutes)\n1. Create `frontend/src/components/GitHubLinks.tsx`\n2. Implement component with proper accessibility\n3. Add basic component tests (optional but recommended)\n\n**Step 5: Kanban Integration** (30 minutes)\n1. Import GitHubLinks into Kanban.tsx\n2. Add to TaskCard component\n3. Replace mock data with API calls\n4. Test link display and navigation\n\n**Step 6: Testing** (45 minutes)\n1. **Manual testing**:\n   - Create work item with GitHub issue\n   - Create PR for work item\n   - Verify both links appear in Kanban\n   - Test link navigation\n   - Test accessibility with screen reader\n2. **Automated tests** (optional):\n   - Component unit tests\n   - Integration tests for PR URL storage\n\n**Total estimated time**: 2.5-3 hours\n\n### Testing Considerations\n\n**Backend Tests**:\n```typescript\ndescribe('GitHubPRService', () =\u003e {\n  it('should save PR URL to work item after creation', async () =\u003e {\n    const pr = await service.createPR(workItemId, branch, title);\n    const workItem = await repo.findById(workItemId);\n    expect(workItem.githubPrUrl).toBe(pr.html_url);\n    expect(workItem.githubPrNumber).toBe(pr.number);\n  });\n});\n```\n\n**Frontend Tests**:\n```typescript\ndescribe('GitHubLinks', () =\u003e {\n  it('renders issue link when issue URL provided', () =\u003e {\n    render(\u003cGitHubLinks issueNumber={123} issueUrl=\"...\" /\u003e);\n    const link = screen.getByRole('link', { name: /Issue #123/i });\n    expect(link).toHaveAttribute('target', '_blank');\n    expect(link).toHaveAttribute('rel', 'noopener noreferrer');\n  });\n\n  it('does not render when no URLs provided', () =\u003e {\n    const { container } = render(\u003cGitHubLinks /\u003e);\n    expect(container.firstChild).toBeNull();\n  });\n\n  it('stops event propagation on click', () =\u003e {\n    const onClick = jest.fn();\n    render(\n      \u003cdiv onClick={onClick}\u003e\n        \u003cGitHubLinks issueNumber={123} issueUrl=\"...\" /\u003e\n      \u003c/div\u003e\n    );\n    fireEvent.click(screen.getByRole('link'));\n    expect(onClick).not.toHaveBeenCalled();\n  });\n});\n```\n\n**Integration Test Flow**:\n1. Create work item\n2. Sync with GitHub issue\n3. Create PR for work item\n4. Fetch work item via API\n5. Verify both issue and PR URLs in response\n6. Render Kanban board\n7. Verify links display correctly\n\n### Potential Gotchas\n\n1. **Mock Data**: Kanban currently uses mock data - must connect to real API\n2. **PR-to-WorkItem Mapping**: Verify PR service knows which work item to update\n3. **API Response Format**: Ensure API returns GitHub fields in work item objects\n4. **Event Propagation**: Links must stop propagation to prevent card interactions\n5. **Null Handling**: Component must gracefully handle missing GitHub URLs\n6. **Migration Conflicts**: Check if migration number conflicts with existing migrations\n\n### Success Metrics\n\n**Functional Requirements**:\n- ✅ GitHub issue links appear on work items\n- ✅ GitHub PR links appear on work items\n- ✅ Links open in new tabs\n- ✅ Links use proper security attributes\n- ✅ No console errors or warnings\n\n**Non-Functional Requirements**:\n- ✅ WCAG 2.2 AA compliance (accessibility)\n- ✅ Consistent with existing UI patterns\n- ✅ No performance degradation\n- ✅ Works on all modern browsers\n- ✅ Responsive design (mobile/tablet)\n\n## 6. Alternative Approaches Considered\n\n### Alternative 1: State-Aware Links (with colors)\n**Description**: Display issue/PR state (open/closed/merged) with GitHub Primer colors\n\n**Pros**:\n- More informative\n- Visually rich\n- Matches GitHub's UI\n\n**Cons**:\n- Requires fetching state from GitHub API\n- Adds API call overhead\n- More complex implementation\n- State may become stale\n\n**Decision**: Defer to future enhancement - start with simple links first\n\n### Alternative 2: Inline GitHub Data\n**Description**: Embed GitHub issue/PR title and metadata\n\n**Pros**:\n- No need to navigate to GitHub for basic info\n- Richer user experience\n\n**Cons**:\n- Requires periodic sync\n- Increases data complexity\n- May clutter UI\n\n**Decision**: Out of scope - links provide sufficient value\n\n### Alternative 3: Badge/Pill Design\n**Description**: Display links as colored badges instead of inline text\n\n**Pros**:\n- More prominent\n- Better visual hierarchy\n\n**Cons**:\n- Takes more space\n- May be visually overwhelming with many badges\n\n**Decision**: Use inline links - cleaner and more subtle\n\n## 7. References\n\n### Web Research Sources\n- [Smart Interface Design Patterns - Links UX](https://smart-interface-design-patterns.com/articles/links-ux/)\n- [W3C - ARIA8: Using aria-label](https://www.w3.org/WAI/WCAG21/Techniques/aria/ARIA8.html)\n- [MDN - ARIA aria-label](https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA/Attributes/aria-label)\n- [GitHub Primer Design System - Color](https://primer.style/design/foundations/color/)\n- [GitHub Blog - Issue Status Icons Update](https://github.blog/changelog/2021-10-26-updates-to-our-issue-status-icons-and-colors/)\n- [Lucide Icons Documentation](https://lucide.dev/)\n\n### Codebase Files Analyzed\n- `backend/src/shared/db/schema.ts` (lines 97-100)\n- `backend/src/features/work-items/models/work-item.ts`\n- `backend/src/features/pull-requests/services/github-pr.service.ts` (line 86)\n- `backend/src/features/github/services/github-sync.service.ts` (lines 45-60)\n- `frontend/src/pages/Kanban.tsx` (lines 145-186)\n- `frontend/src/pages/Dashboard.tsx` (lines 102-147)\n- `frontend/src/types/dashboard.ts` (lines 72-84)\n- `frontend/src/lib/api.ts`\n\n### Design System References\n- GitHub Primer Colors: Official color tokens for issue/PR states\n- lucide-react: Icon library for Github, ExternalLink, GitPullRequest icons\n- WCAG 2.2: Accessibility standards for links and labels\n\n---\n\n**Research completed**: 2025-12-24\n**Ready for planning phase**: Yes\n**Blockers**: None identified\n","created_at":"2025-12-25T00:00:55Z"}]}
{"id":"agent-ops-kpr.4","title":"Repo connection UI","description":"UI to connect GitHub repos: OAuth flow trigger, repo selection, sync configuration. Simple settings panel.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-23T20:18:21.354171-06:00","updated_at":"2025-12-24T14:45:29.930084-06:00","labels":["github","ui"],"dependencies":[{"issue_id":"agent-ops-kpr.4","depends_on_id":"agent-ops-kpr","type":"parent-child","created_at":"2025-12-23T20:18:21.355607-06:00","created_by":"daemon"}]}
{"id":"agent-ops-ll0","title":"Phase 3: API Routes","description":"Implement REST API endpoints and WebSocket hub for work items, templates, workers, metrics, and real-time events.","status":"open","priority":0,"issue_type":"epic","created_at":"2025-12-20T22:43:58.886066-06:00","updated_at":"2025-12-20T22:43:58.886066-06:00","labels":["api","backend"],"dependencies":[{"issue_id":"agent-ops-ll0","depends_on_id":"agent-ops-7vk","type":"blocks","created_at":"2025-12-20T22:47:28.345579-06:00","created_by":"daemon"}]}
{"id":"agent-ops-ll0.1","title":"Implement Work Items routes","description":"Create src/routes/work-items.routes.ts with REST endpoints: POST/GET/PATCH/DELETE /api/work-items, POST transition, POST assign.\n\n## Acceptance Criteria\n- [ ] POST /api/work-items returns 201 with created work item\n- [ ] POST /api/work-items returns 400 for invalid input  \n- [ ] GET /api/work-items returns 200 with array of work items\n- [ ] GET /api/work-items filters by status and type query params\n- [ ] GET /api/work-items/:id returns 200 with work item\n- [ ] GET /api/work-items/:id returns 404 for non-existent id\n- [ ] PATCH /api/work-items/:id returns 200 with updated work item\n- [ ] PATCH /api/work-items/:id returns 404 for non-existent id\n- [ ] DELETE /api/work-items/:id returns 204 on success\n- [ ] DELETE /api/work-items/:id returns 404 for non-existent id\n- [ ] DELETE /api/work-items/:id returns 400 when item has children\n- [ ] POST /api/work-items/:id/transition returns 200 with new status\n- [ ] POST /api/work-items/:id/transition returns 409 for invalid transition\n- [ ] POST /api/work-items/:id/assign returns 200 with assigned agent\n- [ ] POST /api/work-items/:id/success-criteria returns 200 with new criterion\n- [ ] All endpoints use Zod validation\n- [ ] ES module imports use .js extensions\n- [ ] All tests pass (npm test)\n\n## Implementation Plan\nSee rpi/001-work-items-routes/plan.md for detailed TDD implementation plan.","notes":"## Implementation Summary\n\nCreated `backend/src/routes/work-items.routes.ts` with 8 REST endpoints using Fastify plugin pattern.\n\n### Endpoints Implemented\n- `POST /api/work-items` - Create (201, 400)\n- `GET /api/work-items` - List with ?status/type filters (200)\n- `GET /api/work-items/:id` - Get by ID (200, 404)\n- `PATCH /api/work-items/:id` - Update (200, 404)\n- `DELETE /api/work-items/:id` - Delete (204, 400, 404)\n- `POST /api/work-items/:id/transition` - State machine (200, 400, 404, 409)\n- `POST /api/work-items/:id/assign` - Agent assignment (200, 400, 404)\n- `POST /api/work-items/:id/success-criteria` - Add criterion (200, 400, 404)\n\n### Key Patterns Established\n1. **Route Plugin Pattern**: Service injection via `WorkItemRoutesOptions`\n2. **Validation**: Zod schemas with 400 error responses\n3. **Error Handling**: Mapped service errors to HTTP status codes (404, 409)\n4. **Testing**: Integration tests using `app.inject()` with in-memory SQLite\n\n### Files Created/Modified\n- `backend/src/routes/work-items.routes.ts` (8.5KB) - Route handlers\n- `backend/src/routes/work-items.routes.test.ts` (17.9KB) - 30 tests\n- `backend/src/app.ts` - Added DB injection \u0026 route registration\n- `backend/src/index.ts` - Passes database to buildApp()\n\n### Verification\n- 610 tests passing\n- TypeScript compiles\n- All acceptance criteria met","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-20T22:45:32.595638-06:00","updated_at":"2025-12-23T19:46:28.772635-06:00","closed_at":"2025-12-23T19:46:28.772635-06:00","close_reason":"Closed","labels":["api","backend"],"dependencies":[{"issue_id":"agent-ops-ll0.1","depends_on_id":"agent-ops-ll0","type":"parent-child","created_at":"2025-12-20T22:45:32.596204-06:00","created_by":"daemon"}]}
{"id":"agent-ops-ll0.2","title":"Implement Templates routes","description":"Create src/routes/templates.routes.ts with REST endpoints: GET/POST/PATCH/DELETE /api/templates.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-20T22:45:33.52594-06:00","updated_at":"2025-12-23T20:18:53.952008-06:00","labels":["api","backend"],"dependencies":[{"issue_id":"agent-ops-ll0.2","depends_on_id":"agent-ops-ll0","type":"parent-child","created_at":"2025-12-20T22:45:33.530596-06:00","created_by":"daemon"}]}
{"id":"agent-ops-ll0.3","title":"Implement Workers routes","description":"Create src/routes/workers.routes.ts with REST endpoints: GET /api/workers, POST pause/resume/terminate/inject.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-20T22:45:35.547777-06:00","updated_at":"2025-12-23T20:18:54.258561-06:00","labels":["api","backend"],"dependencies":[{"issue_id":"agent-ops-ll0.3","depends_on_id":"agent-ops-ll0","type":"parent-child","created_at":"2025-12-20T22:45:35.550471-06:00","created_by":"daemon"}]}
{"id":"agent-ops-ll0.4","title":"Implement Metrics routes","description":"Create src/routes/metrics.routes.ts with endpoints: GET /api/metrics/agents, /api/metrics/work, /api/metrics/system, /api/traces.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:45:36.621931-06:00","updated_at":"2025-12-23T20:18:54.573535-06:00","labels":["api","backend"],"dependencies":[{"issue_id":"agent-ops-ll0.4","depends_on_id":"agent-ops-ll0","type":"parent-child","created_at":"2025-12-20T22:45:36.625312-06:00","created_by":"daemon"}]}
{"id":"agent-ops-ll0.5","title":"Implement Config routes","description":"Create src/routes/config.routes.ts with endpoints: GET/PATCH /api/config/workflow, GET/PATCH /api/config/pool.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:45:37.906312-06:00","updated_at":"2025-12-23T20:18:54.873868-06:00","labels":["api","backend"],"dependencies":[{"issue_id":"agent-ops-ll0.5","depends_on_id":"agent-ops-ll0","type":"parent-child","created_at":"2025-12-20T22:45:37.908739-06:00","created_by":"daemon"}]}
{"id":"agent-ops-ll0.6","title":"Implement WebSocket routes","description":"Create src/routes/ws.routes.ts for WebSocket connections handling ServerEvents and ClientCommands as specified in design doc.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-20T22:45:39.305161-06:00","updated_at":"2025-12-23T20:18:55.180025-06:00","labels":["api","backend","websocket"],"dependencies":[{"issue_id":"agent-ops-ll0.6","depends_on_id":"agent-ops-ll0","type":"parent-child","created_at":"2025-12-20T22:45:39.308028-06:00","created_by":"daemon"}]}
{"id":"agent-ops-tlv","title":"Phase 6: Polish","description":"Add unit and integration tests, Docker configuration, and documentation for production readiness.","status":"open","priority":3,"issue_type":"epic","created_at":"2025-12-20T22:44:02.485346-06:00","updated_at":"2025-12-23T20:18:57.121511-06:00","labels":["devops","testing"],"dependencies":[{"issue_id":"agent-ops-tlv","depends_on_id":"agent-ops-4yu","type":"blocks","created_at":"2025-12-20T22:47:29.003719-06:00","created_by":"daemon"}]}
{"id":"agent-ops-tlv.1","title":"Add backend unit tests","description":"Create unit tests for all services, repositories, and utility functions using Vitest.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:47:13.236481-06:00","updated_at":"2025-12-23T20:18:57.431055-06:00","labels":["backend","testing"],"dependencies":[{"issue_id":"agent-ops-tlv.1","depends_on_id":"agent-ops-tlv","type":"parent-child","created_at":"2025-12-20T22:47:13.239878-06:00","created_by":"daemon"}]}
{"id":"agent-ops-tlv.2","title":"Add backend integration tests","description":"Create integration tests for API endpoints using Fastify inject and test database.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:47:14.652367-06:00","updated_at":"2025-12-23T20:18:57.731262-06:00","labels":["backend","testing"],"dependencies":[{"issue_id":"agent-ops-tlv.2","depends_on_id":"agent-ops-tlv","type":"parent-child","created_at":"2025-12-20T22:47:14.655291-06:00","created_by":"daemon"}]}
{"id":"agent-ops-tlv.3","title":"Add frontend component tests","description":"Create component tests for key UI components using Vitest and React Testing Library.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:47:15.710388-06:00","updated_at":"2025-12-23T20:18:58.024913-06:00","labels":["frontend","testing"],"dependencies":[{"issue_id":"agent-ops-tlv.3","depends_on_id":"agent-ops-tlv","type":"parent-child","created_at":"2025-12-20T22:47:15.712877-06:00","created_by":"daemon"}]}
{"id":"agent-ops-tlv.4","title":"Create Docker configuration","description":"Create Dockerfile for backend and frontend, docker-compose.yml for local development with all services.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:47:16.99926-06:00","updated_at":"2025-12-23T20:18:58.334082-06:00","labels":["devops","docker"],"dependencies":[{"issue_id":"agent-ops-tlv.4","depends_on_id":"agent-ops-tlv","type":"parent-child","created_at":"2025-12-20T22:47:17.003535-06:00","created_by":"daemon"}]}
{"id":"agent-ops-tlv.5","title":"Add environment configuration","description":"Create .env.example files, document all environment variables, add validation on startup.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:47:18.153572-06:00","updated_at":"2025-12-23T20:18:58.680171-06:00","labels":["config","devops"],"dependencies":[{"issue_id":"agent-ops-tlv.5","depends_on_id":"agent-ops-tlv","type":"parent-child","created_at":"2025-12-20T22:47:18.156802-06:00","created_by":"daemon"}]}
{"id":"agent-ops-tlv.6","title":"Write README documentation","description":"Document setup instructions, architecture overview, API reference, and development workflow in README.md.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T22:47:19.462706-06:00","updated_at":"2025-12-23T20:18:59.047351-06:00","labels":["docs"],"dependencies":[{"issue_id":"agent-ops-tlv.6","depends_on_id":"agent-ops-tlv","type":"parent-child","created_at":"2025-12-20T22:47:19.465957-06:00","created_by":"daemon"}]}
{"id":"agent-ops-ug9","title":"Refactor to Vertical Slice Architecture","description":"Reorganize backend from layer-based architecture (routes/, services/, repositories/, models/) to feature-based vertical slices. Each feature should contain its own handlers, services, models, and tests in one place.\n\n**Current Structure:**\n- routes/ (10 files)\n- services/ (27 files)\n- repositories/ (14 files)\n- models/ (5 files)\n\n**Target Structure:**\n- features/\n  - agent-runtime/\n    - agent-runtime.handler.ts\n    - agent-runtime.service.ts\n    - agent-runtime.repository.ts\n    - agent-runtime.test.ts\n  - work-items/\n  - github-webhooks/\n  - pull-requests/\n  - concurrency/\n  - repositories/\n  - ...\n- shared/ (cross-cutting: db, telemetry, config)\n\n**Benefits:**\n- Related code together - easier to understand features\n- Easier to modify and delete features\n- Better encapsulation and boundaries\n- Reduced coupling between features","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-24T07:57:46.347393-06:00","updated_at":"2025-12-24T11:01:01.400413-06:00","closed_at":"2025-12-24T11:01:01.400413-06:00","close_reason":"Closed"}
{"id":"agent-ops-ug9.1","title":"Slice: agent-runtime feature","description":"Move agent runtime files into features/agent-runtime/:\n- routes/agent-runtime.routes.ts → handler\n- services/agent-executor.service.ts\n- services/agent-lifecycle.service.ts  \n- services/agent-output-collector.service.ts\n- repositories/agent-execution.repository.ts\n- All related tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T08:03:27.79535-06:00","updated_at":"2025-12-24T08:31:49.391353-06:00","closed_at":"2025-12-24T08:31:49.391353-06:00","close_reason":"Closed","dependencies":[{"issue_id":"agent-ops-ug9.1","depends_on_id":"agent-ops-ug9","type":"parent-child","created_at":"2025-12-24T08:03:27.798596-06:00","created_by":"daemon"}]}
{"id":"agent-ops-ug9.10","title":"Slice: orchestration feature","description":"Move orchestration files into features/orchestration/:\n- services/orchestration.service.ts\n- services/workflow-engine.service.ts\n- All related tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T08:04:01.129756-06:00","updated_at":"2025-12-24T10:09:58.075206-06:00","closed_at":"2025-12-24T10:09:58.075206-06:00","close_reason":"Closed","dependencies":[{"issue_id":"agent-ops-ug9.10","depends_on_id":"agent-ops-ug9","type":"parent-child","created_at":"2025-12-24T08:04:01.132569-06:00","created_by":"daemon"}]}
{"id":"agent-ops-ug9.11","title":"Extract shared infrastructure","description":"Move cross-cutting concerns into shared/:\n- db/ → shared/db/\n- config.ts → shared/config.ts\n- telemetry.ts → shared/telemetry.ts\n- services/observability.service.ts → shared/observability/\n- services/websocket-hub.service.ts → shared/websocket/\n- services/git-operations.service.ts → shared/git/\n- models/trace.ts → shared/telemetry/\n\nUpdate all imports across features.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T08:04:04.159849-06:00","updated_at":"2025-12-24T10:23:34.285764-06:00","closed_at":"2025-12-24T10:23:34.285764-06:00","close_reason":"Closed","dependencies":[{"issue_id":"agent-ops-ug9.11","depends_on_id":"agent-ops-ug9","type":"parent-child","created_at":"2025-12-24T08:04:04.163238-06:00","created_by":"daemon"}]}
{"id":"agent-ops-ug9.12","title":"Clean up old layer directories","description":"After all slices are migrated:\n- Remove empty routes/, services/, repositories/, models/ directories\n- Update app.ts to import from features/\n- Update any remaining imports\n- Run full test suite to verify","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T08:04:12.582571-06:00","updated_at":"2025-12-24T10:29:13.601837-06:00","closed_at":"2025-12-24T10:29:13.601837-06:00","close_reason":"Closed","dependencies":[{"issue_id":"agent-ops-ug9.12","depends_on_id":"agent-ops-ug9","type":"parent-child","created_at":"2025-12-24T08:04:12.585583-06:00","created_by":"daemon"}]}
{"id":"agent-ops-ug9.2","title":"Slice: work-items feature","description":"Move work items files into features/work-items/:\n- routes/work-items.routes.ts → handler\n- services/work-item.service.ts\n- repositories/work-item.repository.ts\n- models/work-item.ts\n- All related tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T08:03:29.86281-06:00","updated_at":"2025-12-24T08:45:46.060747-06:00","closed_at":"2025-12-24T08:45:46.060747-06:00","close_reason":"Closed","dependencies":[{"issue_id":"agent-ops-ug9.2","depends_on_id":"agent-ops-ug9","type":"parent-child","created_at":"2025-12-24T08:03:29.86592-06:00","created_by":"daemon"}]}
{"id":"agent-ops-ug9.3","title":"Slice: github-integration feature","description":"Move GitHub integration files into features/github/:\n- routes/github-auth.routes.ts → handler\n- routes/github-webhook.routes.ts → handler\n- services/github.service.ts\n- services/github-webhook.service.ts\n- services/github-sync.service.ts\n- repositories/github-connection.repository.ts\n- All related tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T08:03:32.811491-06:00","updated_at":"2025-12-24T09:12:49.79525-06:00","closed_at":"2025-12-24T09:12:49.79525-06:00","close_reason":"Closed","dependencies":[{"issue_id":"agent-ops-ug9.3","depends_on_id":"agent-ops-ug9","type":"parent-child","created_at":"2025-12-24T08:03:32.814041-06:00","created_by":"daemon"}]}
{"id":"agent-ops-ug9.4","title":"Slice: pull-requests feature","description":"Move pull requests files into features/pull-requests/:\n- routes/pull-requests.routes.ts → handler\n- services/github-pr.service.ts\n- All related tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T08:03:34.773565-06:00","updated_at":"2025-12-24T09:23:51.005108-06:00","closed_at":"2025-12-24T09:23:51.005108-06:00","close_reason":"Closed","dependencies":[{"issue_id":"agent-ops-ug9.4","depends_on_id":"agent-ops-ug9","type":"parent-child","created_at":"2025-12-24T08:03:34.777103-06:00","created_by":"daemon"}]}
{"id":"agent-ops-ug9.5","title":"Slice: concurrency feature","description":"Move concurrency files into features/concurrency/:\n- routes/concurrency.routes.ts → handler\n- All related tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T08:03:36.682741-06:00","updated_at":"2025-12-24T09:28:43.741045-06:00","closed_at":"2025-12-24T09:28:43.741045-06:00","close_reason":"Closed","dependencies":[{"issue_id":"agent-ops-ug9.5","depends_on_id":"agent-ops-ug9","type":"parent-child","created_at":"2025-12-24T08:03:36.685942-06:00","created_by":"daemon"}]}
{"id":"agent-ops-ug9.6","title":"Slice: repositories feature","description":"Move repository management files into features/repositories/:\n- routes/repositories.routes.ts → handler\n- repositories/repository.repository.ts\n- All related tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T08:03:38.805274-06:00","updated_at":"2025-12-24T09:36:54.19439-06:00","closed_at":"2025-12-24T09:36:54.19439-06:00","close_reason":"Closed","dependencies":[{"issue_id":"agent-ops-ug9.6","depends_on_id":"agent-ops-ug9","type":"parent-child","created_at":"2025-12-24T08:03:38.80839-06:00","created_by":"daemon"}]}
{"id":"agent-ops-ug9.7","title":"Slice: templates feature","description":"Move template files into features/templates/:\n- services/template-registry.service.ts\n- repositories/template.repository.ts\n- models/template.ts\n- All related tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T08:03:55.925539-06:00","updated_at":"2025-12-24T09:43:19.433498-06:00","closed_at":"2025-12-24T09:43:19.433498-06:00","close_reason":"Closed","dependencies":[{"issue_id":"agent-ops-ug9.7","depends_on_id":"agent-ops-ug9","type":"parent-child","created_at":"2025-12-24T08:03:55.927191-06:00","created_by":"daemon"}]}
{"id":"agent-ops-ug9.8","title":"Slice: workers feature","description":"Move worker pool files into features/workers/:\n- services/worker-pool.service.ts\n- repositories/worker.repository.ts\n- models/worker.ts\n- All related tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T08:03:57.756719-06:00","updated_at":"2025-12-24T09:55:33.217821-06:00","closed_at":"2025-12-24T09:55:33.217821-06:00","close_reason":"Closed","dependencies":[{"issue_id":"agent-ops-ug9.8","depends_on_id":"agent-ops-ug9","type":"parent-child","created_at":"2025-12-24T08:03:57.759411-06:00","created_by":"daemon"}]}
{"id":"agent-ops-ug9.9","title":"Slice: workspaces feature","description":"Move workspace files into features/workspaces/:\n- services/workspace-manager.service.ts\n- repositories/workspace.repository.ts\n- All related tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T08:03:59.577803-06:00","updated_at":"2025-12-24T10:00:29.811555-06:00","closed_at":"2025-12-24T10:00:29.811555-06:00","close_reason":"Closed","dependencies":[{"issue_id":"agent-ops-ug9.9","depends_on_id":"agent-ops-ug9","type":"parent-child","created_at":"2025-12-24T08:03:59.578874-06:00","created_by":"daemon"}]}
{"id":"agent-ops-zi0","title":"Phase 1: GitHub Integration","description":"Connect to GitHub repos, sync issues as work items, and create PRs from agent work. This is the foundation for the agent-driven development loop.","status":"closed","priority":0,"issue_type":"epic","created_at":"2025-12-23T20:16:14.260233-06:00","updated_at":"2025-12-23T22:26:55.769697-06:00","closed_at":"2025-12-23T22:26:55.769697-06:00","close_reason":"Closed","labels":["github","integration"]}
{"id":"agent-ops-zi0.1","title":"GitHub OAuth flow","description":"Implement GitHub OAuth for user authentication and repo access. Store tokens securely. Support both personal and organization repos.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-23T20:16:29.448101-06:00","updated_at":"2025-12-23T22:16:36.413059-06:00","closed_at":"2025-12-23T22:16:36.413059-06:00","close_reason":"Closed","labels":["auth","github"],"dependencies":[{"issue_id":"agent-ops-zi0.1","depends_on_id":"agent-ops-zi0","type":"parent-child","created_at":"2025-12-23T20:16:29.451603-06:00","created_by":"daemon"}]}
{"id":"agent-ops-zi0.2","title":"Repository connection model","description":"Create Zod schema and Drizzle model for connected repositories. Track: repo URL, owner, name, default branch, access token reference, sync status.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-23T20:16:31.504158-06:00","updated_at":"2025-12-23T22:22:06.107364-06:00","closed_at":"2025-12-23T22:22:06.107364-06:00","close_reason":"Closed","labels":["github","models"],"dependencies":[{"issue_id":"agent-ops-zi0.2","depends_on_id":"agent-ops-zi0","type":"parent-child","created_at":"2025-12-23T20:16:31.506669-06:00","created_by":"daemon"}]}
{"id":"agent-ops-zi0.3","title":"GitHub Issues sync","description":"Sync GitHub Issues to internal WorkItems. Support: initial import, webhook updates, bi-directional status sync. Map labels/assignees appropriately.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-23T20:16:33.607277-06:00","updated_at":"2025-12-23T22:24:27.875243-06:00","closed_at":"2025-12-23T22:24:27.875243-06:00","close_reason":"Closed","labels":["github","sync"],"dependencies":[{"issue_id":"agent-ops-zi0.3","depends_on_id":"agent-ops-zi0","type":"parent-child","created_at":"2025-12-23T20:16:33.608248-06:00","created_by":"daemon"}]}
{"id":"agent-ops-zi0.4","title":"Pull Request creation","description":"Create PRs from agent work. Include: branch creation, commit attribution, PR description with context, link back to originating issue.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-23T20:16:35.813673-06:00","updated_at":"2025-12-23T22:26:54.615441-06:00","closed_at":"2025-12-23T22:26:54.615441-06:00","close_reason":"Closed","labels":["github","pr"],"dependencies":[{"issue_id":"agent-ops-zi0.4","depends_on_id":"agent-ops-zi0","type":"parent-child","created_at":"2025-12-23T20:16:35.815205-06:00","created_by":"daemon"}]}
{"id":"agent-ops-zi0.5","title":"GitHub webhooks handler","description":"Handle GitHub webhooks for real-time updates: issue created/updated/closed, PR merged/closed, comments. Verify webhook signatures.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T20:16:38.59567-06:00","updated_at":"2025-12-24T07:24:53.989731-06:00","closed_at":"2025-12-24T07:24:53.989731-06:00","close_reason":"Closed","labels":["github","webhooks"],"dependencies":[{"issue_id":"agent-ops-zi0.5","depends_on_id":"agent-ops-zi0","type":"parent-child","created_at":"2025-12-23T20:16:38.597795-06:00","created_by":"daemon"}]}
